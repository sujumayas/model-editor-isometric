var ft=Object.defineProperty;var gt=(r,e,t)=>e in r?ft(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var l=(r,e,t)=>gt(r,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const G=32,z=32,k=32,C=16,Je=8,Xe=8,yt="isometric tileset/spritesheet.png",oe=115,vt=[{id:"terrain",name:"Terrain",zIndex:0},{id:"props",name:"Props",zIndex:10},{id:"decorations",name:"Decorations",zIndex:20}],Ee="rgba(255, 255, 255, 0.1)",_t="rgba(74, 255, 158, 0.5)",xt="rgba(74, 158, 255, 0.3)";function bt(r){return new Promise((e,t)=>{const s=new Image;s.onload=()=>e(s),s.onerror=()=>t(new Error(`Failed to load image: ${r}`)),s.src=r})}async function wt(r){return bt(r)}const Le=11,Pe=[{id:"dirt",name:"Dirt/Soil",startId:0,endId:19},{id:"grass-transition",name:"Grass Transition",startId:20,endId:28},{id:"vegetation",name:"Vegetation",startId:29,endId:39},{id:"props",name:"Props",startId:40,endId:59},{id:"rocks-brown",name:"Brown Rocks",startId:60,endId:66},{id:"rocks-gray",name:"Gray Rocks",startId:67,endId:81},{id:"ice",name:"Ice/Snow",startId:82,endId:89},{id:"water-deep",name:"Deep Water",startId:90,endId:99},{id:"water-shallow",name:"Shallow Water",startId:100,endId:114}];class Ct{constructor(){l(this,"spritesheet",null);l(this,"uvCache",new Map);l(this,"_isReady",!1)}async initialize(){this.spritesheet=await wt(yt),this.buildUVCache(),this._isReady=!0}get isReady(){return this._isReady}getSpritesheet(){if(!this.spritesheet)throw new Error("TileRegistry not initialized. Call initialize() first.");return this.spritesheet}getTileUV(e){const t=this.uvCache.get(e);if(!t)throw new Error(`Invalid tile ID: ${e}`);return t}isValidTileId(e){return e>=0&&e<oe}getTileCount(){return oe}getAllTileIds(){return Array.from({length:oe},(e,t)=>t)}getTilesByCategory(e){const t=Pe.find(i=>i.id===e);if(!t)return[];const s=[];for(let i=t.startId;i<=t.endId;i++)s.push(i);return s}getCategoryForTile(e){return Pe.find(t=>e>=t.startId&&e<=t.endId)}buildUVCache(){for(let e=0;e<oe;e++){const t=e%Le,s=Math.floor(e/Le);this.uvCache.set(e,{x:t*G,y:s*z,width:G,height:z})}}drawTile(e,t,s,i,n=1){if(!this.spritesheet)throw new Error("TileRegistry not initialized");const a=this.getTileUV(t),o=G*n,d=z*n;e.drawImage(this.spritesheet,a.x,a.y,a.width,a.height,s,i,o,d)}createTilePreview(e,t=1){const s=document.createElement("canvas");s.width=G*t,s.height=z*t;const i=s.getContext("2d");return i&&(i.imageSmoothingEnabled=!1,this.drawTile(i,e,0,0,t)),s}}const Tt={north:{x:0,y:-1},east:{x:1,y:0},south:{x:0,y:1},west:{x:-1,y:0}};function P(r){return`${r.x},${r.y}`}function V(r){const[e,t]=r.split(",").map(Number);return{x:e,y:t}}class se{constructor(e){l(this,"config");l(this,"tiles",new Map);this.config={visible:!0,locked:!1,opacity:1,...e}}getTile(e){const t=P(e);return this.tiles.get(t)??null}setTile(e,t){const s=P(e);this.tiles.set(s,t)}removeTile(e){const t=P(e);return this.tiles.delete(t)}hasTile(e){const t=P(e);return this.tiles.has(t)}get tileCount(){return this.tiles.size}clear(){this.tiles.clear()}forEachTile(e){this.tiles.forEach((t,s)=>{const i=V(s);e(t,i)})}getAllTiles(){const e=[];return this.forEachTile((t,s)=>{e.push({tile:t,coord:s})}),e}setVisible(e){this.config.visible=e}toggleVisible(){this.config.visible=!this.config.visible}setLocked(e){this.config.locked=e}setOpacity(e){this.config.opacity=Math.max(0,Math.min(1,e))}clone(){const e=new se({...this.config});return this.tiles.forEach((t,s)=>{e.tiles.set(s,{...t})}),e}toData(){const e=[];return this.forEachTile((t,s)=>{e.push({tileId:t.tileId,position:s,rotation:t.rotation})}),{id:this.config.id,name:this.config.name,zIndex:this.config.zIndex,visible:this.config.visible,tiles:e}}static fromData(e){const t=new se({id:e.id,name:e.name,zIndex:e.zIndex,visible:e.visible});for(const s of e.tiles)t.setTile(s.position,{tileId:s.tileId,rotation:s.rotation});return t}}class H{constructor(e={},t={}){l(this,"metadata");l(this,"gridConfig");l(this,"layers",[]);l(this,"layerMap",new Map);l(this,"gameplayTiles",new Map);this.metadata={id:e.id??crypto.randomUUID(),name:e.name??"Untitled Level",author:e.author,created:e.created??new Date().toISOString(),modified:e.modified??new Date().toISOString(),version:e.version??1},this.gridConfig={width:t.width??Je,height:t.height??Xe,tileWidth:t.tileWidth??G,tileHeight:t.tileHeight??z}}get gridWidth(){return this.gridConfig.width}get gridHeight(){return this.gridConfig.height}getLayers(){return this.layers}getVisibleLayers(){return this.layers.filter(e=>e.config.visible).sort((e,t)=>e.config.zIndex-t.config.zIndex)}getLayer(e){return this.layerMap.get(e)}getLayerByIndex(e){return this.layers[e]}addLayer(e){if(this.layerMap.has(e.config.id))throw new Error(`Layer with id "${e.config.id}" already exists`);this.layers.push(e),this.layerMap.set(e.config.id,e),this.sortLayers()}removeLayer(e){const t=this.layers.findIndex(s=>s.config.id===e);return t===-1?!1:(this.layers.splice(t,1),this.layerMap.delete(e),!0)}sortLayers(){this.layers.sort((e,t)=>e.config.zIndex-t.config.zIndex)}isInBounds(e){return e.x>=0&&e.x<this.gridConfig.width&&e.y>=0&&e.y<this.gridConfig.height}getTile(e,t){const s=this.layerMap.get(e);return s?s.getTile(t):null}setTile(e,t,s){if(!this.isInBounds(t))return!1;const i=this.layerMap.get(e);return!i||i.config.locked?!1:(i.setTile(t,s),!0)}removeTile(e,t){const s=this.layerMap.get(e);return!s||s.config.locked?!1:s.removeTile(t)}getTopTileAt(e){const t=this.getVisibleLayers().reverse();for(const s of t){const i=s.getTile(e);if(i)return{tile:i,layerId:s.config.id}}return null}getGameplayTile(e){if(this.isInBounds(e))return this.gameplayTiles.get(P(e))}setGameplayTile(e,t){if(!this.isInBounds(e))return!1;const s=P(e);return!t||t.type==="floor"?this.gameplayTiles.delete(s):this.gameplayTiles.set(s,t),!0}removeGameplayTile(e){return this.isInBounds(e)?this.gameplayTiles.delete(P(e)):!1}clearGameplayTiles(){this.gameplayTiles.clear()}getAllGameplayTiles(){const e=[];for(const[t,s]of this.gameplayTiles)e.push({coord:V(t),properties:s});return e}findGameplayTilesByType(e){const t=[];for(const[s,i]of this.gameplayTiles)i.type===e&&t.push(V(s));return t}findSpawnTile(){return this.findGameplayTilesByType("spawn")[0]??null}findExitTile(){return this.findGameplayTilesByType("exit")[0]??null}touch(){this.metadata.modified=new Date().toISOString()}toData(){const e=[];for(const[t,s]of this.gameplayTiles)e.push({position:V(t),properties:s});return{version:2,metadata:{...this.metadata},grid:{...this.gridConfig},layers:this.layers.map(t=>t.toData()),gameplayLayer:e.length>0?{tiles:e}:void 0}}static fromData(e){var i;const t=new H(e.metadata,e.grid);for(const n of e.layers){const a=se.fromData(n);t.addLayer(a)}const s=e;if((i=s.gameplayLayer)!=null&&i.tiles)for(const n of s.gameplayLayer.tiles)t.setGameplayTile(n.position,n.properties);return t}static createDefault(e="Untitled Level",t={}){const s=new H({name:e},t);for(const i of vt){const n=new se({id:i.id,name:i.name,zIndex:i.zIndex});s.addLayer(n)}return s}}class Qe{constructor(e){l(this,"element");l(this,"ctx");l(this,"container");l(this,"handleDPR");l(this,"backgroundColor");l(this,"resizeObserver",null);l(this,"_viewport",{width:0,height:0});l(this,"_dpr",1);if(typeof e.canvas=="string"){const s=document.querySelector(e.canvas);if(!s)throw new Error(`Canvas not found: ${e.canvas}`);this.element=s}else this.element=e.canvas;const t=this.element.getContext("2d");if(!t)throw new Error("Failed to get 2d context");if(this.ctx=t,e.container)if(typeof e.container=="string"){const s=document.querySelector(e.container);if(!s)throw new Error(`Container not found: ${e.container}`);this.container=s}else this.container=e.container;else this.container=this.element.parentElement||document.body;this.handleDPR=e.handleDPR??!0,this.backgroundColor=e.backgroundColor??"#0f0f23",this.updateSize(),this.setupResizeObserver()}get viewport(){return this._viewport}get dpr(){return this._dpr}updateSize(){const e=this.container.getBoundingClientRect();this._dpr=this.handleDPR&&window.devicePixelRatio||1,this.element.style.width=`${e.width}px`,this.element.style.height=`${e.height}px`,this.element.width=e.width*this._dpr,this.element.height=e.height*this._dpr,this._viewport={width:e.width,height:e.height},this.handleDPR&&this.ctx.scale(this._dpr,this._dpr),this.ctx.imageSmoothingEnabled=!1}setupResizeObserver(){this.resizeObserver=new ResizeObserver(()=>{this.updateSize()}),this.resizeObserver.observe(this.container)}clear(){this.ctx.setTransform(1,0,0,1,0,0),this.handleDPR&&this.ctx.scale(this._dpr,this._dpr),this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this._viewport.width,this._viewport.height)}dispose(){var e;(e=this.resizeObserver)==null||e.disconnect(),this.resizeObserver=null}}function S(r,e,t=0,s=0){return{x:(r-e)*(k/2)+t,y:(r+e)*(C/2)+s}}function Y(r,e,t=0,s=0){const i=r-t,n=e-s,a=(i/(k/2)+n/(C/2))/2,o=(n/(C/2)-i/(k/2))/2;return{x:Math.floor(a),y:Math.floor(o)}}function et(r,e,t=0){return t*1e4+(r+e)}function St(r,e,t,s){const i=S(r,e,t,s),n=z-C;return{x:i.x-G/2,y:i.y-n}}function kt(r,e,t,s,i,n){const a=Y(0,0,t,s),o=Y(r,0,t,s),d=Y(0,e,t,s),c=Y(r,e,t,s),f=Math.max(0,Math.min(a.x,d.x)-1),b=Math.min(i-1,Math.max(o.x,c.x)+1),w=Math.max(0,Math.min(a.y,o.y)-1),L=Math.min(n-1,Math.max(d.y,c.y)+1);return{minX:f,minY:w,maxX:b,maxY:L}}function le(r,e,t,s){const i=S(0,0),n=S(t-1,0),a=S(0,s-1),o=S(t-1,s-1),d=n.x-a.x+k,c=o.y-i.y+z;return{x:(r-d)/2+(t-1)*(k/2),y:(e-c)/2+z/2}}function It(r,e){const t=[];for(let s=r.minY;s<=r.maxY;s++)for(let i=r.minX;i<=r.maxX;i++)t.push({x:i,y:s,depth:et(i,s)});t.sort((s,i)=>s.depth-i.depth);for(const s of t)e(s.x,s.y,s.depth)}class tt{constructor(e={}){l(this,"state");l(this,"minZoom");l(this,"maxZoom");l(this,"viewport",{width:0,height:0});l(this,"zoomListeners",new Set);this.state={x:e.x??0,y:e.y??0,zoom:e.zoom??1},this.minZoom=e.minZoom??.5,this.maxZoom=e.maxZoom??3}get x(){return this.state.x}get y(){return this.state.y}get zoom(){return this.state.zoom}get minZoomLevel(){return this.minZoom}get maxZoomLevel(){return this.maxZoom}setViewport(e){this.viewport=e}setPosition(e,t){this.state.x=e,this.state.y=t}pan(e,t){this.state.x+=e,this.state.y+=t}setZoom(e,t,s){const i=Math.max(this.minZoom,Math.min(this.maxZoom,e)),n=this.state.zoom;if(t!==void 0&&s!==void 0){const a=i/this.state.zoom;this.state.x=t-(t-this.state.x)*a,this.state.y=s-(s-this.state.y)*a}this.state.zoom=i,n!==i&&this.emitZoomChange()}zoomBy(e,t,s){this.setZoom(this.state.zoom*(1+e),t,s)}reset(){this.state.x=0,this.state.y=0,this.setZoom(1)}centerOn(e,t){const s=S(e,t);this.state.x=this.viewport.width/2-s.x*this.state.zoom,this.state.y=this.viewport.height/2-s.y*this.state.zoom}screenToWorld(e,t){return{x:(e-this.state.x)/this.state.zoom,y:(t-this.state.y)/this.state.zoom}}worldToScreen(e,t){return{x:e*this.state.zoom+this.state.x,y:t*this.state.zoom+this.state.y}}screenToGrid(e,t){const s=this.screenToWorld(e,t);return Y(s.x,s.y)}getVisibleBounds(e=Je,t=Xe){return kt(this.viewport.width/this.state.zoom,this.viewport.height/this.state.zoom,-this.state.x/this.state.zoom,-this.state.y/this.state.zoom,e,t)}applyTransform(e){e.translate(this.state.x,this.state.y),e.scale(this.state.zoom,this.state.zoom)}getState(){return{...this.state}}setState(e){this.state={...e},this.emitZoomChange()}onZoomChange(e){return this.zoomListeners.add(e),()=>{this.zoomListeners.delete(e)}}emitZoomChange(){for(const e of this.zoomListeners)e(this.state.zoom)}}class st{constructor(e,t,s){l(this,"canvas");l(this,"camera");l(this,"tileRegistry");l(this,"options",{showGrid:!0,showHover:!0,showSelection:!0});l(this,"hoveredCoord",null);l(this,"selectedCoords",[]);this.canvas=e,this.camera=t,this.tileRegistry=s,this.camera.setViewport(this.canvas.viewport)}setOptions(e){this.options={...this.options,...e}}setHoveredCoord(e){this.hoveredCoord=e}setSelectedCoords(e){this.selectedCoords=e}render(e){const t=this.canvas.ctx;this.camera.setViewport(this.canvas.viewport),this.canvas.clear(),t.save(),this.camera.applyTransform(t);const s=le(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,e.gridWidth,e.gridHeight),i={minX:0,minY:0,maxX:e.gridWidth-1,maxY:e.gridHeight-1};this.options.showGrid&&this.renderGrid(t,i,s.x,s.y);const n=this.collectRenderItems(e,i);n.sort((a,o)=>a.depth-o.depth);for(const a of n)this.renderTile(t,a.tileId,a.screenX,a.screenY);if(this.options.showHover&&this.hoveredCoord&&this.renderTileOverlay(t,this.hoveredCoord,s.x,s.y,xt),this.options.showSelection&&this.selectedCoords.length>0)for(const a of this.selectedCoords)this.renderTileOverlay(t,a,s.x,s.y,_t);t.restore()}collectRenderItems(e,t){const s=[],i=le(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,e.gridWidth,e.gridHeight),n=e.getVisibleLayers();for(const a of n){const o=this.getLayerYOffset(a);a.forEachTile((d,c)=>{if(c.x>=t.minX&&c.x<=t.maxX&&c.y>=t.minY&&c.y<=t.maxY){const f=St(c.x,c.y,i.x,i.y),b=et(c.x,c.y,a.config.zIndex);s.push({tileId:d.tileId,screenX:f.x,screenY:f.y-o,depth:b})}})}return s}getLayerYOffset(e){return e.config.id==="props"||e.config.id==="decorations"?C/2:0}renderTile(e,t,s,i){this.tileRegistry.drawTile(e,t,s,i)}renderGrid(e,t,s,i){e.strokeStyle=Ee,e.lineWidth=1,It(t,(n,a)=>{this.renderTileOutline(e,{x:n,y:a},s,i,Ee)})}renderTileOutline(e,t,s,i,n){const a=S(t.x,t.y,s,i);e.strokeStyle=n,e.lineWidth=1,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(a.x+k/2,a.y+C/2),e.lineTo(a.x,a.y+C),e.lineTo(a.x-k/2,a.y+C/2),e.closePath(),e.stroke()}renderTileOverlay(e,t,s,i,n){const a=S(t.x,t.y,s,i);e.fillStyle=n,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(a.x+k/2,a.y+C/2),e.lineTo(a.x,a.y+C),e.lineTo(a.x-k/2,a.y+C/2),e.closePath(),e.fill()}screenToGrid(e,t,s){const i=this.camera.screenToWorld(e,t),n=le(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,s.gridWidth,s.gridHeight);return Y(i.x,i.y,n.x,n.y)}}class Et{constructor(){l(this,"state");l(this,"listeners",new Map);this.state={activeTool:"brush",activeLayerId:null,selectedTileId:null,hoveredCoord:null,isDirty:!1}}get activeTool(){return this.state.activeTool}get activeLayerId(){return this.state.activeLayerId}get selectedTileId(){return this.state.selectedTileId}get hoveredCoord(){return this.state.hoveredCoord}get isDirty(){return this.state.isDirty}setActiveTool(e){this.state.activeTool!==e&&(this.state.activeTool=e,this.emit("tool:changed",{tool:e}))}setActiveLayer(e){this.state.activeLayerId!==e&&(this.state.activeLayerId=e,this.emit("layer:changed",{layerId:e}))}setSelectedTile(e){this.state.selectedTileId!==e&&(this.state.selectedTileId=e,this.emit("tile:selected",{tileId:e}))}setHoveredCoord(e){var s,i;(((s=this.state.hoveredCoord)==null?void 0:s.x)!==(e==null?void 0:e.x)||((i=this.state.hoveredCoord)==null?void 0:i.y)!==(e==null?void 0:e.y))&&(this.state.hoveredCoord=e,this.emit("hover:changed",{coord:e}))}setDirty(e){this.state.isDirty!==e&&(this.state.isDirty=e,this.emit("dirty:changed",{isDirty:e}))}markDirty(){this.setDirty(!0)}markClean(){this.setDirty(!1)}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;(s=this.listeners.get(e))==null||s.delete(t)}}off(e,t){var s;(s=this.listeners.get(e))==null||s.delete(t)}emit(e,t){var s;(s=this.listeners.get(e))==null||s.forEach(i=>i(t))}notifyLevelLoaded(e){this.emit("level:loaded",{level:e})}getSnapshot(){return{...this.state}}restore(e){e.activeTool!==void 0&&this.setActiveTool(e.activeTool),e.activeLayerId!==void 0&&this.setActiveLayer(e.activeLayerId),e.selectedTileId!==void 0&&this.setSelectedTile(e.selectedTileId)}}class Lt{constructor(e={}){l(this,"undoStack",[]);l(this,"redoStack",[]);l(this,"maxSize");l(this,"savePoint",0);l(this,"listeners",new Map);this.maxSize=e.maxSize??100}execute(e){for(e.execute(),this.undoStack.push(e),this.redoStack=[];this.undoStack.length>this.maxSize;)this.undoStack.shift(),this.savePoint>0&&this.savePoint--;this.emit("change")}undo(){const e=this.undoStack.pop();return e?(e.undo(),this.redoStack.push(e),this.emit("change"),!0):!1}redo(){const e=this.redoStack.pop();return e?(e.execute(),this.undoStack.push(e),this.emit("change"),!0):!1}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoDescription(){const e=this.undoStack[this.undoStack.length-1];return(e==null?void 0:e.description)??null}getRedoDescription(){const e=this.redoStack[this.redoStack.length-1];return(e==null?void 0:e.description)??null}markSaved(){this.savePoint=this.undoStack.length,this.emit("save")}isDirty(){return this.undoStack.length!==this.savePoint}clear(){this.undoStack=[],this.redoStack=[],this.savePoint=0,this.emit("change")}get undoCount(){return this.undoStack.length}get redoCount(){return this.redoStack.length}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;(s=this.listeners.get(e))==null||s.delete(t)}}off(e,t){var s;(s=this.listeners.get(e))==null||s.delete(t)}emit(e){var t;(t=this.listeners.get(e))==null||t.forEach(s=>s())}}class it{constructor(){l(this,"shortcut");l(this,"lastCoord",null);l(this,"isDrawing",!1)}onActivate(e){this.lastCoord=null,this.isDrawing=!1}onDeactivate(e){this.lastCoord=null,this.isDrawing=!1}getCursor(){return"default"}hasCoordChanged(e){return this.lastCoord?this.lastCoord.x!==e.x||this.lastCoord.y!==e.y:!0}updateLastCoord(e){this.lastCoord={...e}}}class Pt{constructor(e,t,s,i,n){l(this,"description");this.level=e,this.layerId=t,this.coord=s,this.newTile=i,this.previousTile=n,this.description=`Place tile ${i.tileId} at (${s.x}, ${s.y})`}execute(){this.level.setTile(this.layerId,this.coord,this.newTile)}undo(){this.previousTile?this.level.setTile(this.layerId,this.coord,this.previousTile):this.level.removeTile(this.layerId,this.coord)}}class Ot{constructor(e,t,s,i){l(this,"description");this.level=e,this.layerId=t,this.coord=s,this.previousTile=i,this.description=`Remove tile at (${s.x}, ${s.y})`}execute(){this.level.removeTile(this.layerId,this.coord)}undo(){this.level.setTile(this.layerId,this.coord,this.previousTile)}}class Mt{constructor(e,t){l(this,"description");this.commands=e,this.description=t??`Batch operation (${e.length} tiles)`}execute(){for(const e of this.commands)e.execute()}undo(){for(let e=this.commands.length-1;e>=0;e--)this.commands[e].undo()}}class Rt{constructor(e,t){l(this,"description");l(this,"previousTiles",[]);this.level=e,this.layerId=t,this.description=`Clear layer "${t}"`;const s=this.level.getLayer(t);s&&(this.previousTiles=s.getAllTiles().map(({tile:i,coord:n})=>({coord:n,tile:{...i}})))}execute(){const e=this.level.getLayer(this.layerId);e==null||e.clear()}undo(){for(const{coord:e,tile:t}of this.previousTiles)this.level.setTile(this.layerId,e,t)}}class Nt extends it{constructor(){super(...arguments);l(this,"type","brush");l(this,"name","Brush");l(this,"description","Place tiles on the map");l(this,"shortcut","b");l(this,"placedCoords",new Set)}onActivate(t){super.onActivate(t),this.placedCoords.clear()}onDeactivate(t){super.onDeactivate(t),this.placedCoords.clear()}onMouseDown(t,s){this.isDrawing=!0,this.placedCoords.clear(),this.placeTile(t,s)}onMouseMove(t,s,i){i&&this.isDrawing&&this.hasCoordChanged(s)&&this.placeTile(t,s),this.updateLastCoord(s)}onMouseUp(t,s){this.isDrawing=!1,this.placedCoords.clear()}getCursor(){return"crosshair"}placeTile(t,s){const{level:i,editorState:n,history:a}=t,o=n.activeLayerId,d=n.selectedTileId;if(!o||d===null||!i.isInBounds(s))return;const c=`${s.x},${s.y}`;if(this.placedCoords.has(c))return;this.placedCoords.add(c);const f=i.getTile(o,s);if((f==null?void 0:f.tileId)===d)return;const b=new Pt(i,o,s,{tileId:d},f);a.execute(b),n.markDirty()}}class Dt extends it{constructor(){super(...arguments);l(this,"type","eraser");l(this,"name","Eraser");l(this,"description","Remove tiles from the map");l(this,"shortcut","e");l(this,"erasedCoords",new Set)}onActivate(t){super.onActivate(t),this.erasedCoords.clear()}onDeactivate(t){super.onDeactivate(t),this.erasedCoords.clear()}onMouseDown(t,s){this.isDrawing=!0,this.erasedCoords.clear(),this.eraseTile(t,s)}onMouseMove(t,s,i){i&&this.isDrawing&&this.hasCoordChanged(s)&&this.eraseTile(t,s),this.updateLastCoord(s)}onMouseUp(t,s){this.isDrawing=!1,this.erasedCoords.clear()}getCursor(){return"crosshair"}eraseTile(t,s){const{level:i,editorState:n,history:a}=t,o=n.activeLayerId;if(!o||!i.isInBounds(s))return;const d=`${s.x},${s.y}`;if(this.erasedCoords.has(d))return;this.erasedCoords.add(d);const c=i.getTile(o,s);if(!c)return;const f=new Ot(i,o,s,c);a.execute(f),n.markDirty()}}var x;(function(r){r.assertEqual=i=>{};function e(i){}r.assertIs=e;function t(i){throw new Error}r.assertNever=t,r.arrayToEnum=i=>{const n={};for(const a of i)n[a]=a;return n},r.getValidEnumValues=i=>{const n=r.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),a={};for(const o of n)a[o]=i[o];return r.objectValues(a)},r.objectValues=i=>r.objectKeys(i).map(function(n){return i[n]}),r.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const n=[];for(const a in i)Object.prototype.hasOwnProperty.call(i,a)&&n.push(a);return n},r.find=(i,n)=>{for(const a of i)if(n(a))return a},r.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&Number.isFinite(i)&&Math.floor(i)===i;function s(i,n=" | "){return i.map(a=>typeof a=="string"?`'${a}'`:a).join(n)}r.joinValues=s,r.jsonStringifyReplacer=(i,n)=>typeof n=="bigint"?n.toString():n})(x||(x={}));var Oe;(function(r){r.mergeShapes=(e,t)=>({...e,...t})})(Oe||(Oe={}));const m=x.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),A=r=>{switch(typeof r){case"undefined":return m.undefined;case"string":return m.string;case"number":return Number.isNaN(r)?m.nan:m.number;case"boolean":return m.boolean;case"function":return m.function;case"bigint":return m.bigint;case"symbol":return m.symbol;case"object":return Array.isArray(r)?m.array:r===null?m.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?m.promise:typeof Map<"u"&&r instanceof Map?m.map:typeof Set<"u"&&r instanceof Set?m.set:typeof Date<"u"&&r instanceof Date?m.date:m.object;default:return m.unknown}},h=x.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class N extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=s=>{this.issues=[...this.issues,s]},this.addIssues=(s=[])=>{this.issues=[...this.issues,...s]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(n){return n.message},s={_errors:[]},i=n=>{for(const a of n.issues)if(a.code==="invalid_union")a.unionErrors.map(i);else if(a.code==="invalid_return_type")i(a.returnTypeError);else if(a.code==="invalid_arguments")i(a.argumentsError);else if(a.path.length===0)s._errors.push(t(a));else{let o=s,d=0;for(;d<a.path.length;){const c=a.path[d];d===a.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(a))):o[c]=o[c]||{_errors:[]},o=o[c],d++}}};return i(this),s}static assert(e){if(!(e instanceof N))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,x.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},s=[];for(const i of this.issues)if(i.path.length>0){const n=i.path[0];t[n]=t[n]||[],t[n].push(e(i))}else s.push(e(i));return{formErrors:s,fieldErrors:t}}get formErrors(){return this.flatten()}}N.create=r=>new N(r);const xe=(r,e)=>{let t;switch(r.code){case h.invalid_type:r.received===m.undefined?t="Required":t=`Expected ${r.expected}, received ${r.received}`;break;case h.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(r.expected,x.jsonStringifyReplacer)}`;break;case h.unrecognized_keys:t=`Unrecognized key(s) in object: ${x.joinValues(r.keys,", ")}`;break;case h.invalid_union:t="Invalid input";break;case h.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${x.joinValues(r.options)}`;break;case h.invalid_enum_value:t=`Invalid enum value. Expected ${x.joinValues(r.options)}, received '${r.received}'`;break;case h.invalid_arguments:t="Invalid function arguments";break;case h.invalid_return_type:t="Invalid function return type";break;case h.invalid_date:t="Invalid date";break;case h.invalid_string:typeof r.validation=="object"?"includes"in r.validation?(t=`Invalid input: must include "${r.validation.includes}"`,typeof r.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${r.validation.position}`)):"startsWith"in r.validation?t=`Invalid input: must start with "${r.validation.startsWith}"`:"endsWith"in r.validation?t=`Invalid input: must end with "${r.validation.endsWith}"`:x.assertNever(r.validation):r.validation!=="regex"?t=`Invalid ${r.validation}`:t="Invalid";break;case h.too_small:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at least":"more than"} ${r.minimum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at least":"over"} ${r.minimum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="bigint"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(r.minimum))}`:t="Invalid input";break;case h.too_big:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at most":"less than"} ${r.maximum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at most":"under"} ${r.maximum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="bigint"?t=`BigInt must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly":r.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(r.maximum))}`:t="Invalid input";break;case h.custom:t="Invalid input";break;case h.invalid_intersection_types:t="Intersection results could not be merged";break;case h.not_multiple_of:t=`Number must be a multiple of ${r.multipleOf}`;break;case h.not_finite:t="Number must be finite";break;default:t=e.defaultError,x.assertNever(r)}return{message:t}};let At=xe;function Bt(){return At}const zt=r=>{const{data:e,path:t,errorMaps:s,issueData:i}=r,n=[...t,...i.path||[]],a={...i,path:n};if(i.message!==void 0)return{...i,path:n,message:i.message};let o="";const d=s.filter(c=>!!c).slice().reverse();for(const c of d)o=c(a,{data:e,defaultError:o}).message;return{...i,path:n,message:o}};function u(r,e){const t=Bt(),s=zt({issueData:e,data:r.data,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,t,t===xe?void 0:xe].filter(i=>!!i)});r.common.issues.push(s)}class I{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const s=[];for(const i of t){if(i.status==="aborted")return g;i.status==="dirty"&&e.dirty(),s.push(i.value)}return{status:e.value,value:s}}static async mergeObjectAsync(e,t){const s=[];for(const i of t){const n=await i.key,a=await i.value;s.push({key:n,value:a})}return I.mergeObjectSync(e,s)}static mergeObjectSync(e,t){const s={};for(const i of t){const{key:n,value:a}=i;if(n.status==="aborted"||a.status==="aborted")return g;n.status==="dirty"&&e.dirty(),a.status==="dirty"&&e.dirty(),n.value!=="__proto__"&&(typeof a.value<"u"||i.alwaysSet)&&(s[n.value]=a.value)}return{status:e.value,value:s}}}const g=Object.freeze({status:"aborted"}),te=r=>({status:"dirty",value:r}),E=r=>({status:"valid",value:r}),Me=r=>r.status==="aborted",Re=r=>r.status==="dirty",K=r=>r.status==="valid",de=r=>typeof Promise<"u"&&r instanceof Promise;var p;(function(r){r.errToObj=e=>typeof e=="string"?{message:e}:e||{},r.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(p||(p={}));class j{constructor(e,t,s,i){this._cachedPath=[],this.parent=e,this.data=t,this._path=s,this._key=i}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Ne=(r,e)=>{if(K(e))return{success:!0,data:e.value};if(!r.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new N(r.common.issues);return this._error=t,this._error}}};function v(r){if(!r)return{};const{errorMap:e,invalid_type_error:t,required_error:s,description:i}=r;if(e&&(t||s))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:i}:{errorMap:(a,o)=>{const{message:d}=r;return a.code==="invalid_enum_value"?{message:d??o.defaultError}:typeof o.data>"u"?{message:d??s??o.defaultError}:a.code!=="invalid_type"?{message:o.defaultError}:{message:d??t??o.defaultError}},description:i}}class _{get description(){return this._def.description}_getType(e){return A(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:A(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new I,ctx:{common:e.parent.common,data:e.data,parsedType:A(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(de(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const s=this.safeParse(e,t);if(s.success)return s.data;throw s.error}safeParse(e,t){const s={common:{issues:[],async:(t==null?void 0:t.async)??!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:A(e)},i=this._parseSync({data:e,path:s.path,parent:s});return Ne(s,i)}"~validate"(e){var s,i;const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:A(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return K(n)?{value:n.value}:{issues:t.common.issues}}catch(n){(i=(s=n==null?void 0:n.message)==null?void 0:s.toLowerCase())!=null&&i.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(n=>K(n)?{value:n.value}:{issues:t.common.issues})}async parseAsync(e,t){const s=await this.safeParseAsync(e,t);if(s.success)return s.data;throw s.error}async safeParseAsync(e,t){const s={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:A(e)},i=this._parse({data:e,path:s.path,parent:s}),n=await(de(i)?i:Promise.resolve(i));return Ne(s,n)}refine(e,t){const s=i=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(i):t;return this._refinement((i,n)=>{const a=e(i),o=()=>n.addIssue({code:h.custom,...s(i)});return typeof Promise<"u"&&a instanceof Promise?a.then(d=>d?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(e,t){return this._refinement((s,i)=>e(s)?!0:(i.addIssue(typeof t=="function"?t(s,i):t),!1))}_refinement(e){return new Q({schema:this,typeName:y.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return $.create(this,this._def)}nullable(){return ee.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return M.create(this)}promise(){return me.create(this,this._def)}or(e){return he.create([this,e],this._def)}and(e){return ue.create(this,e,this._def)}transform(e){return new Q({...v(this._def),schema:this,typeName:y.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new Te({...v(this._def),innerType:this,defaultValue:t,typeName:y.ZodDefault})}brand(){return new os({typeName:y.ZodBranded,type:this,...v(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Se({...v(this._def),innerType:this,catchValue:t,typeName:y.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Ie.create(this,e)}readonly(){return ke.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Zt=/^c[^\s-]{8,}$/i,$t=/^[0-9a-z]+$/,jt=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Ft=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Vt=/^[a-z0-9_-]{21}$/i,Ht=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Wt=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Ut=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Gt="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let ve;const Yt=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,qt=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Kt=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Jt=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Xt=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Qt=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nt="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",es=new RegExp(`^${nt}$`);function rt(r){let e="[0-5]\\d";r.precision?e=`${e}\\.\\d{${r.precision}}`:r.precision==null&&(e=`${e}(\\.\\d+)?`);const t=r.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function ts(r){return new RegExp(`^${rt(r)}$`)}function ss(r){let e=`${nt}T${rt(r)}`;const t=[];return t.push(r.local?"Z?":"Z"),r.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function is(r,e){return!!((e==="v4"||!e)&&Yt.test(r)||(e==="v6"||!e)&&Kt.test(r))}function ns(r,e){if(!Ht.test(r))return!1;try{const[t]=r.split(".");if(!t)return!1;const s=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),i=JSON.parse(atob(s));return!(typeof i!="object"||i===null||"typ"in i&&(i==null?void 0:i.typ)!=="JWT"||!i.alg||e&&i.alg!==e)}catch{return!1}}function rs(r,e){return!!((e==="v4"||!e)&&qt.test(r)||(e==="v6"||!e)&&Jt.test(r))}class Z extends _{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==m.string){const n=this._getOrReturnCtx(e);return u(n,{code:h.invalid_type,expected:m.string,received:n.parsedType}),g}const s=new I;let i;for(const n of this._def.checks)if(n.kind==="min")e.data.length<n.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:h.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),s.dirty());else if(n.kind==="max")e.data.length>n.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:h.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),s.dirty());else if(n.kind==="length"){const a=e.data.length>n.value,o=e.data.length<n.value;(a||o)&&(i=this._getOrReturnCtx(e,i),a?u(i,{code:h.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}):o&&u(i,{code:h.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}),s.dirty())}else if(n.kind==="email")Ut.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"email",code:h.invalid_string,message:n.message}),s.dirty());else if(n.kind==="emoji")ve||(ve=new RegExp(Gt,"u")),ve.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"emoji",code:h.invalid_string,message:n.message}),s.dirty());else if(n.kind==="uuid")Ft.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"uuid",code:h.invalid_string,message:n.message}),s.dirty());else if(n.kind==="nanoid")Vt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"nanoid",code:h.invalid_string,message:n.message}),s.dirty());else if(n.kind==="cuid")Zt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"cuid",code:h.invalid_string,message:n.message}),s.dirty());else if(n.kind==="cuid2")$t.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"cuid2",code:h.invalid_string,message:n.message}),s.dirty());else if(n.kind==="ulid")jt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"ulid",code:h.invalid_string,message:n.message}),s.dirty());else if(n.kind==="url")try{new URL(e.data)}catch{i=this._getOrReturnCtx(e,i),u(i,{validation:"url",code:h.invalid_string,message:n.message}),s.dirty()}else n.kind==="regex"?(n.regex.lastIndex=0,n.regex.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"regex",code:h.invalid_string,message:n.message}),s.dirty())):n.kind==="trim"?e.data=e.data.trim():n.kind==="includes"?e.data.includes(n.value,n.position)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:{includes:n.value,position:n.position},message:n.message}),s.dirty()):n.kind==="toLowerCase"?e.data=e.data.toLowerCase():n.kind==="toUpperCase"?e.data=e.data.toUpperCase():n.kind==="startsWith"?e.data.startsWith(n.value)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:{startsWith:n.value},message:n.message}),s.dirty()):n.kind==="endsWith"?e.data.endsWith(n.value)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:{endsWith:n.value},message:n.message}),s.dirty()):n.kind==="datetime"?ss(n).test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:"datetime",message:n.message}),s.dirty()):n.kind==="date"?es.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:"date",message:n.message}),s.dirty()):n.kind==="time"?ts(n).test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:"time",message:n.message}),s.dirty()):n.kind==="duration"?Wt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"duration",code:h.invalid_string,message:n.message}),s.dirty()):n.kind==="ip"?is(e.data,n.version)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"ip",code:h.invalid_string,message:n.message}),s.dirty()):n.kind==="jwt"?ns(e.data,n.alg)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"jwt",code:h.invalid_string,message:n.message}),s.dirty()):n.kind==="cidr"?rs(e.data,n.version)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"cidr",code:h.invalid_string,message:n.message}),s.dirty()):n.kind==="base64"?Xt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"base64",code:h.invalid_string,message:n.message}),s.dirty()):n.kind==="base64url"?Qt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"base64url",code:h.invalid_string,message:n.message}),s.dirty()):x.assertNever(n);return{status:s.value,value:e.data}}_regex(e,t,s){return this.refinement(i=>e.test(i),{validation:t,code:h.invalid_string,...p.errToObj(s)})}_addCheck(e){return new Z({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...p.errToObj(e)})}url(e){return this._addCheck({kind:"url",...p.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...p.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...p.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...p.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...p.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...p.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...p.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...p.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...p.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...p.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...p.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...p.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...p.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...p.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...p.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...p.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...p.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...p.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...p.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...p.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...p.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...p.errToObj(t)})}nonempty(e){return this.min(1,p.errToObj(e))}trim(){return new Z({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Z({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Z({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Z.create=r=>new Z({checks:[],typeName:y.ZodString,coerce:(r==null?void 0:r.coerce)??!1,...v(r)});function as(r,e){const t=(r.toString().split(".")[1]||"").length,s=(e.toString().split(".")[1]||"").length,i=t>s?t:s,n=Number.parseInt(r.toFixed(i).replace(".","")),a=Number.parseInt(e.toFixed(i).replace(".",""));return n%a/10**i}class J extends _{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==m.number){const n=this._getOrReturnCtx(e);return u(n,{code:h.invalid_type,expected:m.number,received:n.parsedType}),g}let s;const i=new I;for(const n of this._def.checks)n.kind==="int"?x.isInteger(e.data)||(s=this._getOrReturnCtx(e,s),u(s,{code:h.invalid_type,expected:"integer",received:"float",message:n.message}),i.dirty()):n.kind==="min"?(n.inclusive?e.data<n.value:e.data<=n.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.too_small,minimum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),i.dirty()):n.kind==="max"?(n.inclusive?e.data>n.value:e.data>=n.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.too_big,maximum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),i.dirty()):n.kind==="multipleOf"?as(e.data,n.value)!==0&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.not_multiple_of,multipleOf:n.value,message:n.message}),i.dirty()):n.kind==="finite"?Number.isFinite(e.data)||(s=this._getOrReturnCtx(e,s),u(s,{code:h.not_finite,message:n.message}),i.dirty()):x.assertNever(n);return{status:i.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,p.toString(t))}gt(e,t){return this.setLimit("min",e,!1,p.toString(t))}lte(e,t){return this.setLimit("max",e,!0,p.toString(t))}lt(e,t){return this.setLimit("max",e,!1,p.toString(t))}setLimit(e,t,s,i){return new J({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:p.toString(i)}]})}_addCheck(e){return new J({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:p.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:p.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:p.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:p.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:p.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:p.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:p.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:p.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:p.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&x.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const s of this._def.checks){if(s.kind==="finite"||s.kind==="int"||s.kind==="multipleOf")return!0;s.kind==="min"?(t===null||s.value>t)&&(t=s.value):s.kind==="max"&&(e===null||s.value<e)&&(e=s.value)}return Number.isFinite(t)&&Number.isFinite(e)}}J.create=r=>new J({checks:[],typeName:y.ZodNumber,coerce:(r==null?void 0:r.coerce)||!1,...v(r)});class ie extends _{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==m.bigint)return this._getInvalidInput(e);let s;const i=new I;for(const n of this._def.checks)n.kind==="min"?(n.inclusive?e.data<n.value:e.data<=n.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.too_small,type:"bigint",minimum:n.value,inclusive:n.inclusive,message:n.message}),i.dirty()):n.kind==="max"?(n.inclusive?e.data>n.value:e.data>=n.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.too_big,type:"bigint",maximum:n.value,inclusive:n.inclusive,message:n.message}),i.dirty()):n.kind==="multipleOf"?e.data%n.value!==BigInt(0)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.not_multiple_of,multipleOf:n.value,message:n.message}),i.dirty()):x.assertNever(n);return{status:i.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return u(t,{code:h.invalid_type,expected:m.bigint,received:t.parsedType}),g}gte(e,t){return this.setLimit("min",e,!0,p.toString(t))}gt(e,t){return this.setLimit("min",e,!1,p.toString(t))}lte(e,t){return this.setLimit("max",e,!0,p.toString(t))}lt(e,t){return this.setLimit("max",e,!1,p.toString(t))}setLimit(e,t,s,i){return new ie({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:p.toString(i)}]})}_addCheck(e){return new ie({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:p.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:p.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:p.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:p.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:p.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}ie.create=r=>new ie({checks:[],typeName:y.ZodBigInt,coerce:(r==null?void 0:r.coerce)??!1,...v(r)});class be extends _{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==m.boolean){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:m.boolean,received:s.parsedType}),g}return E(e.data)}}be.create=r=>new be({typeName:y.ZodBoolean,coerce:(r==null?void 0:r.coerce)||!1,...v(r)});class ce extends _{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==m.date){const n=this._getOrReturnCtx(e);return u(n,{code:h.invalid_type,expected:m.date,received:n.parsedType}),g}if(Number.isNaN(e.data.getTime())){const n=this._getOrReturnCtx(e);return u(n,{code:h.invalid_date}),g}const s=new I;let i;for(const n of this._def.checks)n.kind==="min"?e.data.getTime()<n.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:h.too_small,message:n.message,inclusive:!0,exact:!1,minimum:n.value,type:"date"}),s.dirty()):n.kind==="max"?e.data.getTime()>n.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:h.too_big,message:n.message,inclusive:!0,exact:!1,maximum:n.value,type:"date"}),s.dirty()):x.assertNever(n);return{status:s.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ce({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:p.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:p.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}ce.create=r=>new ce({checks:[],coerce:(r==null?void 0:r.coerce)||!1,typeName:y.ZodDate,...v(r)});class De extends _{_parse(e){if(this._getType(e)!==m.symbol){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:m.symbol,received:s.parsedType}),g}return E(e.data)}}De.create=r=>new De({typeName:y.ZodSymbol,...v(r)});class Ae extends _{_parse(e){if(this._getType(e)!==m.undefined){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:m.undefined,received:s.parsedType}),g}return E(e.data)}}Ae.create=r=>new Ae({typeName:y.ZodUndefined,...v(r)});class Be extends _{_parse(e){if(this._getType(e)!==m.null){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:m.null,received:s.parsedType}),g}return E(e.data)}}Be.create=r=>new Be({typeName:y.ZodNull,...v(r)});class ze extends _{constructor(){super(...arguments),this._any=!0}_parse(e){return E(e.data)}}ze.create=r=>new ze({typeName:y.ZodAny,...v(r)});class Ze extends _{constructor(){super(...arguments),this._unknown=!0}_parse(e){return E(e.data)}}Ze.create=r=>new Ze({typeName:y.ZodUnknown,...v(r)});class F extends _{_parse(e){const t=this._getOrReturnCtx(e);return u(t,{code:h.invalid_type,expected:m.never,received:t.parsedType}),g}}F.create=r=>new F({typeName:y.ZodNever,...v(r)});class $e extends _{_parse(e){if(this._getType(e)!==m.undefined){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:m.void,received:s.parsedType}),g}return E(e.data)}}$e.create=r=>new $e({typeName:y.ZodVoid,...v(r)});class M extends _{_parse(e){const{ctx:t,status:s}=this._processInputParams(e),i=this._def;if(t.parsedType!==m.array)return u(t,{code:h.invalid_type,expected:m.array,received:t.parsedType}),g;if(i.exactLength!==null){const a=t.data.length>i.exactLength.value,o=t.data.length<i.exactLength.value;(a||o)&&(u(t,{code:a?h.too_big:h.too_small,minimum:o?i.exactLength.value:void 0,maximum:a?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),s.dirty())}if(i.minLength!==null&&t.data.length<i.minLength.value&&(u(t,{code:h.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),s.dirty()),i.maxLength!==null&&t.data.length>i.maxLength.value&&(u(t,{code:h.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),s.dirty()),t.common.async)return Promise.all([...t.data].map((a,o)=>i.type._parseAsync(new j(t,a,t.path,o)))).then(a=>I.mergeArray(s,a));const n=[...t.data].map((a,o)=>i.type._parseSync(new j(t,a,t.path,o)));return I.mergeArray(s,n)}get element(){return this._def.type}min(e,t){return new M({...this._def,minLength:{value:e,message:p.toString(t)}})}max(e,t){return new M({...this._def,maxLength:{value:e,message:p.toString(t)}})}length(e,t){return new M({...this._def,exactLength:{value:e,message:p.toString(t)}})}nonempty(e){return this.min(1,e)}}M.create=(r,e)=>new M({type:r,minLength:null,maxLength:null,exactLength:null,typeName:y.ZodArray,...v(e)});function U(r){if(r instanceof T){const e={};for(const t in r.shape){const s=r.shape[t];e[t]=$.create(U(s))}return new T({...r._def,shape:()=>e})}else return r instanceof M?new M({...r._def,type:U(r.element)}):r instanceof $?$.create(U(r.unwrap())):r instanceof ee?ee.create(U(r.unwrap())):r instanceof W?W.create(r.items.map(e=>U(e))):r}class T extends _{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=x.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==m.object){const c=this._getOrReturnCtx(e);return u(c,{code:h.invalid_type,expected:m.object,received:c.parsedType}),g}const{status:s,ctx:i}=this._processInputParams(e),{shape:n,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof F&&this._def.unknownKeys==="strip"))for(const c in i.data)a.includes(c)||o.push(c);const d=[];for(const c of a){const f=n[c],b=i.data[c];d.push({key:{status:"valid",value:c},value:f._parse(new j(i,b,i.path,c)),alwaysSet:c in i.data})}if(this._def.catchall instanceof F){const c=this._def.unknownKeys;if(c==="passthrough")for(const f of o)d.push({key:{status:"valid",value:f},value:{status:"valid",value:i.data[f]}});else if(c==="strict")o.length>0&&(u(i,{code:h.unrecognized_keys,keys:o}),s.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const f of o){const b=i.data[f];d.push({key:{status:"valid",value:f},value:c._parse(new j(i,b,i.path,f)),alwaysSet:f in i.data})}}return i.common.async?Promise.resolve().then(async()=>{const c=[];for(const f of d){const b=await f.key,w=await f.value;c.push({key:b,value:w,alwaysSet:f.alwaysSet})}return c}).then(c=>I.mergeObjectSync(s,c)):I.mergeObjectSync(s,d)}get shape(){return this._def.shape()}strict(e){return p.errToObj,new T({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,s)=>{var n,a;const i=((a=(n=this._def).errorMap)==null?void 0:a.call(n,t,s).message)??s.defaultError;return t.code==="unrecognized_keys"?{message:p.errToObj(e).message??i}:{message:i}}}:{}})}strip(){return new T({...this._def,unknownKeys:"strip"})}passthrough(){return new T({...this._def,unknownKeys:"passthrough"})}extend(e){return new T({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new T({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:y.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new T({...this._def,catchall:e})}pick(e){const t={};for(const s of x.objectKeys(e))e[s]&&this.shape[s]&&(t[s]=this.shape[s]);return new T({...this._def,shape:()=>t})}omit(e){const t={};for(const s of x.objectKeys(this.shape))e[s]||(t[s]=this.shape[s]);return new T({...this._def,shape:()=>t})}deepPartial(){return U(this)}partial(e){const t={};for(const s of x.objectKeys(this.shape)){const i=this.shape[s];e&&!e[s]?t[s]=i:t[s]=i.optional()}return new T({...this._def,shape:()=>t})}required(e){const t={};for(const s of x.objectKeys(this.shape))if(e&&!e[s])t[s]=this.shape[s];else{let n=this.shape[s];for(;n instanceof $;)n=n._def.innerType;t[s]=n}return new T({...this._def,shape:()=>t})}keyof(){return at(x.objectKeys(this.shape))}}T.create=(r,e)=>new T({shape:()=>r,unknownKeys:"strip",catchall:F.create(),typeName:y.ZodObject,...v(e)});T.strictCreate=(r,e)=>new T({shape:()=>r,unknownKeys:"strict",catchall:F.create(),typeName:y.ZodObject,...v(e)});T.lazycreate=(r,e)=>new T({shape:r,unknownKeys:"strip",catchall:F.create(),typeName:y.ZodObject,...v(e)});class he extends _{_parse(e){const{ctx:t}=this._processInputParams(e),s=this._def.options;function i(n){for(const o of n)if(o.result.status==="valid")return o.result;for(const o of n)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const a=n.map(o=>new N(o.ctx.common.issues));return u(t,{code:h.invalid_union,unionErrors:a}),g}if(t.common.async)return Promise.all(s.map(async n=>{const a={...t,common:{...t.common,issues:[]},parent:null};return{result:await n._parseAsync({data:t.data,path:t.path,parent:a}),ctx:a}})).then(i);{let n;const a=[];for(const d of s){const c={...t,common:{...t.common,issues:[]},parent:null},f=d._parseSync({data:t.data,path:t.path,parent:c});if(f.status==="valid")return f;f.status==="dirty"&&!n&&(n={result:f,ctx:c}),c.common.issues.length&&a.push(c.common.issues)}if(n)return t.common.issues.push(...n.ctx.common.issues),n.result;const o=a.map(d=>new N(d));return u(t,{code:h.invalid_union,unionErrors:o}),g}}get options(){return this._def.options}}he.create=(r,e)=>new he({options:r,typeName:y.ZodUnion,...v(e)});function we(r,e){const t=A(r),s=A(e);if(r===e)return{valid:!0,data:r};if(t===m.object&&s===m.object){const i=x.objectKeys(e),n=x.objectKeys(r).filter(o=>i.indexOf(o)!==-1),a={...r,...e};for(const o of n){const d=we(r[o],e[o]);if(!d.valid)return{valid:!1};a[o]=d.data}return{valid:!0,data:a}}else if(t===m.array&&s===m.array){if(r.length!==e.length)return{valid:!1};const i=[];for(let n=0;n<r.length;n++){const a=r[n],o=e[n],d=we(a,o);if(!d.valid)return{valid:!1};i.push(d.data)}return{valid:!0,data:i}}else return t===m.date&&s===m.date&&+r==+e?{valid:!0,data:r}:{valid:!1}}class ue extends _{_parse(e){const{status:t,ctx:s}=this._processInputParams(e),i=(n,a)=>{if(Me(n)||Me(a))return g;const o=we(n.value,a.value);return o.valid?((Re(n)||Re(a))&&t.dirty(),{status:t.value,value:o.data}):(u(s,{code:h.invalid_intersection_types}),g)};return s.common.async?Promise.all([this._def.left._parseAsync({data:s.data,path:s.path,parent:s}),this._def.right._parseAsync({data:s.data,path:s.path,parent:s})]).then(([n,a])=>i(n,a)):i(this._def.left._parseSync({data:s.data,path:s.path,parent:s}),this._def.right._parseSync({data:s.data,path:s.path,parent:s}))}}ue.create=(r,e,t)=>new ue({left:r,right:e,typeName:y.ZodIntersection,...v(t)});class W extends _{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==m.array)return u(s,{code:h.invalid_type,expected:m.array,received:s.parsedType}),g;if(s.data.length<this._def.items.length)return u(s,{code:h.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),g;!this._def.rest&&s.data.length>this._def.items.length&&(u(s,{code:h.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const n=[...s.data].map((a,o)=>{const d=this._def.items[o]||this._def.rest;return d?d._parse(new j(s,a,s.path,o)):null}).filter(a=>!!a);return s.common.async?Promise.all(n).then(a=>I.mergeArray(t,a)):I.mergeArray(t,n)}get items(){return this._def.items}rest(e){return new W({...this._def,rest:e})}}W.create=(r,e)=>{if(!Array.isArray(r))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new W({items:r,typeName:y.ZodTuple,rest:null,...v(e)})};class je extends _{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==m.map)return u(s,{code:h.invalid_type,expected:m.map,received:s.parsedType}),g;const i=this._def.keyType,n=this._def.valueType,a=[...s.data.entries()].map(([o,d],c)=>({key:i._parse(new j(s,o,s.path,[c,"key"])),value:n._parse(new j(s,d,s.path,[c,"value"]))}));if(s.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const d of a){const c=await d.key,f=await d.value;if(c.status==="aborted"||f.status==="aborted")return g;(c.status==="dirty"||f.status==="dirty")&&t.dirty(),o.set(c.value,f.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const d of a){const c=d.key,f=d.value;if(c.status==="aborted"||f.status==="aborted")return g;(c.status==="dirty"||f.status==="dirty")&&t.dirty(),o.set(c.value,f.value)}return{status:t.value,value:o}}}}je.create=(r,e,t)=>new je({valueType:e,keyType:r,typeName:y.ZodMap,...v(t)});class ne extends _{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==m.set)return u(s,{code:h.invalid_type,expected:m.set,received:s.parsedType}),g;const i=this._def;i.minSize!==null&&s.data.size<i.minSize.value&&(u(s,{code:h.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),t.dirty()),i.maxSize!==null&&s.data.size>i.maxSize.value&&(u(s,{code:h.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),t.dirty());const n=this._def.valueType;function a(d){const c=new Set;for(const f of d){if(f.status==="aborted")return g;f.status==="dirty"&&t.dirty(),c.add(f.value)}return{status:t.value,value:c}}const o=[...s.data.values()].map((d,c)=>n._parse(new j(s,d,s.path,c)));return s.common.async?Promise.all(o).then(d=>a(d)):a(o)}min(e,t){return new ne({...this._def,minSize:{value:e,message:p.toString(t)}})}max(e,t){return new ne({...this._def,maxSize:{value:e,message:p.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}ne.create=(r,e)=>new ne({valueType:r,minSize:null,maxSize:null,typeName:y.ZodSet,...v(e)});class Fe extends _{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Fe.create=(r,e)=>new Fe({getter:r,typeName:y.ZodLazy,...v(e)});class Ce extends _{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return u(t,{received:t.data,code:h.invalid_literal,expected:this._def.value}),g}return{status:"valid",value:e.data}}get value(){return this._def.value}}Ce.create=(r,e)=>new Ce({value:r,typeName:y.ZodLiteral,...v(e)});function at(r,e){return new X({values:r,typeName:y.ZodEnum,...v(e)})}class X extends _{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),s=this._def.values;return u(t,{expected:x.joinValues(s),received:t.parsedType,code:h.invalid_type}),g}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),s=this._def.values;return u(t,{received:t.data,code:h.invalid_enum_value,options:s}),g}return E(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return X.create(e,{...this._def,...t})}exclude(e,t=this._def){return X.create(this.options.filter(s=>!e.includes(s)),{...this._def,...t})}}X.create=at;class Ve extends _{_parse(e){const t=x.getValidEnumValues(this._def.values),s=this._getOrReturnCtx(e);if(s.parsedType!==m.string&&s.parsedType!==m.number){const i=x.objectValues(t);return u(s,{expected:x.joinValues(i),received:s.parsedType,code:h.invalid_type}),g}if(this._cache||(this._cache=new Set(x.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const i=x.objectValues(t);return u(s,{received:s.data,code:h.invalid_enum_value,options:i}),g}return E(e.data)}get enum(){return this._def.values}}Ve.create=(r,e)=>new Ve({values:r,typeName:y.ZodNativeEnum,...v(e)});class me extends _{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==m.promise&&t.common.async===!1)return u(t,{code:h.invalid_type,expected:m.promise,received:t.parsedType}),g;const s=t.parsedType===m.promise?t.data:Promise.resolve(t.data);return E(s.then(i=>this._def.type.parseAsync(i,{path:t.path,errorMap:t.common.contextualErrorMap})))}}me.create=(r,e)=>new me({type:r,typeName:y.ZodPromise,...v(e)});class Q extends _{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===y.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:s}=this._processInputParams(e),i=this._def.effect||null,n={addIssue:a=>{u(s,a),a.fatal?t.abort():t.dirty()},get path(){return s.path}};if(n.addIssue=n.addIssue.bind(n),i.type==="preprocess"){const a=i.transform(s.data,n);if(s.common.async)return Promise.resolve(a).then(async o=>{if(t.value==="aborted")return g;const d=await this._def.schema._parseAsync({data:o,path:s.path,parent:s});return d.status==="aborted"?g:d.status==="dirty"||t.value==="dirty"?te(d.value):d});{if(t.value==="aborted")return g;const o=this._def.schema._parseSync({data:a,path:s.path,parent:s});return o.status==="aborted"?g:o.status==="dirty"||t.value==="dirty"?te(o.value):o}}if(i.type==="refinement"){const a=o=>{const d=i.refinement(o,n);if(s.common.async)return Promise.resolve(d);if(d instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(s.common.async===!1){const o=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});return o.status==="aborted"?g:(o.status==="dirty"&&t.dirty(),a(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(o=>o.status==="aborted"?g:(o.status==="dirty"&&t.dirty(),a(o.value).then(()=>({status:t.value,value:o.value}))))}if(i.type==="transform")if(s.common.async===!1){const a=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});if(!K(a))return g;const o=i.transform(a.value,n);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(a=>K(a)?Promise.resolve(i.transform(a.value,n)).then(o=>({status:t.value,value:o})):g);x.assertNever(i)}}Q.create=(r,e,t)=>new Q({schema:r,typeName:y.ZodEffects,effect:e,...v(t)});Q.createWithPreprocess=(r,e,t)=>new Q({schema:e,effect:{type:"preprocess",transform:r},typeName:y.ZodEffects,...v(t)});class $ extends _{_parse(e){return this._getType(e)===m.undefined?E(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}$.create=(r,e)=>new $({innerType:r,typeName:y.ZodOptional,...v(e)});class ee extends _{_parse(e){return this._getType(e)===m.null?E(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ee.create=(r,e)=>new ee({innerType:r,typeName:y.ZodNullable,...v(e)});class Te extends _{_parse(e){const{ctx:t}=this._processInputParams(e);let s=t.data;return t.parsedType===m.undefined&&(s=this._def.defaultValue()),this._def.innerType._parse({data:s,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Te.create=(r,e)=>new Te({innerType:r,typeName:y.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...v(e)});class Se extends _{_parse(e){const{ctx:t}=this._processInputParams(e),s={...t,common:{...t.common,issues:[]}},i=this._def.innerType._parse({data:s.data,path:s.path,parent:{...s}});return de(i)?i.then(n=>({status:"valid",value:n.status==="valid"?n.value:this._def.catchValue({get error(){return new N(s.common.issues)},input:s.data})})):{status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new N(s.common.issues)},input:s.data})}}removeCatch(){return this._def.innerType}}Se.create=(r,e)=>new Se({innerType:r,typeName:y.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...v(e)});class He extends _{_parse(e){if(this._getType(e)!==m.nan){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:m.nan,received:s.parsedType}),g}return{status:"valid",value:e.data}}}He.create=r=>new He({typeName:y.ZodNaN,...v(r)});class os extends _{_parse(e){const{ctx:t}=this._processInputParams(e),s=t.data;return this._def.type._parse({data:s,path:t.path,parent:t})}unwrap(){return this._def.type}}class Ie extends _{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.common.async)return(async()=>{const n=await this._def.in._parseAsync({data:s.data,path:s.path,parent:s});return n.status==="aborted"?g:n.status==="dirty"?(t.dirty(),te(n.value)):this._def.out._parseAsync({data:n.value,path:s.path,parent:s})})();{const i=this._def.in._parseSync({data:s.data,path:s.path,parent:s});return i.status==="aborted"?g:i.status==="dirty"?(t.dirty(),{status:"dirty",value:i.value}):this._def.out._parseSync({data:i.value,path:s.path,parent:s})}}static create(e,t){return new Ie({in:e,out:t,typeName:y.ZodPipeline})}}class ke extends _{_parse(e){const t=this._def.innerType._parse(e),s=i=>(K(i)&&(i.value=Object.freeze(i.value)),i);return de(t)?t.then(i=>s(i)):s(t)}unwrap(){return this._def.innerType}}ke.create=(r,e)=>new ke({innerType:r,typeName:y.ZodReadonly,...v(e)});var y;(function(r){r.ZodString="ZodString",r.ZodNumber="ZodNumber",r.ZodNaN="ZodNaN",r.ZodBigInt="ZodBigInt",r.ZodBoolean="ZodBoolean",r.ZodDate="ZodDate",r.ZodSymbol="ZodSymbol",r.ZodUndefined="ZodUndefined",r.ZodNull="ZodNull",r.ZodAny="ZodAny",r.ZodUnknown="ZodUnknown",r.ZodNever="ZodNever",r.ZodVoid="ZodVoid",r.ZodArray="ZodArray",r.ZodObject="ZodObject",r.ZodUnion="ZodUnion",r.ZodDiscriminatedUnion="ZodDiscriminatedUnion",r.ZodIntersection="ZodIntersection",r.ZodTuple="ZodTuple",r.ZodRecord="ZodRecord",r.ZodMap="ZodMap",r.ZodSet="ZodSet",r.ZodFunction="ZodFunction",r.ZodLazy="ZodLazy",r.ZodLiteral="ZodLiteral",r.ZodEnum="ZodEnum",r.ZodEffects="ZodEffects",r.ZodNativeEnum="ZodNativeEnum",r.ZodOptional="ZodOptional",r.ZodNullable="ZodNullable",r.ZodDefault="ZodDefault",r.ZodCatch="ZodCatch",r.ZodPromise="ZodPromise",r.ZodBranded="ZodBranded",r.ZodPipeline="ZodPipeline",r.ZodReadonly="ZodReadonly"})(y||(y={}));const B=Z.create,O=J.create,ls=be.create;F.create;const pe=M.create,R=T.create,ot=he.create;ue.create;W.create;const q=Ce.create,lt=X.create;me.create;$.create;ee.create;const dt=R({x:O().int().min(0),y:O().int().min(0)}),ds=R({tileId:O().int().min(0),position:dt,rotation:ot([q(0),q(90),q(180),q(270)]).optional()}),ct=R({id:B().min(1),name:B().min(1),zIndex:O().int(),visible:ls(),tiles:pe(ds)}),ht=R({width:O().int().min(1).max(256),height:O().int().min(1).max(256),tileWidth:O().int().min(1),tileHeight:O().int().min(1)}),ut=R({id:B(),name:B(),author:B().optional(),created:B(),modified:B(),version:O().int().min(1)}),cs=lt(["floor","blocker","slow","hole","conveyor","hazard","door","exit","spawn"]),hs=lt(["north","east","south","west"]),us=R({type:cs,direction:hs.optional(),linkedId:B().optional(),damage:O().int().min(1).optional()}),ms=R({position:dt,properties:us}),ps=R({tiles:pe(ms)}),fs=R({version:q(1),metadata:ut,grid:ht,layers:pe(ct).min(1)}),gs=R({version:q(2),metadata:ut,grid:ht,layers:pe(ct).min(1),gameplayLayer:ps.optional()}),ys=ot([fs,gs]);function vs(r){return ys.parse(r)}function fe(r,e={}){const t=r.toData();return e.pretty?JSON.stringify(t,null,2):JSON.stringify(t)}function ge(r){const e=JSON.parse(r),t=vs(e);return H.fromData(t)}function _s(r,e){const t=fe(r,{pretty:!0}),s=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(s),n=document.createElement("a");n.href=i,n.download=e??`${r.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}function mt(r){return new Promise((e,t)=>{const s=new FileReader;s.onload=i=>{var n;try{const a=(n=i.target)==null?void 0:n.result,o=ge(a);e(o)}catch(a){t(a)}},s.onerror=()=>{t(new Error("Failed to read file"))},s.readAsText(r)})}function xs(r,e="isometric_level"){const t=fe(r);localStorage.setItem(e,t)}function bs(r="isometric_level"){const e=localStorage.getItem(r);if(!e)return null;try{return ge(e)}catch{return null}}class ws{constructor(e,t){l(this,"canvas");l(this,"camera");l(this,"renderer");l(this,"tileRegistry");l(this,"state");l(this,"history");l(this,"_level");l(this,"tools",new Map);l(this,"activeTool",null);l(this,"animationFrameId",null);l(this,"isRunning",!1);l(this,"handleMouseDown",e=>{if(e.button!==0)return;const t=this.getGridCoord(e);t&&this.activeTool&&this.activeTool.onMouseDown(this.getToolContext(),t)});l(this,"handleMouseMove",e=>{const t=this.getGridCoord(e);if(this.state.setHoveredCoord(t),t?this.renderer.setHoveredCoord(t):this.renderer.setHoveredCoord(null),t&&this.activeTool){const s=(e.buttons&1)!==0;this.activeTool.onMouseMove(this.getToolContext(),t,s)}});l(this,"handleMouseUp",e=>{if(e.button!==0)return;const t=this.getGridCoord(e);t&&this.activeTool&&this.activeTool.onMouseUp(this.getToolContext(),t)});l(this,"handleMouseLeave",()=>{this.state.setHoveredCoord(null),this.renderer.setHoveredCoord(null)});l(this,"handleWheel",e=>{e.preventDefault();const t=-e.deltaY*.001,s=this.canvas.element.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top;this.camera.zoomBy(t,i,n)});l(this,"handleKeyDown",e=>{if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)){if(e.key==="z"&&(e.ctrlKey||e.metaKey)){e.shiftKey?this.history.redo():this.history.undo(),e.preventDefault();return}if(e.key==="y"&&(e.ctrlKey||e.metaKey)){this.history.redo(),e.preventDefault();return}if(e.key==="s"&&(e.ctrlKey||e.metaKey)){this.saveToStorage(),e.preventDefault();return}for(const t of this.tools.values())if(t.shortcut===e.key.toLowerCase()){this.setTool(t.type);return}}});l(this,"renderLoop",()=>{this.isRunning&&(this.render(),this.animationFrameId=requestAnimationFrame(this.renderLoop))});this.canvas=new Qe({canvas:e.canvas,container:e.container}),this.camera=new tt({zoom:2}),this.tileRegistry=t,this.renderer=new st(this.canvas,this.camera,t),this.state=new Et,this.history=new Lt({maxSize:100}),this._level=H.createDefault();const s=this._level.getLayers()[0];s&&this.state.setActiveLayer(s.config.id),this.registerTool(new Nt),this.registerTool(new Dt),this.setTool("brush"),this.setupEventListeners()}get level(){return this._level}registerTool(e){this.tools.set(e.type,e)}setTool(e){var i,n,a,o,d;const t=this.tools.get(e);if(!t)return;this.activeTool&&((n=(i=this.activeTool).onDeactivate)==null||n.call(i,this.getToolContext())),this.activeTool=t,(o=(a=this.activeTool).onActivate)==null||o.call(a,this.getToolContext()),this.state.setActiveTool(e);const s=((d=t.getCursor)==null?void 0:d.call(t))??"default";this.canvas.element.style.cursor=s}getToolContext(){return{level:this._level,editorState:this.state,history:this.history}}newLevel(e,t={}){const s=H.createDefault(e,t);this.setLevel(s),this.camera.setPosition(0,0)}loadLevel(e){const t=ge(e);this.setLevel(t)}async loadLevelFromFile(e){const t=await mt(e);this.setLevel(t)}setLevel(e){this._level=e,this.history.clear();const t=this._level.getLayers()[0];t&&this.state.setActiveLayer(t.config.id),this.state.notifyLevelLoaded(e.toData()),this.state.markClean()}saveLevel(){const e=fe(this._level,{pretty:!0});return this.history.markSaved(),this.state.markClean(),e}downloadLevel(e){_s(this._level,e),this.history.markSaved(),this.state.markClean()}saveToStorage(){xs(this._level),this.history.markSaved(),this.state.markClean()}loadFromStorage(){const e=bs();return e?(this.setLevel(e),!0):!1}setupEventListeners(){const e=this.canvas.element;e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("mousemove",this.handleMouseMove),e.addEventListener("mouseup",this.handleMouseUp),e.addEventListener("mouseleave",this.handleMouseLeave),e.addEventListener("wheel",this.handleWheel,{passive:!1}),window.addEventListener("keydown",this.handleKeyDown)}getGridCoord(e){const t=this.canvas.element.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,n=this.renderer.screenToGrid(s,i,this._level);return this._level.isInBounds(n)?n:null}start(){this.isRunning||(this.isRunning=!0,this.renderLoop())}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}render(){this.renderer.render(this._level)}dispose(){this.stop();const e=this.canvas.element;e.removeEventListener("mousedown",this.handleMouseDown),e.removeEventListener("mousemove",this.handleMouseMove),e.removeEventListener("mouseup",this.handleMouseUp),e.removeEventListener("mouseleave",this.handleMouseLeave),e.removeEventListener("wheel",this.handleWheel),window.removeEventListener("keydown",this.handleKeyDown),this.canvas.dispose()}}class Cs{constructor(e,t,s){l(this,"container");l(this,"editor");l(this,"tileRegistry");l(this,"selectedTileId",null);l(this,"tileElements",new Map);const i=document.getElementById(e);if(!i)throw new Error(`Container not found: ${e}`);this.container=i,this.editor=t,this.tileRegistry=s,this.render(),this.setupEventListeners()}render(){this.container.innerHTML="";const e=this.tileRegistry.getAllTileIds(),t=document.createElement("div");t.id="tile-grid";for(const s of e){const i=this.createTileItem(s);this.tileElements.set(s,i),t.appendChild(i)}this.container.appendChild(t)}createTileItem(e){const t=document.createElement("div");t.className="tile-item",t.dataset.tileId=String(e);const s=this.tileRegistry.createTilePreview(e,1.5);return s.style.imageRendering="pixelated",t.appendChild(s),t}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest(".tile-item");if(s&&s.dataset.tileId){const i=parseInt(s.dataset.tileId,10);this.selectTile(i)}}),this.editor.state.on("tile:selected",e=>{const{tileId:t}=e;this.updateSelection(t)})}selectTile(e){this.selectedTileId=e,this.editor.state.setSelectedTile(e),this.updateSelection(e)}updateSelection(e){if(this.tileElements.forEach(t=>{t.classList.remove("selected")}),e!==null){const t=this.tileElements.get(e);t==null||t.classList.add("selected")}this.selectedTileId=e}getSelectedTileId(){return this.selectedTileId}}class Ts{constructor(e,t){l(this,"container");l(this,"editor");l(this,"layerElements",new Map);const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.render(),this.setupEventListeners()}render(){this.container.innerHTML="",this.layerElements.clear();const e=this.editor.level.getLayers(),t=this.editor.state.activeLayerId,s=[...e].reverse();for(const i of s){const n=this.createLayerItem(i,i.config.id===t);this.layerElements.set(i.config.id,n),this.container.appendChild(n)}}createLayerItem(e,t){const s=document.createElement("div");s.className=`layer-item${t?" active":""}`,s.dataset.layerId=e.config.id;const i=document.createElement("button");i.className="layer-visibility",i.textContent=e.config.visible?"":"",i.title=e.config.visible?"Hide layer":"Show layer",i.addEventListener("click",o=>{o.stopPropagation(),this.toggleLayerVisibility(e.config.id)});const n=document.createElement("span");n.className="layer-name",n.textContent=e.config.name;const a=document.createElement("span");return a.className="layer-count",a.textContent=String(e.tileCount),a.style.cssText="font-size: 11px; color: #666; margin-left: auto;",s.appendChild(i),s.appendChild(n),s.appendChild(a),s}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest(".layer-item");s&&s.dataset.layerId&&this.selectLayer(s.dataset.layerId)}),this.editor.state.on("layer:changed",()=>{this.updateActiveLayer()}),this.editor.history.on("change",()=>{this.updateTileCounts()}),this.editor.state.on("level:loaded",()=>{this.render()})}selectLayer(e){this.editor.state.setActiveLayer(e),this.updateActiveLayer()}toggleLayerVisibility(e){const t=this.editor.level.getLayer(e);t&&(t.toggleVisible(),this.render())}updateActiveLayer(){const e=this.editor.state.activeLayerId;this.layerElements.forEach((t,s)=>{s===e?t.classList.add("active"):t.classList.remove("active")})}updateTileCounts(){const e=this.editor.level.getLayers();for(const t of e){const s=this.layerElements.get(t.config.id);if(s){const i=s.querySelector(".layer-count");i&&(i.textContent=String(t.tileCount))}}}}const Ss=[{type:"brush",name:"Brush",icon:"",shortcut:"B"},{type:"eraser",name:"Eraser",icon:"",shortcut:"E"}];class ks{constructor(e,t){l(this,"container");l(this,"editor");l(this,"buttonElements",new Map);l(this,"fileInput");l(this,"handleFileInputChange",async()=>{var t;const e=(t=this.fileInput.files)==null?void 0:t[0];if(e)try{await this.editor.loadLevelFromFile(e)}catch(s){const i=s instanceof Error?s.message:"Unknown error";window.alert(`Failed to import level: ${i}`)}finally{this.fileInput.value=""}});const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.fileInput=this.createFileInput(),this.render(),this.container.appendChild(this.fileInput),this.setupEventListeners()}render(){this.container.innerHTML="";for(const t of Ss){const s=this.createToolButton(t);this.buttonElements.set(t.type,s),this.container.appendChild(s)}const e=document.createElement("div");e.style.cssText="width: 1px; height: 24px; background: #0f3460; margin: 0 8px;",this.container.appendChild(e),this.addActionButton("","Save (Ctrl+S)",()=>{this.editor.saveToStorage()}),this.addActionButton("","Import JSON",()=>{this.fileInput.click()}),this.addActionButton("","Download JSON",()=>{this.editor.downloadLevel()}),this.addActionButton("","Undo (Ctrl+Z)",()=>{this.editor.history.undo()}),this.addActionButton("","Redo (Ctrl+Y)",()=>{this.editor.history.redo()}),this.updateActiveButton()}createToolButton(e){const t=document.createElement("button");return t.className="tool-btn",t.dataset.tool=e.type,t.title=`${e.name} (${e.shortcut})`,t.textContent=`${e.icon} ${e.name}`,t}addActionButton(e,t,s){const i=document.createElement("button");i.className="tool-btn",i.title=t,i.textContent=e,i.addEventListener("click",s),this.container.appendChild(i)}createFileInput(){const e=document.createElement("input");return e.type="file",e.accept="application/json",e.style.display="none",e.addEventListener("change",this.handleFileInputChange),e}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest(".tool-btn[data-tool]");s&&s.dataset.tool&&this.editor.setTool(s.dataset.tool)}),this.editor.state.on("tool:changed",()=>{this.updateActiveButton()})}updateActiveButton(){const e=this.editor.state.activeTool;this.buttonElements.forEach((t,s)=>{s===e?t.classList.add("active"):t.classList.remove("active")})}}class Is{constructor(e){l(this,"positionEl");l(this,"tileEl");l(this,"layerEl");l(this,"editor");this.editor=e,this.positionEl=document.getElementById("status-position"),this.tileEl=document.getElementById("status-tile"),this.layerEl=document.getElementById("status-layer"),this.setupEventListeners(),this.update()}setupEventListeners(){this.editor.state.on("hover:changed",()=>{this.updatePosition()}),this.editor.state.on("tile:selected",()=>{this.updateTile()}),this.editor.state.on("layer:changed",()=>{this.updateLayer()})}update(){this.updatePosition(),this.updateTile(),this.updateLayer()}updatePosition(){const e=this.editor.state.hoveredCoord;e?this.positionEl.textContent=`Position: ${e.x}, ${e.y}`:this.positionEl.textContent="Position: --"}updateTile(){const e=this.editor.state.selectedTileId;e!==null?this.tileEl.textContent=`Tile: ${e}`:this.tileEl.textContent="Tile: --"}updateLayer(){const e=this.editor.state.activeLayerId;if(e){const t=this.editor.level.getLayer(e);this.layerEl.textContent=`Layer: ${(t==null?void 0:t.config.name)??e}`}else this.layerEl.textContent="Layer: --"}}class Es{constructor(e,t){l(this,"container");l(this,"editor");l(this,"zoomInput");l(this,"zoomValue");const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.zoomInput=document.createElement("input"),this.zoomValue=document.createElement("span"),this.render(),this.setupEventListeners(),this.updateZoomDisplay(this.editor.camera.zoom)}render(){this.container.innerHTML="";const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Zoom";const s=document.createElement("div");s.className="control-row",this.zoomInput.type="range",this.zoomInput.className="control-range",this.zoomInput.min=String(this.editor.camera.minZoomLevel),this.zoomInput.max=String(this.editor.camera.maxZoomLevel),this.zoomInput.step="0.1",this.zoomInput.value=String(this.editor.camera.zoom),this.zoomInput.setAttribute("aria-label","Zoom level"),this.zoomValue.className="control-value",s.appendChild(this.zoomInput),s.appendChild(this.zoomValue),e.appendChild(t),e.appendChild(s),this.container.appendChild(e)}setupEventListeners(){this.zoomInput.addEventListener("input",()=>{const e=Number(this.zoomInput.value),t=this.editor.canvas.element.getBoundingClientRect(),s=t.width/2,i=t.height/2;this.editor.camera.setZoom(e,s,i)}),this.editor.camera.onZoomChange(e=>{this.updateZoomDisplay(e)})}updateZoomDisplay(e){const t=Math.round(e*100)/100;this.zoomInput.value=String(t),this.zoomValue.textContent=`${Math.round(t*100)}%`}}const Ls=[8,16,32,64,128];class Ps{constructor(e,t){l(this,"container");l(this,"editor");l(this,"sizeButtons",new Map);l(this,"sizeMeta");l(this,"clearButton");const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.sizeMeta=document.createElement("div"),this.clearButton=document.createElement("button"),this.render(),this.setupEventListeners(),this.updateSizeDisplay()}render(){this.container.innerHTML="",this.sizeButtons.clear();const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Map Size",this.sizeMeta.className="control-meta";const s=document.createElement("div");s.className="button-group";for(const i of Ls){const n=document.createElement("button");n.type="button",n.className="tool-btn size-btn",n.dataset.size=String(i),n.textContent=`${i}x${i}`,n.setAttribute("aria-pressed","false"),this.sizeButtons.set(i,n),s.appendChild(n)}e.appendChild(t),e.appendChild(this.sizeMeta),e.appendChild(s),this.clearButton.type="button",this.clearButton.className="tool-btn danger full-width",this.clearButton.textContent="Clear All",this.clearButton.title="Clear all tiles from all layers",this.container.appendChild(e),this.container.appendChild(this.clearButton)}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest("button[data-size]");if(s!=null&&s.dataset.size){const i=Number(s.dataset.size);this.confirmResize(i);return}}),this.clearButton.addEventListener("click",()=>{this.clearAllTiles()}),this.editor.state.on("level:loaded",()=>{this.updateSizeDisplay()})}confirmResize(e){const{gridWidth:t,gridHeight:s}=this.editor.level;if(t===e&&s===e||!window.confirm(`Resize map to ${e}x${e}? This will clear all tiles and start a new level.`))return;const n=this.editor.level.metadata.name;this.editor.newLevel(n,{width:e,height:e}),this.updateSizeDisplay()}clearAllTiles(){const t=this.editor.level.getLayers().filter(a=>a.tileCount>0);if(t.length===0||!window.confirm("Clear all tiles from every layer?"))return;const i=t.map(a=>new Rt(this.editor.level,a.config.id)),n=new Mt(i,"Clear all layers");this.editor.history.execute(n),this.editor.state.markDirty()}updateSizeDisplay(){const e=this.editor.level.gridWidth,t=this.editor.level.gridHeight;this.sizeMeta.textContent=`Current: ${e}x${t}`,this.sizeButtons.forEach((s,i)=>{const n=e===t&&i===e;s.classList.toggle("active",n),s.setAttribute("aria-pressed",String(n))})}}function Os(r={x:0,y:0}){return{position:{...r},visualPosition:{x:r.x,y:r.y},state:"idle",hp:3,maxHp:3,spawnPosition:{...r},path:[],segmentIndex:0,segmentProgress:0}}function We(r){return{player:Os(r),openDoors:new Set,turnNumber:0,isStepMode:!1,waitingForStep:!1}}class D{isWalkable(e){return!0}getMovementCost(e){return 1}onEnter(e){return e.player}onStay(e){return e.player}onExit(e){return e.player}getIcon(){}}class Ms extends D{constructor(){super(...arguments);l(this,"type","floor")}getOverlayColor(){return"rgba(74, 158, 255, 0.08)"}}class Rs extends D{constructor(){super(...arguments);l(this,"type","blocker")}isWalkable(t){return!1}getMovementCost(t){return 1/0}getOverlayColor(){return"rgba(255, 74, 74, 0.45)"}}class Ns extends D{constructor(){super(...arguments);l(this,"type","slow")}getMovementCost(t){return 2.5}getOverlayColor(){return"rgba(255, 199, 94, 0.35)"}}class Ds extends D{constructor(){super(...arguments);l(this,"type","hole")}isWalkable(t){return!0}onEnter(t){return{...t.player,state:"dead",hp:0}}getOverlayColor(){return"rgba(0, 0, 0, 0.7)"}}class As extends D{constructor(){super(...arguments);l(this,"type","conveyor")}onEnter(t){const s=t.tileProperties.direction??"north",i=Tt[s],n={x:t.coord.x+i.x,y:t.coord.y+i.y};return{...t.player,pendingForcedMove:n}}getOverlayColor(){return"rgba(100, 200, 255, 0.5)"}getIcon(){return"arrow"}}class Bs extends D{constructor(){super(...arguments);l(this,"type","hazard")}onEnter(t){const s=t.tileProperties.damage??1,i=Math.max(0,t.player.hp-s);return{...t.player,hp:i,state:i<=0?"dead":t.player.state}}getOverlayColor(){return"rgba(255, 100, 50, 0.6)"}getIcon(){return"flame"}}class zs extends D{constructor(){super(...arguments);l(this,"type","door")}isWalkable(t){const s=t.tileProperties.linkedId??"default";return t.gameState.openDoors.has(s)}getMovementCost(t){return this.isWalkable(t)?1:1/0}getOverlayColor(){return"rgba(139, 69, 19, 0.7)"}}class Zs extends D{constructor(){super(...arguments);l(this,"type","exit")}onEnter(t){return{...t.player,state:"won"}}getOverlayColor(){return"rgba(100, 255, 100, 0.6)"}getIcon(){return"portal"}}class $s extends D{constructor(){super(...arguments);l(this,"type","spawn")}getOverlayColor(){return"rgba(255, 255, 100, 0.5)"}getIcon(){return"marker"}}class js{constructor(){l(this,"behaviors",new Map);l(this,"defaultBehavior");this.register(new Ms),this.register(new Rs),this.register(new Ns),this.register(new Ds),this.register(new As),this.register(new Bs),this.register(new zs),this.register(new Zs),this.register(new $s),this.defaultBehavior=this.behaviors.get("floor")}register(e){this.behaviors.set(e.type,e)}get(e){return this.behaviors.get(e)??this.defaultBehavior}getForTile(e){return e?this.get(e.type):this.defaultBehavior}getAllTypes(){return Array.from(this.behaviors.keys())}getOverlayColor(e){return this.get(e).getOverlayColor()}getIcon(e){var s;const t=this.get(e);return(s=t.getIcon)==null?void 0:s.call(t)}}let _e=null;function Fs(){return _e||(_e=new js),_e}const Ue={floor:"rgba(74, 158, 255, 0.08)",blocker:"rgba(255, 74, 74, 0.45)",slow:"rgba(255, 199, 94, 0.35)",hole:"rgba(0, 0, 0, 0.7)",conveyor:"rgba(100, 200, 255, 0.5)",hazard:"rgba(255, 100, 50, 0.6)",door:"rgba(139, 69, 19, 0.7)",exit:"rgba(100, 255, 100, 0.6)",spawn:"rgba(255, 255, 100, 0.5)"},Vs="rgba(74, 255, 158, 0.5)",Hs="rgba(74, 158, 255, 0.6)",Ge="rgba(74, 255, 158, 0.9)",Ye="rgba(255, 74, 74, 0.9)",Ws="rgba(255, 215, 0, 0.9)",Us="rgba(139, 69, 19, 0.3)",Gs="rgba(139, 69, 19, 0.7)";class Ys{constructor(e){l(this,"canvas");l(this,"camera");l(this,"renderer");l(this,"tileRegistry");l(this,"behaviorRegistry");l(this,"level");l(this,"selected",null);l(this,"hovered",null);l(this,"clickMode","move");l(this,"listeners",new Map);l(this,"animationFrame",null);l(this,"lastTimestamp",0);l(this,"isRunning",!1);l(this,"gameState");l(this,"damageFlashTimer",0);l(this,"DAMAGE_FLASH_DURATION",.3);this.tileRegistry=e.tileRegistry,this.behaviorRegistry=Fs(),this.canvas=new Qe({canvas:e.canvas,container:e.container}),this.camera=new tt({zoom:2}),this.renderer=new st(this.canvas,this.camera,this.tileRegistry),this.renderer.setOptions({showHover:!1,showSelection:!1}),this.level=H.createDefault("Movement Test"),this.gameState=We(),this.setupEventListeners(),this.resetPlayerPosition(),this.start()}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;return(s=this.listeners.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.listeners.get(e))==null||s.forEach(i=>{i(t)})}getLevel(){return this.level}getGameState(){return this.gameState}getSelectedCoord(){return this.selected}getTileProperties(e){return this.level.getGameplayTile(e)??{type:"floor"}}setClickMode(e){this.clickMode!==e&&(this.clickMode=e,this.emit("mode:changed",{mode:e}))}async loadLevelFromFile(e){const t=await mt(e);this.setLevel(t)}useLevelClone(e){const t=fe(e),s=ge(t);this.setLevel(s)}setLevel(e){this.level=e,this.selected=null,this.hovered=null,this.resetPlayer(),this.emit("selection:changed",{coord:null,properties:{type:"floor"}}),this.emit("level:changed",{level:e})}setSelectedProperties(e){this.selected&&(this.setTileProperties(this.selected,e),this.emit("selection:changed",{coord:this.selected,properties:e}))}setTileProperties(e,t){this.level.isInBounds(e)&&this.level.setGameplayTile(e,t)}isStepMode(){return this.gameState.isStepMode}setStepMode(e){this.gameState.isStepMode=e,e||(this.gameState.waitingForStep=!1),this.emit("gamestate:changed",{gameState:this.gameState})}advanceStep(){this.gameState.isStepMode&&this.gameState.waitingForStep&&(this.gameState.waitingForStep=!1)}toggleDoor(e){const t=this.gameState.openDoors.has(e);t?this.gameState.openDoors.delete(e):this.gameState.openDoors.add(e),this.emit("door:toggled",{doorId:e,isOpen:!t}),this.emit("gamestate:changed",{gameState:this.gameState})}isDoorOpen(e){return this.gameState.openDoors.has(e)}getAllDoorIds(){const e=new Set;for(const{properties:t}of this.level.getAllGameplayTiles())t.type==="door"&&t.linkedId&&e.add(t.linkedId);return Array.from(e)}resetPlayer(){const t=this.level.findSpawnTile()??this.findFirstWalkable()??{x:0,y:0};this.gameState=We(t),this.damageFlashTimer=0,this.emit("player:hp:changed",{hp:this.gameState.player.hp,maxHp:this.gameState.player.maxHp}),this.emit("player:state:changed",{state:this.gameState.player.state}),this.emit("gamestate:changed",{gameState:this.gameState})}resetPlayerPosition(){this.resetPlayer()}getPlayerHP(){return{hp:this.gameState.player.hp,maxHp:this.gameState.player.maxHp}}getPlayerState(){return this.gameState.player.state}getTurnNumber(){return this.gameState.turnNumber}start(){this.isRunning||(this.isRunning=!0,this.lastTimestamp=performance.now(),this.loop(this.lastTimestamp))}stop(){this.isRunning=!1,this.animationFrame!==null&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)}setupEventListeners(){const e=this.canvas.element;e.addEventListener("mousedown",t=>{if(t.button!==0)return;const s=this.screenToGrid(t);s&&(this.clickMode==="edit"?this.selectCoord(s):(this.selectCoord(s),this.movePlayerTo(s)))}),e.addEventListener("mousemove",t=>{const s=this.screenToGrid(t);this.hovered=s}),e.addEventListener("mouseleave",()=>{this.hovered=null}),e.addEventListener("wheel",t=>{t.preventDefault();const s=-t.deltaY*.001,i=e.getBoundingClientRect();this.camera.zoomBy(s,t.clientX-i.left,t.clientY-i.top)},{passive:!1})}selectCoord(e){this.selected=e,this.emit("selection:changed",{coord:e,properties:this.getTileProperties(e)})}screenToGrid(e){const t=this.canvas.element.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,n=this.renderer.screenToGrid(s,i,this.level);return this.level.isInBounds(n)?n:null}movePlayerTo(e){if(!this.level.isInBounds(e))return;const t=this.gameState.player;if(t.state==="dead"||t.state==="won")return;const s=this.getTileProperties(e),i=this.behaviorRegistry.get(s.type),n=this.createBehaviorContext(e,s);if(!i.isWalkable(n)){this.emit("path:updated",{hasPath:!1});return}const a={x:Math.round(t.position.x),y:Math.round(t.position.y)},o=this.findPath(a,e);if(!o||o.length===0){t.path=[],this.emit("path:updated",{hasPath:!1});return}t.path=o,t.segmentIndex=0,t.segmentProgress=0,t.state="moving",this.emit("path:updated",{hasPath:!0}),this.emit("player:state:changed",{state:"moving"})}createBehaviorContext(e,t){return{player:this.gameState.player,tileProperties:t,coord:e,gameState:this.gameState}}findPath(e,t){const s=P(e),i=P(t),n=[s],a=new Map,o=new Map([[s,0]]),d=new Map([[s,this.heuristic(e,t)]]);for(a.set(s,null);n.length>0;){n.sort((b,w)=>(d.get(b)??1/0)-(d.get(w)??1/0));const c=n.shift();if(c===i)return this.reconstructPath(a,c);const f=V(c);for(const b of this.getNeighbors(f)){const w=P(b),L=this.getTileProperties(b),re=this.behaviorRegistry.get(L.type),ae=this.createBehaviorContext(b,L);if(!re.isWalkable(ae))continue;const pt=re.getMovementCost(ae),ye=(o.get(c)??1/0)+pt;ye<(o.get(w)??1/0)&&(a.set(w,c),o.set(w,ye),d.set(w,ye+this.heuristic(b,t)),n.includes(w)||n.push(w))}}return null}heuristic(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}reconstructPath(e,t){const s=[V(t)];let i=e.get(t);for(;i;)s.push(V(i)),i=e.get(i);return s.reverse()}getNeighbors(e){return[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].filter(s=>this.level.isInBounds(s))}loop(e){if(!this.isRunning)return;const t=e-this.lastTimestamp;this.lastTimestamp=e,this.update(t/1e3),this.render(),this.animationFrame=requestAnimationFrame(s=>this.loop(s))}update(e){this.damageFlashTimer>0&&(this.damageFlashTimer=Math.max(0,this.damageFlashTimer-e));const t=this.gameState.player;if(t.state==="dead"||t.state==="won"||this.gameState.isStepMode&&this.gameState.waitingForStep||t.state!=="moving"||t.path.length<2)return;const s=t.segmentIndex,i=s+1,n=t.path[s],a=t.path[i];if(!n||!a){t.state="idle",this.emit("player:state:changed",{state:"idle"}),this.emit("path:updated",{hasPath:!1});return}const o=this.getTileProperties(a),d=this.behaviorRegistry.get(o.type),c=this.createBehaviorContext(a,o),b=.25*d.getMovementCost(c);if(t.segmentProgress+=e/b,t.segmentProgress>=1){if(t.position={x:a.x,y:a.y},t.visualPosition={x:a.x,y:a.y},t.segmentIndex=i,t.segmentProgress=0,this.applyTileEffect(a),this.gameState.player.state==="dead"||this.gameState.player.state==="won"){this.gameState.player.path=[];return}if(t.pendingForcedMove){const w=t.pendingForcedMove;if(t.pendingForcedMove=void 0,this.level.isInBounds(w)){const L=this.getTileProperties(w),re=this.behaviorRegistry.get(L.type),ae=this.createBehaviorContext(w,L);if(re.isWalkable(ae)){t.path=[t.position,w],t.segmentIndex=0,t.segmentProgress=0;return}}}i>=t.path.length-1&&(t.state="idle",t.path=[a],this.emit("player:state:changed",{state:"idle"}),this.emit("path:updated",{hasPath:!1}),this.gameState.isStepMode&&(this.gameState.turnNumber++,this.gameState.waitingForStep=!0,this.emit("step:completed",{turnNumber:this.gameState.turnNumber}),this.emit("gamestate:changed",{gameState:this.gameState})))}else{const w=t.segmentProgress;t.visualPosition={x:n.x+(a.x-n.x)*w,y:n.y+(a.y-n.y)*w}}}applyTileEffect(e){const t=this.getTileProperties(e),s=this.behaviorRegistry.get(t.type),i=this.createBehaviorContext(e,t),n=this.gameState.player.hp,a=this.gameState.player.state;if(this.gameState.player=s.onEnter(i),this.gameState.player.hp<n){const o=n-this.gameState.player.hp;this.damageFlashTimer=this.DAMAGE_FLASH_DURATION,this.emit("player:hp:changed",{hp:this.gameState.player.hp,maxHp:this.gameState.player.maxHp,damage:o})}this.gameState.player.state!==a&&(this.emit("player:state:changed",{state:this.gameState.player.state}),this.gameState.player.state==="dead"?this.emit("player:died",{cause:t.type}):this.gameState.player.state==="won"&&this.emit("player:won",void 0))}render(){this.renderer.render(this.level);const e=this.canvas.ctx;e.save(),this.camera.applyTransform(e);const t=le(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,this.level.gridWidth,this.level.gridHeight);this.renderTileOverlays(e,t.x,t.y),this.renderSelection(e,t.x,t.y),this.renderPath(e,t.x,t.y),this.renderPlayer(e,t.x,t.y),e.restore(),this.renderHPDisplay()}renderTileOverlays(e,t,s){for(let i=0;i<this.level.gridHeight;i++)for(let n=0;n<this.level.gridWidth;n++){const a={x:n,y:i},o=this.getTileProperties(a);let d=Ue[o.type]??Ue.floor;if(o.type==="door"){const c=o.linkedId??"default";d=this.gameState.openDoors.has(c)?Us:Gs}this.drawDiamond(e,a,t,s,d),o.type==="conveyor"&&o.direction&&this.drawConveyorArrow(e,a,o.direction,t,s),o.type==="hazard"?this.drawTileIcon(e,a,"flame",t,s):o.type==="exit"?this.drawTileIcon(e,a,"star",t,s):o.type==="spawn"&&this.drawTileIcon(e,a,"circle",t,s)}}renderSelection(e,t,s){this.selected&&this.drawDiamond(e,this.selected,t,s,Vs)}renderPath(e,t,s){const i=this.gameState.player;if(i.path.length){e.strokeStyle=Hs,e.lineWidth=2,e.beginPath();for(let n=0;n<i.path.length;n++){const a=i.path[n];if(!a)continue;const o=S(a.x,a.y,t,s);n===0?e.moveTo(o.x,o.y+C/2):e.lineTo(o.x,o.y+C/2)}e.stroke()}}renderPlayer(e,t,s){const i=this.gameState.player,n=S(i.visualPosition.x,i.visualPosition.y,t,s);let a=Ge;if(i.state==="dead"?a=Ye:i.state==="won"?a=Ws:this.damageFlashTimer>0&&(a=Math.floor(this.damageFlashTimer*10)%2===0?Ye:Ge),e.fillStyle=a,e.beginPath(),e.arc(n.x,n.y+C/2,k/4,0,Math.PI*2),e.fill(),i.state==="dead"){e.strokeStyle="#fff",e.lineWidth=2;const o=k/6;e.beginPath(),e.moveTo(n.x-o,n.y+C/2-o),e.lineTo(n.x+o,n.y+C/2+o),e.moveTo(n.x+o,n.y+C/2-o),e.lineTo(n.x-o,n.y+C/2+o),e.stroke()}}renderHPDisplay(){const e=this.canvas.ctx,t=this.gameState.player;e.save(),e.font="14px monospace";const s=`HP: ${t.hp}/${t.maxHp}`;if(e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(8,8,80,24),e.fillStyle=t.hp<=1?"#ff4a4a":"#4aff9e",e.fillText(s,14,24),this.gameState.isStepMode){const i=`Turn: ${this.gameState.turnNumber}`;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(8,36,80,24),e.fillStyle="#fff",e.fillText(i,14,52),this.gameState.waitingForStep&&(e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(8,64,100,24),e.fillStyle="#ffc75e",e.fillText("Waiting...",14,80))}t.state==="dead"?(e.fillStyle="rgba(255, 74, 74, 0.9)",e.font="bold 24px monospace",e.fillText("DEAD",this.canvas.viewport.width/2-40,this.canvas.viewport.height/2)):t.state==="won"&&(e.fillStyle="rgba(255, 215, 0, 0.9)",e.font="bold 24px monospace",e.fillText("WIN!",this.canvas.viewport.width/2-40,this.canvas.viewport.height/2)),e.restore()}drawDiamond(e,t,s,i,n){const a=S(t.x,t.y,s,i);e.fillStyle=n,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(a.x+k/2,a.y+C/2),e.lineTo(a.x,a.y+C),e.lineTo(a.x-k/2,a.y+C/2),e.closePath(),e.fill()}drawConveyorArrow(e,t,s,i,n){const a=S(t.x,t.y,i,n),o=a.x,d=a.y+C/2;e.save(),e.translate(o,d);const c={north:-Math.PI/2,east:0,south:Math.PI/2,west:Math.PI};e.rotate(c[s]),e.strokeStyle="#fff",e.lineWidth=2,e.beginPath(),e.moveTo(-4,0),e.lineTo(4,0),e.lineTo(1,-3),e.moveTo(4,0),e.lineTo(1,3),e.stroke(),e.restore()}drawTileIcon(e,t,s,i,n){const a=S(t.x,t.y,i,n),o=a.x,d=a.y+C/2;if(e.save(),s==="flame")e.fillStyle="#ff6600",e.beginPath(),e.moveTo(o,d-4),e.bezierCurveTo(o-3,d-2,o-3,d+2,o,d+4),e.bezierCurveTo(o+3,d+2,o+3,d-2,o,d-4),e.fill();else if(s==="star"){e.fillStyle="#00ff00",e.beginPath();for(let c=0;c<5;c++){const f=c*4*Math.PI/5-Math.PI/2,b=c%2===0?4:2,w=o+Math.cos(f)*b,L=d+Math.sin(f)*b;c===0?e.moveTo(w,L):e.lineTo(w,L)}e.closePath(),e.fill()}else s==="circle"&&(e.strokeStyle="#ffff00",e.lineWidth=2,e.beginPath(),e.arc(o,d,4,0,Math.PI*2),e.stroke());e.restore()}findFirstWalkable(){for(let e=0;e<this.level.gridHeight;e++)for(let t=0;t<this.level.gridWidth;t++){const s={x:t,y:e},i=this.getTileProperties(s),n=this.behaviorRegistry.get(i.type),a=this.createBehaviorContext(s,i);if(n.isWalkable(a))return s}return null}}const qe=[{type:"floor",label:"Floor",color:"#4a9eff"},{type:"blocker",label:"Blocker",color:"#ff4a4a"},{type:"slow",label:"Slow",color:"#ffc75e"},{type:"hole",label:"Hole",color:"#000000"},{type:"conveyor",label:"Conveyor",color:"#64c8ff"},{type:"hazard",label:"Hazard",color:"#ff6432"},{type:"door",label:"Door",color:"#8b4513"},{type:"exit",label:"Exit",color:"#64ff64"},{type:"spawn",label:"Spawn",color:"#ffff64"}],qs=[{dir:"north",label:"North",arrow:""},{dir:"east",label:"East",arrow:""},{dir:"south",label:"South",arrow:""},{dir:"west",label:"West",arrow:""}];class Ks{constructor(e,t,s){l(this,"container");l(this,"tester");l(this,"editor");l(this,"fileInput");l(this,"modeButtons",new Map);l(this,"typeButtons",new Map);l(this,"directionButtons",new Map);l(this,"selectionLabel");l(this,"typeLabel");l(this,"pathLabel");l(this,"hpLabel");l(this,"turnLabel");l(this,"stateLabel");l(this,"propertiesPanel");l(this,"directionPanel");l(this,"linkedIdInput");l(this,"linkedIdPanel");l(this,"damageInput");l(this,"damagePanel");l(this,"stepModeBtn");l(this,"advanceStepBtn");l(this,"resetBtn");l(this,"doorControlsPanel");l(this,"currentType","floor");l(this,"currentDirection","north");l(this,"currentLinkedId","door1");l(this,"currentDamage",1);const i=document.getElementById(e);if(!i)throw new Error(`Container not found: ${e}`);this.container=i,this.tester=t,this.editor=s,this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".json,application/json",this.fileInput.style.display="none",this.selectionLabel=document.createElement("div"),this.typeLabel=document.createElement("div"),this.pathLabel=document.createElement("div"),this.hpLabel=document.createElement("div"),this.turnLabel=document.createElement("div"),this.stateLabel=document.createElement("div"),this.propertiesPanel=document.createElement("div"),this.directionPanel=document.createElement("div"),this.linkedIdInput=document.createElement("input"),this.linkedIdPanel=document.createElement("div"),this.damageInput=document.createElement("input"),this.damagePanel=document.createElement("div"),this.stepModeBtn=document.createElement("button"),this.advanceStepBtn=document.createElement("button"),this.resetBtn=document.createElement("button"),this.doorControlsPanel=document.createElement("div"),this.render(),this.setupListeners()}render(){this.container.innerHTML="",this.container.appendChild(this.fileInput),this.container.appendChild(this.renderLoadSection()),this.container.appendChild(this.renderModeSection()),this.container.appendChild(this.renderTileTypeSection()),this.container.appendChild(this.renderPropertiesSection()),this.container.appendChild(this.renderGameControlsSection()),this.container.appendChild(this.renderDoorControlsSection()),this.container.appendChild(this.renderLegendSection()),this.container.appendChild(this.renderStatusSection())}renderLoadSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Map Input";const s=document.createElement("button");s.className="tool-btn full-width",s.type="button",s.textContent="Load Map JSON",s.addEventListener("click",()=>this.fileInput.click());const i=document.createElement("button");return i.className="tool-btn full-width",i.type="button",i.textContent="Use Current Editor Map",i.addEventListener("click",()=>{this.tester.useLevelClone(this.editor.level)}),e.appendChild(t),e.appendChild(s),e.appendChild(i),e}renderModeSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Click Mode";const s=document.createElement("div");return s.className="button-group",this.addModeButton(s,"move","Move Player"),this.addModeButton(s,"edit","Edit Tiles"),e.appendChild(t),e.appendChild(s),e}addModeButton(e,t,s){const i=document.createElement("button");i.type="button",i.className="tool-btn small",i.dataset.mode=t,i.textContent=s,i.addEventListener("click",()=>{this.tester.setClickMode(t),this.updateModeButtons(t)}),this.modeButtons.set(t,i),e.appendChild(i)}renderTileTypeSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Tile Type";const s=document.createElement("div");s.className="tile-type-grid",s.style.display="grid",s.style.gridTemplateColumns="repeat(3, 1fr)",s.style.gap="4px";for(const{type:i,label:n,color:a}of qe){const o=document.createElement("button");o.type="button",o.className="tool-btn small",o.textContent=n,o.style.borderLeft=`4px solid ${a}`,o.addEventListener("click",()=>this.selectTileType(i)),this.typeButtons.set(i,o),s.appendChild(o)}return e.appendChild(t),e.appendChild(s),e}renderPropertiesSection(){this.propertiesPanel.className="control-group",this.propertiesPanel.style.display="none";const e=document.createElement("div");e.className="control-label",e.textContent="Tile Properties",this.directionPanel.className="direction-panel",this.directionPanel.style.display="none";const t=document.createElement("div");t.className="control-meta",t.textContent="Direction:";const s=document.createElement("div");s.className="button-group";for(const{dir:a,arrow:o}of qs){const d=document.createElement("button");d.type="button",d.className="tool-btn small",d.textContent=o,d.title=a,d.addEventListener("click",()=>this.selectDirection(a)),this.directionButtons.set(a,d),s.appendChild(d)}this.directionPanel.appendChild(t),this.directionPanel.appendChild(s),this.linkedIdPanel.className="linked-id-panel",this.linkedIdPanel.style.display="none";const i=document.createElement("div");i.className="control-meta",i.textContent="Door ID:",this.linkedIdInput.type="text",this.linkedIdInput.className="input-field",this.linkedIdInput.placeholder="door1",this.linkedIdInput.value=this.currentLinkedId,this.linkedIdInput.style.width="100%",this.linkedIdInput.addEventListener("input",()=>{this.currentLinkedId=this.linkedIdInput.value||"door1",this.applyCurrentProperties()}),this.linkedIdPanel.appendChild(i),this.linkedIdPanel.appendChild(this.linkedIdInput),this.damagePanel.className="damage-panel",this.damagePanel.style.display="none";const n=document.createElement("div");return n.className="control-meta",n.textContent="Damage:",this.damageInput.type="number",this.damageInput.className="input-field",this.damageInput.min="1",this.damageInput.max="10",this.damageInput.value="1",this.damageInput.style.width="60px",this.damageInput.addEventListener("input",()=>{this.currentDamage=parseInt(this.damageInput.value)||1,this.applyCurrentProperties()}),this.damagePanel.appendChild(n),this.damagePanel.appendChild(this.damageInput),this.propertiesPanel.appendChild(e),this.propertiesPanel.appendChild(this.directionPanel),this.propertiesPanel.appendChild(this.linkedIdPanel),this.propertiesPanel.appendChild(this.damagePanel),this.propertiesPanel}renderGameControlsSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Game Controls";const s=document.createElement("div");return s.className="button-group-vertical",s.style.display="flex",s.style.flexDirection="column",s.style.gap="4px",this.stepModeBtn.type="button",this.stepModeBtn.className="tool-btn full-width",this.stepModeBtn.textContent="Step Mode: OFF",this.stepModeBtn.addEventListener("click",()=>{const i=this.tester.isStepMode();this.tester.setStepMode(!i),this.updateStepModeButton(!i)}),this.advanceStepBtn.type="button",this.advanceStepBtn.className="tool-btn full-width",this.advanceStepBtn.textContent="Advance Step",this.advanceStepBtn.disabled=!0,this.advanceStepBtn.addEventListener("click",()=>{this.tester.advanceStep()}),this.resetBtn.type="button",this.resetBtn.className="tool-btn full-width",this.resetBtn.textContent="Reset Player",this.resetBtn.addEventListener("click",()=>{this.tester.resetPlayer()}),s.appendChild(this.stepModeBtn),s.appendChild(this.advanceStepBtn),s.appendChild(this.resetBtn),e.appendChild(t),e.appendChild(s),e}renderDoorControlsSection(){this.doorControlsPanel.className="control-group";const e=document.createElement("div");e.className="control-label",e.textContent="Door Controls";const t=document.createElement("div");return t.className="control-meta",t.textContent="No doors on map",t.id="door-hint",this.doorControlsPanel.appendChild(e),this.doorControlsPanel.appendChild(t),this.doorControlsPanel}renderLegendSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Legend";const s=document.createElement("div");s.className="legend-grid";for(const{label:i,color:n}of qe)s.appendChild(this.createLegendRow(i,n));return e.appendChild(t),e.appendChild(s),e}createLegendRow(e,t){const s=document.createElement("div");s.className="kind-row";const i=document.createElement("span");i.className="kind-indicator",i.style.backgroundColor=t;const n=document.createElement("span");return n.textContent=e,s.appendChild(i),s.appendChild(n),s}renderStatusSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");return t.className="control-label",t.textContent="Status",this.selectionLabel.className="control-meta",this.typeLabel.className="control-meta",this.pathLabel.className="control-meta",this.hpLabel.className="control-meta",this.turnLabel.className="control-meta",this.stateLabel.className="control-meta",e.appendChild(t),e.appendChild(this.selectionLabel),e.appendChild(this.typeLabel),e.appendChild(this.hpLabel),e.appendChild(this.stateLabel),e.appendChild(this.turnLabel),e.appendChild(this.pathLabel),this.updateSelectionStatus(null,{type:"floor"}),this.updateHPStatus(3,3),this.updateStateStatus("idle"),this.updateTurnStatus(0),this.updatePathStatus(!1),e}setupListeners(){this.fileInput.addEventListener("change",async()=>{var t;const e=(t=this.fileInput.files)==null?void 0:t[0];if(e)try{await this.tester.loadLevelFromFile(e)}finally{this.fileInput.value=""}}),this.tester.on("selection:changed",({coord:e,properties:t})=>{this.updateSelectionStatus(e,t),this.selectTileType(t.type,!1),t.direction&&this.selectDirection(t.direction,!1),t.linkedId&&(this.linkedIdInput.value=t.linkedId,this.currentLinkedId=t.linkedId),t.damage&&(this.damageInput.value=String(t.damage),this.currentDamage=t.damage)}),this.tester.on("mode:changed",({mode:e})=>{this.updateModeButtons(e)}),this.tester.on("level:changed",()=>{this.updateSelectionStatus(null,{type:"floor"}),this.updatePathStatus(!1),this.updateDoorControls()}),this.tester.on("path:updated",({hasPath:e})=>{this.updatePathStatus(e)}),this.tester.on("player:hp:changed",({hp:e,maxHp:t})=>{this.updateHPStatus(e,t)}),this.tester.on("player:state:changed",({state:e})=>{this.updateStateStatus(e)}),this.tester.on("gamestate:changed",({gameState:e})=>{this.updateTurnStatus(e.turnNumber),this.advanceStepBtn.disabled=!e.isStepMode||!e.waitingForStep,this.updateDoorControls()}),this.updateModeButtons("move"),this.selectTileType("floor",!1),this.selectDirection("north",!1)}selectTileType(e,t=!0){this.currentType=e,this.typeButtons.forEach((i,n)=>{const a=n===e;i.classList.toggle("active",a),i.setAttribute("aria-pressed",String(a))});const s=e==="conveyor"||e==="door"||e==="hazard";this.propertiesPanel.style.display=s?"block":"none",this.directionPanel.style.display=e==="conveyor"?"block":"none",this.linkedIdPanel.style.display=e==="door"?"block":"none",this.damagePanel.style.display=e==="hazard"?"block":"none",t&&this.applyCurrentProperties()}selectDirection(e,t=!0){this.currentDirection=e,this.directionButtons.forEach((s,i)=>{const n=i===e;s.classList.toggle("active",n),s.setAttribute("aria-pressed",String(n))}),t&&this.applyCurrentProperties()}applyCurrentProperties(){if(!this.tester.getSelectedCoord())return;const t={type:this.currentType,direction:this.currentType==="conveyor"?this.currentDirection:void 0,linkedId:this.currentType==="door"?this.currentLinkedId:void 0,damage:this.currentType==="hazard"?this.currentDamage:void 0};this.tester.setSelectedProperties(t),this.updateDoorControls()}updateModeButtons(e){this.modeButtons.forEach((t,s)=>{const i=s===e;t.classList.toggle("active",i),t.setAttribute("aria-pressed",String(i))})}updateSelectionStatus(e,t){e?this.selectionLabel.textContent=`Tile: ${e.x}, ${e.y}`:this.selectionLabel.textContent="Tile: --",this.typeLabel.textContent=`Type: ${t.type}`}updateHPStatus(e,t){this.hpLabel.textContent=`HP: ${e}/${t}`,this.hpLabel.style.color=e<=1?"#ff4a4a":"#4aff9e"}updateStateStatus(e){const t={idle:"Idle",moving:"Moving",dead:"DEAD",won:"WON!"};this.stateLabel.textContent=`State: ${t[e]}`,e==="dead"?this.stateLabel.style.color="#ff4a4a":e==="won"?this.stateLabel.style.color="#ffd700":this.stateLabel.style.color=""}updateTurnStatus(e){this.turnLabel.textContent=`Turn: ${e}`}updatePathStatus(e){this.pathLabel.textContent=e?"Path: ready":"Path: none"}updateStepModeButton(e){this.stepModeBtn.textContent=`Step Mode: ${e?"ON":"OFF"}`,this.stepModeBtn.classList.toggle("active",e)}updateDoorControls(){const e=this.tester.getAllDoorIds();for(;this.doorControlsPanel.children.length>1;)this.doorControlsPanel.removeChild(this.doorControlsPanel.lastChild);if(e.length===0){const s=document.createElement("div");s.className="control-meta",s.textContent="No doors on map",this.doorControlsPanel.appendChild(s);return}const t=document.createElement("div");t.className="button-group-vertical",t.style.display="flex",t.style.flexDirection="column",t.style.gap="4px";for(const s of e){const i=this.tester.isDoorOpen(s),n=document.createElement("button");n.type="button",n.className="tool-btn full-width",n.textContent=`${s}: ${i?"OPEN":"CLOSED"}`,n.classList.toggle("active",i),n.addEventListener("click",()=>{this.tester.toggleDoor(s),this.updateDoorControls()}),t.appendChild(n)}this.doorControlsPanel.appendChild(t)}}async function Ke(){console.log("Initializing Isometric Level Editor...");const r=document.createElement("div");r.id="loading",r.style.cssText=`
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    color: #4a9eff;
    z-index: 1000;
  `,r.textContent="Loading assets...",document.body.appendChild(r);try{const e=new Ct;await e.initialize(),console.log(`Loaded ${e.getTileCount()} tiles`);const t=new ws({canvas:"#editor-canvas",container:"#canvas-stack"},e),s=t.loadFromStorage();console.log(s?"Loaded level from localStorage":"Created new default level");const i=new ks("toolbar",t),n=new Es("view-controls",t),a=new Ps("map-controls",t),o=new Ts("layer-list",t),d=new Cs("tile-palette",t,e),c=new Is(t),f=new Ys({canvas:"#movement-canvas",container:"#canvas-stack",tileRegistry:e}),b=new Ks("movement-controls",f,t);d.selectTile(0),t.start(),f.start(),Js(),window.editor=t,r.remove(),console.log("Editor initialized successfully!"),console.log("Controls:"),console.log("  - Click to place tiles"),console.log("  - B: Brush tool"),console.log("  - E: Eraser tool"),console.log("  - Ctrl+Z: Undo"),console.log("  - Ctrl+Y/Ctrl+Shift+Z: Redo"),console.log("  - Ctrl+S: Save to localStorage"),console.log("  - Mouse wheel: Zoom")}catch(e){console.error("Failed to initialize editor:",e),r.textContent=`Error: ${e instanceof Error?e.message:"Unknown error"}`,r.style.color="#ff4a4a"}}function Js(){const r=document.getElementById("canvas-mode-toggle"),e=document.getElementById("sidebar-active-title"),t=document.getElementById("editor-canvas"),s=document.getElementById("movement-canvas"),i=document.getElementById("editor-pane"),n=document.getElementById("movement-pane");if(!r||!t||!s||!i||!n)return;const a=o=>{const d=o==="editor";t.classList.toggle("inactive",!d),s.classList.toggle("inactive",d),i.classList.toggle("active",d),n.classList.toggle("active",!d),r.querySelectorAll("button[data-canvas]").forEach(c=>{const f=c.dataset.canvas;c.classList.toggle("active",f===o)}),e&&(e.textContent=d?"Map Editor":"Movement Tester")};r.addEventListener("click",o=>{const c=o.target.closest("button[data-canvas]");if(!c)return;const f=c.dataset.canvas==="movement"?"movement":"editor";a(f)}),a("editor")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ke):Ke();
