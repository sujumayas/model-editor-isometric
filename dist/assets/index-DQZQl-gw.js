var ct=Object.defineProperty;var ht=(n,e,t)=>e in n?ct(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var l=(n,e,t)=>ht(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const W=32,N=32,S=32,C=16,Ge=8,qe=8,ut="isometric tileset/spritesheet.png",oe=115,pt=[{id:"terrain",name:"Terrain",zIndex:0},{id:"props",name:"Props",zIndex:10},{id:"decorations",name:"Decorations",zIndex:20}],Ee="rgba(255, 255, 255, 0.1)",mt="rgba(74, 255, 158, 0.5)",ft="rgba(74, 158, 255, 0.3)";function yt(n){return new Promise((e,t)=>{const s=new Image;s.onload=()=>e(s),s.onerror=()=>t(new Error(`Failed to load image: ${n}`)),s.src=n})}async function gt(n){return yt(n)}const Le=11,Ie=[{id:"dirt",name:"Dirt/Soil",startId:0,endId:19},{id:"grass-transition",name:"Grass Transition",startId:20,endId:28},{id:"vegetation",name:"Vegetation",startId:29,endId:39},{id:"props",name:"Props",startId:40,endId:59},{id:"rocks-brown",name:"Brown Rocks",startId:60,endId:66},{id:"rocks-gray",name:"Gray Rocks",startId:67,endId:81},{id:"ice",name:"Ice/Snow",startId:82,endId:89},{id:"water-deep",name:"Deep Water",startId:90,endId:99},{id:"water-shallow",name:"Shallow Water",startId:100,endId:114}];class vt{constructor(){l(this,"spritesheet",null);l(this,"uvCache",new Map);l(this,"_isReady",!1)}async initialize(){this.spritesheet=await gt(ut),this.buildUVCache(),this._isReady=!0}get isReady(){return this._isReady}getSpritesheet(){if(!this.spritesheet)throw new Error("TileRegistry not initialized. Call initialize() first.");return this.spritesheet}getTileUV(e){const t=this.uvCache.get(e);if(!t)throw new Error(`Invalid tile ID: ${e}`);return t}isValidTileId(e){return e>=0&&e<oe}getTileCount(){return oe}getAllTileIds(){return Array.from({length:oe},(e,t)=>t)}getTilesByCategory(e){const t=Ie.find(i=>i.id===e);if(!t)return[];const s=[];for(let i=t.startId;i<=t.endId;i++)s.push(i);return s}getCategoryForTile(e){return Ie.find(t=>e>=t.startId&&e<=t.endId)}buildUVCache(){for(let e=0;e<oe;e++){const t=e%Le,s=Math.floor(e/Le);this.uvCache.set(e,{x:t*W,y:s*N,width:W,height:N})}}drawTile(e,t,s,i,a=1){if(!this.spritesheet)throw new Error("TileRegistry not initialized");const r=this.getTileUV(t),o=W*a,d=N*a;e.drawImage(this.spritesheet,r.x,r.y,r.width,r.height,s,i,o,d)}createTilePreview(e,t=1){const s=document.createElement("canvas");s.width=W*t,s.height=N*t;const i=s.getContext("2d");return i&&(i.imageSmoothingEnabled=!1,this.drawTile(i,e,0,0,t)),s}}function K(n){return`${n.x},${n.y}`}function Ye(n){const[e,t]=n.split(",").map(Number);return{x:e,y:t}}class ie{constructor(e){l(this,"config");l(this,"tiles",new Map);this.config={visible:!0,locked:!1,opacity:1,...e}}getTile(e){const t=K(e);return this.tiles.get(t)??null}setTile(e,t){const s=K(e);this.tiles.set(s,t)}removeTile(e){const t=K(e);return this.tiles.delete(t)}hasTile(e){const t=K(e);return this.tiles.has(t)}get tileCount(){return this.tiles.size}clear(){this.tiles.clear()}forEachTile(e){this.tiles.forEach((t,s)=>{const i=Ye(s);e(t,i)})}getAllTiles(){const e=[];return this.forEachTile((t,s)=>{e.push({tile:t,coord:s})}),e}setVisible(e){this.config.visible=e}toggleVisible(){this.config.visible=!this.config.visible}setLocked(e){this.config.locked=e}setOpacity(e){this.config.opacity=Math.max(0,Math.min(1,e))}clone(){const e=new ie({...this.config});return this.tiles.forEach((t,s)=>{e.tiles.set(s,{...t})}),e}toData(){const e=[];return this.forEachTile((t,s)=>{e.push({tileId:t.tileId,position:s,rotation:t.rotation})}),{id:this.config.id,name:this.config.name,zIndex:this.config.zIndex,visible:this.config.visible,tiles:e}}static fromData(e){const t=new ie({id:e.id,name:e.name,zIndex:e.zIndex,visible:e.visible});for(const s of e.tiles)t.setTile(s.position,{tileId:s.tileId,rotation:s.rotation});return t}}class Z{constructor(e={},t={}){l(this,"metadata");l(this,"gridConfig");l(this,"layers",[]);l(this,"layerMap",new Map);l(this,"tileBehaviors",new Map);this.metadata={id:e.id??crypto.randomUUID(),name:e.name??"Untitled Level",author:e.author,created:e.created??new Date().toISOString(),modified:e.modified??new Date().toISOString(),version:e.version??1},this.gridConfig={width:t.width??Ge,height:t.height??qe,tileWidth:t.tileWidth??W,tileHeight:t.tileHeight??N}}get gridWidth(){return this.gridConfig.width}get gridHeight(){return this.gridConfig.height}getLayers(){return this.layers}getVisibleLayers(){return this.layers.filter(e=>e.config.visible).sort((e,t)=>e.config.zIndex-t.config.zIndex)}getLayer(e){return this.layerMap.get(e)}getLayerByIndex(e){return this.layers[e]}getTileBehavior(e){const t=K(e);return this.tileBehaviors.get(t)??null}setTileBehavior(e,t){const s=K(e);if(!t||t.type==="floor"){this.tileBehaviors.delete(s);return}this.tileBehaviors.set(s,{...t})}clearTileBehaviors(){this.tileBehaviors.clear()}forEachTileBehavior(e){this.tileBehaviors.forEach((t,s)=>{e({position:Ye(s),...t})})}getTileBehaviors(){const e=[];return this.forEachTileBehavior(t=>e.push(t)),e}addLayer(e){if(this.layerMap.has(e.config.id))throw new Error(`Layer with id "${e.config.id}" already exists`);this.layers.push(e),this.layerMap.set(e.config.id,e),this.sortLayers()}removeLayer(e){const t=this.layers.findIndex(s=>s.config.id===e);return t===-1?!1:(this.layers.splice(t,1),this.layerMap.delete(e),!0)}sortLayers(){this.layers.sort((e,t)=>e.config.zIndex-t.config.zIndex)}isInBounds(e){return e.x>=0&&e.x<this.gridConfig.width&&e.y>=0&&e.y<this.gridConfig.height}getTile(e,t){const s=this.layerMap.get(e);return s?s.getTile(t):null}setTile(e,t,s){if(!this.isInBounds(t))return!1;const i=this.layerMap.get(e);return!i||i.config.locked?!1:(i.setTile(t,s),!0)}removeTile(e,t){const s=this.layerMap.get(e);return!s||s.config.locked?!1:s.removeTile(t)}getTopTileAt(e){const t=this.getVisibleLayers().reverse();for(const s of t){const i=s.getTile(e);if(i)return{tile:i,layerId:s.config.id}}return null}touch(){this.metadata.modified=new Date().toISOString()}toData(){return{version:1,metadata:{...this.metadata},grid:{...this.gridConfig},layers:this.layers.map(e=>e.toData()),tileBehaviors:this.getTileBehaviors()}}static fromData(e){const t=new Z(e.metadata,e.grid);for(const s of e.layers){const i=ie.fromData(s);t.addLayer(i)}if(e.tileBehaviors)for(const s of e.tileBehaviors)t.setTileBehavior(s.position,s);return t}static createDefault(e="Untitled Level",t={}){const s=new Z({name:e},t);for(const i of pt){const a=new ie({id:i.id,name:i.name,zIndex:i.zIndex});s.addLayer(a)}return s}}class Xe{constructor(e){l(this,"element");l(this,"ctx");l(this,"container");l(this,"handleDPR");l(this,"backgroundColor");l(this,"resizeObserver",null);l(this,"_viewport",{width:0,height:0});l(this,"_dpr",1);if(typeof e.canvas=="string"){const s=document.querySelector(e.canvas);if(!s)throw new Error(`Canvas not found: ${e.canvas}`);this.element=s}else this.element=e.canvas;const t=this.element.getContext("2d");if(!t)throw new Error("Failed to get 2d context");if(this.ctx=t,e.container)if(typeof e.container=="string"){const s=document.querySelector(e.container);if(!s)throw new Error(`Container not found: ${e.container}`);this.container=s}else this.container=e.container;else this.container=this.element.parentElement||document.body;this.handleDPR=e.handleDPR??!0,this.backgroundColor=e.backgroundColor??"#0f0f23",this.updateSize(),this.setupResizeObserver()}get viewport(){return this._viewport}get dpr(){return this._dpr}updateSize(){const e=this.container.getBoundingClientRect();this._dpr=this.handleDPR&&window.devicePixelRatio||1,this.element.style.width=`${e.width}px`,this.element.style.height=`${e.height}px`,this.element.width=e.width*this._dpr,this.element.height=e.height*this._dpr,this._viewport={width:e.width,height:e.height},this.handleDPR&&this.ctx.scale(this._dpr,this._dpr),this.ctx.imageSmoothingEnabled=!1}setupResizeObserver(){this.resizeObserver=new ResizeObserver(()=>{this.updateSize()}),this.resizeObserver.observe(this.container)}clear(){this.ctx.setTransform(1,0,0,1,0,0),this.handleDPR&&this.ctx.scale(this._dpr,this._dpr),this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this._viewport.width,this._viewport.height)}dispose(){var e;(e=this.resizeObserver)==null||e.disconnect(),this.resizeObserver=null}}function I(n,e,t=0,s=0){return{x:(n-e)*(S/2)+t,y:(n+e)*(C/2)+s}}function G(n,e,t=0,s=0){const i=n-t,a=e-s,r=(i/(S/2)+a/(C/2))/2,o=(a/(C/2)-i/(S/2))/2;return{x:Math.floor(r),y:Math.floor(o)}}function Je(n,e,t=0){return t*1e4+(n+e)}function xt(n,e,t,s){const i=I(n,e,t,s),a=N-C;return{x:i.x-W/2,y:i.y-a}}function _t(n,e,t,s,i,a){const r=G(0,0,t,s),o=G(n,0,t,s),d=G(0,e,t,s),c=G(n,e,t,s),f=Math.max(0,Math.min(r.x,d.x)-1),b=Math.min(i-1,Math.max(o.x,c.x)+1),E=Math.max(0,Math.min(r.y,o.y)-1),re=Math.min(a-1,Math.max(d.y,c.y)+1);return{minX:f,minY:E,maxX:b,maxY:re}}function le(n,e,t,s){const i=I(0,0),a=I(t-1,0),r=I(0,s-1),o=I(t-1,s-1),d=a.x-r.x+S,c=o.y-i.y+N;return{x:(n-d)/2+(t-1)*(S/2),y:(e-c)/2+N/2}}function bt(n,e){const t=[];for(let s=n.minY;s<=n.maxY;s++)for(let i=n.minX;i<=n.maxX;i++)t.push({x:i,y:s,depth:Je(i,s)});t.sort((s,i)=>s.depth-i.depth);for(const s of t)e(s.x,s.y,s.depth)}class Qe{constructor(e={}){l(this,"state");l(this,"minZoom");l(this,"maxZoom");l(this,"viewport",{width:0,height:0});l(this,"zoomListeners",new Set);this.state={x:e.x??0,y:e.y??0,zoom:e.zoom??1},this.minZoom=e.minZoom??.5,this.maxZoom=e.maxZoom??3}get x(){return this.state.x}get y(){return this.state.y}get zoom(){return this.state.zoom}get minZoomLevel(){return this.minZoom}get maxZoomLevel(){return this.maxZoom}setViewport(e){this.viewport=e}setPosition(e,t){this.state.x=e,this.state.y=t}pan(e,t){this.state.x+=e,this.state.y+=t}setZoom(e,t,s){const i=Math.max(this.minZoom,Math.min(this.maxZoom,e)),a=this.state.zoom;if(t!==void 0&&s!==void 0){const r=i/this.state.zoom;this.state.x=t-(t-this.state.x)*r,this.state.y=s-(s-this.state.y)*r}this.state.zoom=i,a!==i&&this.emitZoomChange()}zoomBy(e,t,s){this.setZoom(this.state.zoom*(1+e),t,s)}reset(){this.state.x=0,this.state.y=0,this.setZoom(1)}centerOn(e,t){const s=I(e,t);this.state.x=this.viewport.width/2-s.x*this.state.zoom,this.state.y=this.viewport.height/2-s.y*this.state.zoom}screenToWorld(e,t){return{x:(e-this.state.x)/this.state.zoom,y:(t-this.state.y)/this.state.zoom}}worldToScreen(e,t){return{x:e*this.state.zoom+this.state.x,y:t*this.state.zoom+this.state.y}}screenToGrid(e,t){const s=this.screenToWorld(e,t);return G(s.x,s.y)}getVisibleBounds(e=Ge,t=qe){return _t(this.viewport.width/this.state.zoom,this.viewport.height/this.state.zoom,-this.state.x/this.state.zoom,-this.state.y/this.state.zoom,e,t)}applyTransform(e){e.translate(this.state.x,this.state.y),e.scale(this.state.zoom,this.state.zoom)}getState(){return{...this.state}}setState(e){this.state={...e},this.emitZoomChange()}onZoomChange(e){return this.zoomListeners.add(e),()=>{this.zoomListeners.delete(e)}}emitZoomChange(){for(const e of this.zoomListeners)e(this.state.zoom)}}class et{constructor(e,t,s){l(this,"canvas");l(this,"camera");l(this,"tileRegistry");l(this,"options",{showGrid:!0,showHover:!0,showSelection:!0});l(this,"hoveredCoord",null);l(this,"selectedCoords",[]);this.canvas=e,this.camera=t,this.tileRegistry=s,this.camera.setViewport(this.canvas.viewport)}setOptions(e){this.options={...this.options,...e}}setHoveredCoord(e){this.hoveredCoord=e}setSelectedCoords(e){this.selectedCoords=e}render(e){const t=this.canvas.ctx;this.camera.setViewport(this.canvas.viewport),this.canvas.clear(),t.save(),this.camera.applyTransform(t);const s=le(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,e.gridWidth,e.gridHeight),i={minX:0,minY:0,maxX:e.gridWidth-1,maxY:e.gridHeight-1};this.options.showGrid&&this.renderGrid(t,i,s.x,s.y);const a=this.collectRenderItems(e,i);a.sort((r,o)=>r.depth-o.depth);for(const r of a)this.renderTile(t,r.tileId,r.screenX,r.screenY);if(this.options.showHover&&this.hoveredCoord&&this.renderTileOverlay(t,this.hoveredCoord,s.x,s.y,ft),this.options.showSelection&&this.selectedCoords.length>0)for(const r of this.selectedCoords)this.renderTileOverlay(t,r,s.x,s.y,mt);t.restore()}collectRenderItems(e,t){const s=[],i=le(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,e.gridWidth,e.gridHeight),a=e.getVisibleLayers();for(const r of a){const o=this.getLayerYOffset(r);r.forEachTile((d,c)=>{if(c.x>=t.minX&&c.x<=t.maxX&&c.y>=t.minY&&c.y<=t.maxY){const f=xt(c.x,c.y,i.x,i.y),b=Je(c.x,c.y,r.config.zIndex);s.push({tileId:d.tileId,screenX:f.x,screenY:f.y-o,depth:b})}})}return s}getLayerYOffset(e){return e.config.id==="props"||e.config.id==="decorations"?C/2:0}renderTile(e,t,s,i){this.tileRegistry.drawTile(e,t,s,i)}renderGrid(e,t,s,i){e.strokeStyle=Ee,e.lineWidth=1,bt(t,(a,r)=>{this.renderTileOutline(e,{x:a,y:r},s,i,Ee)})}renderTileOutline(e,t,s,i,a){const r=I(t.x,t.y,s,i);e.strokeStyle=a,e.lineWidth=1,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(r.x+S/2,r.y+C/2),e.lineTo(r.x,r.y+C),e.lineTo(r.x-S/2,r.y+C/2),e.closePath(),e.stroke()}renderTileOverlay(e,t,s,i,a){const r=I(t.x,t.y,s,i);e.fillStyle=a,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(r.x+S/2,r.y+C/2),e.lineTo(r.x,r.y+C),e.lineTo(r.x-S/2,r.y+C/2),e.closePath(),e.fill()}screenToGrid(e,t,s){const i=this.camera.screenToWorld(e,t),a=le(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,s.gridWidth,s.gridHeight);return G(i.x,i.y,a.x,a.y)}}class wt{constructor(){l(this,"state");l(this,"listeners",new Map);this.state={activeTool:"brush",activeLayerId:null,selectedTileId:null,hoveredCoord:null,isDirty:!1}}get activeTool(){return this.state.activeTool}get activeLayerId(){return this.state.activeLayerId}get selectedTileId(){return this.state.selectedTileId}get hoveredCoord(){return this.state.hoveredCoord}get isDirty(){return this.state.isDirty}setActiveTool(e){this.state.activeTool!==e&&(this.state.activeTool=e,this.emit("tool:changed",{tool:e}))}setActiveLayer(e){this.state.activeLayerId!==e&&(this.state.activeLayerId=e,this.emit("layer:changed",{layerId:e}))}setSelectedTile(e){this.state.selectedTileId!==e&&(this.state.selectedTileId=e,this.emit("tile:selected",{tileId:e}))}setHoveredCoord(e){var s,i;(((s=this.state.hoveredCoord)==null?void 0:s.x)!==(e==null?void 0:e.x)||((i=this.state.hoveredCoord)==null?void 0:i.y)!==(e==null?void 0:e.y))&&(this.state.hoveredCoord=e,this.emit("hover:changed",{coord:e}))}setDirty(e){this.state.isDirty!==e&&(this.state.isDirty=e,this.emit("dirty:changed",{isDirty:e}))}markDirty(){this.setDirty(!0)}markClean(){this.setDirty(!1)}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;(s=this.listeners.get(e))==null||s.delete(t)}}off(e,t){var s;(s=this.listeners.get(e))==null||s.delete(t)}emit(e,t){var s;(s=this.listeners.get(e))==null||s.forEach(i=>i(t))}notifyLevelLoaded(e){this.emit("level:loaded",{level:e})}getSnapshot(){return{...this.state}}restore(e){e.activeTool!==void 0&&this.setActiveTool(e.activeTool),e.activeLayerId!==void 0&&this.setActiveLayer(e.activeLayerId),e.selectedTileId!==void 0&&this.setSelectedTile(e.selectedTileId)}}class Ct{constructor(e={}){l(this,"undoStack",[]);l(this,"redoStack",[]);l(this,"maxSize");l(this,"savePoint",0);l(this,"listeners",new Map);this.maxSize=e.maxSize??100}execute(e){for(e.execute(),this.undoStack.push(e),this.redoStack=[];this.undoStack.length>this.maxSize;)this.undoStack.shift(),this.savePoint>0&&this.savePoint--;this.emit("change")}undo(){const e=this.undoStack.pop();return e?(e.undo(),this.redoStack.push(e),this.emit("change"),!0):!1}redo(){const e=this.redoStack.pop();return e?(e.execute(),this.undoStack.push(e),this.emit("change"),!0):!1}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoDescription(){const e=this.undoStack[this.undoStack.length-1];return(e==null?void 0:e.description)??null}getRedoDescription(){const e=this.redoStack[this.redoStack.length-1];return(e==null?void 0:e.description)??null}markSaved(){this.savePoint=this.undoStack.length,this.emit("save")}isDirty(){return this.undoStack.length!==this.savePoint}clear(){this.undoStack=[],this.redoStack=[],this.savePoint=0,this.emit("change")}get undoCount(){return this.undoStack.length}get redoCount(){return this.redoStack.length}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;(s=this.listeners.get(e))==null||s.delete(t)}}off(e,t){var s;(s=this.listeners.get(e))==null||s.delete(t)}emit(e){var t;(t=this.listeners.get(e))==null||t.forEach(s=>s())}}class tt{constructor(){l(this,"shortcut");l(this,"lastCoord",null);l(this,"isDrawing",!1)}onActivate(e){this.lastCoord=null,this.isDrawing=!1}onDeactivate(e){this.lastCoord=null,this.isDrawing=!1}getCursor(){return"default"}hasCoordChanged(e){return this.lastCoord?this.lastCoord.x!==e.x||this.lastCoord.y!==e.y:!0}updateLastCoord(e){this.lastCoord={...e}}}class Tt{constructor(e,t,s,i,a){l(this,"description");this.level=e,this.layerId=t,this.coord=s,this.newTile=i,this.previousTile=a,this.description=`Place tile ${i.tileId} at (${s.x}, ${s.y})`}execute(){this.level.setTile(this.layerId,this.coord,this.newTile)}undo(){this.previousTile?this.level.setTile(this.layerId,this.coord,this.previousTile):this.level.removeTile(this.layerId,this.coord)}}class St{constructor(e,t,s,i){l(this,"description");this.level=e,this.layerId=t,this.coord=s,this.previousTile=i,this.description=`Remove tile at (${s.x}, ${s.y})`}execute(){this.level.removeTile(this.layerId,this.coord)}undo(){this.level.setTile(this.layerId,this.coord,this.previousTile)}}class kt{constructor(e,t){l(this,"description");this.commands=e,this.description=t??`Batch operation (${e.length} tiles)`}execute(){for(const e of this.commands)e.execute()}undo(){for(let e=this.commands.length-1;e>=0;e--)this.commands[e].undo()}}class Et{constructor(e,t){l(this,"description");l(this,"previousTiles",[]);this.level=e,this.layerId=t,this.description=`Clear layer "${t}"`;const s=this.level.getLayer(t);s&&(this.previousTiles=s.getAllTiles().map(({tile:i,coord:a})=>({coord:a,tile:{...i}})))}execute(){const e=this.level.getLayer(this.layerId);e==null||e.clear()}undo(){for(const{coord:e,tile:t}of this.previousTiles)this.level.setTile(this.layerId,e,t)}}class Lt extends tt{constructor(){super(...arguments);l(this,"type","brush");l(this,"name","Brush");l(this,"description","Place tiles on the map");l(this,"shortcut","b");l(this,"placedCoords",new Set)}onActivate(t){super.onActivate(t),this.placedCoords.clear()}onDeactivate(t){super.onDeactivate(t),this.placedCoords.clear()}onMouseDown(t,s){this.isDrawing=!0,this.placedCoords.clear(),this.placeTile(t,s)}onMouseMove(t,s,i){i&&this.isDrawing&&this.hasCoordChanged(s)&&this.placeTile(t,s),this.updateLastCoord(s)}onMouseUp(t,s){this.isDrawing=!1,this.placedCoords.clear()}getCursor(){return"crosshair"}placeTile(t,s){const{level:i,editorState:a,history:r}=t,o=a.activeLayerId,d=a.selectedTileId;if(!o||d===null||!i.isInBounds(s))return;const c=`${s.x},${s.y}`;if(this.placedCoords.has(c))return;this.placedCoords.add(c);const f=i.getTile(o,s);if((f==null?void 0:f.tileId)===d)return;const b=new Tt(i,o,s,{tileId:d},f);r.execute(b),a.markDirty()}}class It extends tt{constructor(){super(...arguments);l(this,"type","eraser");l(this,"name","Eraser");l(this,"description","Remove tiles from the map");l(this,"shortcut","e");l(this,"erasedCoords",new Set)}onActivate(t){super.onActivate(t),this.erasedCoords.clear()}onDeactivate(t){super.onDeactivate(t),this.erasedCoords.clear()}onMouseDown(t,s){this.isDrawing=!0,this.erasedCoords.clear(),this.eraseTile(t,s)}onMouseMove(t,s,i){i&&this.isDrawing&&this.hasCoordChanged(s)&&this.eraseTile(t,s),this.updateLastCoord(s)}onMouseUp(t,s){this.isDrawing=!1,this.erasedCoords.clear()}getCursor(){return"crosshair"}eraseTile(t,s){const{level:i,editorState:a,history:r}=t,o=a.activeLayerId;if(!o||!i.isInBounds(s))return;const d=`${s.x},${s.y}`;if(this.erasedCoords.has(d))return;this.erasedCoords.add(d);const c=i.getTile(o,s);if(!c)return;const f=new St(i,o,s,c);r.execute(f),a.markDirty()}}var _;(function(n){n.assertEqual=i=>{};function e(i){}n.assertIs=e;function t(i){throw new Error}n.assertNever=t,n.arrayToEnum=i=>{const a={};for(const r of i)a[r]=r;return a},n.getValidEnumValues=i=>{const a=n.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),r={};for(const o of a)r[o]=i[o];return n.objectValues(r)},n.objectValues=i=>n.objectKeys(i).map(function(a){return i[a]}),n.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const a=[];for(const r in i)Object.prototype.hasOwnProperty.call(i,r)&&a.push(r);return a},n.find=(i,a)=>{for(const r of i)if(a(r))return r},n.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&Number.isFinite(i)&&Math.floor(i)===i;function s(i,a=" | "){return i.map(r=>typeof r=="string"?`'${r}'`:r).join(a)}n.joinValues=s,n.jsonStringifyReplacer=(i,a)=>typeof a=="bigint"?a.toString():a})(_||(_={}));var Be;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(Be||(Be={}));const p=_.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),M=n=>{switch(typeof n){case"undefined":return p.undefined;case"string":return p.string;case"number":return Number.isNaN(n)?p.nan:p.number;case"boolean":return p.boolean;case"function":return p.function;case"bigint":return p.bigint;case"symbol":return p.symbol;case"object":return Array.isArray(n)?p.array:n===null?p.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?p.promise:typeof Map<"u"&&n instanceof Map?p.map:typeof Set<"u"&&n instanceof Set?p.set:typeof Date<"u"&&n instanceof Date?p.date:p.object;default:return p.unknown}},h=_.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class P extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=s=>{this.issues=[...this.issues,s]},this.addIssues=(s=[])=>{this.issues=[...this.issues,...s]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(a){return a.message},s={_errors:[]},i=a=>{for(const r of a.issues)if(r.code==="invalid_union")r.unionErrors.map(i);else if(r.code==="invalid_return_type")i(r.returnTypeError);else if(r.code==="invalid_arguments")i(r.argumentsError);else if(r.path.length===0)s._errors.push(t(r));else{let o=s,d=0;for(;d<r.path.length;){const c=r.path[d];d===r.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(r))):o[c]=o[c]||{_errors:[]},o=o[c],d++}}};return i(this),s}static assert(e){if(!(e instanceof P))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,_.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},s=[];for(const i of this.issues)if(i.path.length>0){const a=i.path[0];t[a]=t[a]||[],t[a].push(e(i))}else s.push(e(i));return{formErrors:s,fieldErrors:t}}get formErrors(){return this.flatten()}}P.create=n=>new P(n);const ve=(n,e)=>{let t;switch(n.code){case h.invalid_type:n.received===p.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case h.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,_.jsonStringifyReplacer)}`;break;case h.unrecognized_keys:t=`Unrecognized key(s) in object: ${_.joinValues(n.keys,", ")}`;break;case h.invalid_union:t="Invalid input";break;case h.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${_.joinValues(n.options)}`;break;case h.invalid_enum_value:t=`Invalid enum value. Expected ${_.joinValues(n.options)}, received '${n.received}'`;break;case h.invalid_arguments:t="Invalid function arguments";break;case h.invalid_return_type:t="Invalid function return type";break;case h.invalid_date:t="Invalid date";break;case h.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:_.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case h.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="bigint"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case h.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case h.custom:t="Invalid input";break;case h.invalid_intersection_types:t="Intersection results could not be merged";break;case h.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case h.not_finite:t="Number must be finite";break;default:t=e.defaultError,_.assertNever(n)}return{message:t}};let Bt=ve;function zt(){return Bt}const Rt=n=>{const{data:e,path:t,errorMaps:s,issueData:i}=n,a=[...t,...i.path||[]],r={...i,path:a};if(i.message!==void 0)return{...i,path:a,message:i.message};let o="";const d=s.filter(c=>!!c).slice().reverse();for(const c of d)o=c(r,{data:e,defaultError:o}).message;return{...i,path:a,message:o}};function u(n,e){const t=zt(),s=Rt({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===ve?void 0:ve].filter(i=>!!i)});n.common.issues.push(s)}class k{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const s=[];for(const i of t){if(i.status==="aborted")return y;i.status==="dirty"&&e.dirty(),s.push(i.value)}return{status:e.value,value:s}}static async mergeObjectAsync(e,t){const s=[];for(const i of t){const a=await i.key,r=await i.value;s.push({key:a,value:r})}return k.mergeObjectSync(e,s)}static mergeObjectSync(e,t){const s={};for(const i of t){const{key:a,value:r}=i;if(a.status==="aborted"||r.status==="aborted")return y;a.status==="dirty"&&e.dirty(),r.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof r.value<"u"||i.alwaysSet)&&(s[a.value]=r.value)}return{status:e.value,value:s}}}const y=Object.freeze({status:"aborted"}),te=n=>({status:"dirty",value:n}),B=n=>({status:"valid",value:n}),ze=n=>n.status==="aborted",Re=n=>n.status==="dirty",q=n=>n.status==="valid",de=n=>typeof Promise<"u"&&n instanceof Promise;var m;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(m||(m={}));class ${constructor(e,t,s,i){this._cachedPath=[],this.parent=e,this.data=t,this._path=s,this._key=i}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Pe=(n,e)=>{if(q(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new P(n.common.issues);return this._error=t,this._error}}};function v(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:s,description:i}=n;if(e&&(t||s))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:i}:{errorMap:(r,o)=>{const{message:d}=n;return r.code==="invalid_enum_value"?{message:d??o.defaultError}:typeof o.data>"u"?{message:d??s??o.defaultError}:r.code!=="invalid_type"?{message:o.defaultError}:{message:d??t??o.defaultError}},description:i}}class x{get description(){return this._def.description}_getType(e){return M(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:M(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new k,ctx:{common:e.parent.common,data:e.data,parsedType:M(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(de(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const s=this.safeParse(e,t);if(s.success)return s.data;throw s.error}safeParse(e,t){const s={common:{issues:[],async:(t==null?void 0:t.async)??!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:M(e)},i=this._parseSync({data:e,path:s.path,parent:s});return Pe(s,i)}"~validate"(e){var s,i;const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:M(e)};if(!this["~standard"].async)try{const a=this._parseSync({data:e,path:[],parent:t});return q(a)?{value:a.value}:{issues:t.common.issues}}catch(a){(i=(s=a==null?void 0:a.message)==null?void 0:s.toLowerCase())!=null&&i.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(a=>q(a)?{value:a.value}:{issues:t.common.issues})}async parseAsync(e,t){const s=await this.safeParseAsync(e,t);if(s.success)return s.data;throw s.error}async safeParseAsync(e,t){const s={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:M(e)},i=this._parse({data:e,path:s.path,parent:s}),a=await(de(i)?i:Promise.resolve(i));return Pe(s,a)}refine(e,t){const s=i=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(i):t;return this._refinement((i,a)=>{const r=e(i),o=()=>a.addIssue({code:h.custom,...s(i)});return typeof Promise<"u"&&r instanceof Promise?r.then(d=>d?!0:(o(),!1)):r?!0:(o(),!1)})}refinement(e,t){return this._refinement((s,i)=>e(s)?!0:(i.addIssue(typeof t=="function"?t(s,i):t),!1))}_refinement(e){return new J({schema:this,typeName:g.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return A.create(this,this._def)}nullable(){return Q.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return R.create(this)}promise(){return pe.create(this,this._def)}or(e){return he.create([this,e],this._def)}and(e){return ue.create(this,e,this._def)}transform(e){return new J({...v(this._def),schema:this,typeName:g.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new we({...v(this._def),innerType:this,defaultValue:t,typeName:g.ZodDefault})}brand(){return new ts({typeName:g.ZodBranded,type:this,...v(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Ce({...v(this._def),innerType:this,catchValue:t,typeName:g.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return ke.create(this,e)}readonly(){return Te.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Pt=/^c[^\s-]{8,}$/i,Mt=/^[0-9a-z]+$/,Dt=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Nt=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Ot=/^[a-z0-9_-]{21}$/i,At=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Zt=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,$t=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Ht="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let ge;const jt=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Vt=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Ft=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ut=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Wt=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Kt=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,st="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Gt=new RegExp(`^${st}$`);function it(n){let e="[0-5]\\d";n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`);const t=n.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function qt(n){return new RegExp(`^${it(n)}$`)}function Yt(n){let e=`${st}T${it(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Xt(n,e){return!!((e==="v4"||!e)&&jt.test(n)||(e==="v6"||!e)&&Ft.test(n))}function Jt(n,e){if(!At.test(n))return!1;try{const[t]=n.split(".");if(!t)return!1;const s=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),i=JSON.parse(atob(s));return!(typeof i!="object"||i===null||"typ"in i&&(i==null?void 0:i.typ)!=="JWT"||!i.alg||e&&i.alg!==e)}catch{return!1}}function Qt(n,e){return!!((e==="v4"||!e)&&Vt.test(n)||(e==="v6"||!e)&&Ut.test(n))}class O extends x{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==p.string){const a=this._getOrReturnCtx(e);return u(a,{code:h.invalid_type,expected:p.string,received:a.parsedType}),y}const s=new k;let i;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:h.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),s.dirty());else if(a.kind==="max")e.data.length>a.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:h.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),s.dirty());else if(a.kind==="length"){const r=e.data.length>a.value,o=e.data.length<a.value;(r||o)&&(i=this._getOrReturnCtx(e,i),r?u(i,{code:h.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&u(i,{code:h.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),s.dirty())}else if(a.kind==="email")$t.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"email",code:h.invalid_string,message:a.message}),s.dirty());else if(a.kind==="emoji")ge||(ge=new RegExp(Ht,"u")),ge.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"emoji",code:h.invalid_string,message:a.message}),s.dirty());else if(a.kind==="uuid")Nt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"uuid",code:h.invalid_string,message:a.message}),s.dirty());else if(a.kind==="nanoid")Ot.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"nanoid",code:h.invalid_string,message:a.message}),s.dirty());else if(a.kind==="cuid")Pt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"cuid",code:h.invalid_string,message:a.message}),s.dirty());else if(a.kind==="cuid2")Mt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"cuid2",code:h.invalid_string,message:a.message}),s.dirty());else if(a.kind==="ulid")Dt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"ulid",code:h.invalid_string,message:a.message}),s.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{i=this._getOrReturnCtx(e,i),u(i,{validation:"url",code:h.invalid_string,message:a.message}),s.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"regex",code:h.invalid_string,message:a.message}),s.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),s.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:{startsWith:a.value},message:a.message}),s.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:{endsWith:a.value},message:a.message}),s.dirty()):a.kind==="datetime"?Yt(a).test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:"datetime",message:a.message}),s.dirty()):a.kind==="date"?Gt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:"date",message:a.message}),s.dirty()):a.kind==="time"?qt(a).test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{code:h.invalid_string,validation:"time",message:a.message}),s.dirty()):a.kind==="duration"?Zt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"duration",code:h.invalid_string,message:a.message}),s.dirty()):a.kind==="ip"?Xt(e.data,a.version)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"ip",code:h.invalid_string,message:a.message}),s.dirty()):a.kind==="jwt"?Jt(e.data,a.alg)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"jwt",code:h.invalid_string,message:a.message}),s.dirty()):a.kind==="cidr"?Qt(e.data,a.version)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"cidr",code:h.invalid_string,message:a.message}),s.dirty()):a.kind==="base64"?Wt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"base64",code:h.invalid_string,message:a.message}),s.dirty()):a.kind==="base64url"?Kt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"base64url",code:h.invalid_string,message:a.message}),s.dirty()):_.assertNever(a);return{status:s.value,value:e.data}}_regex(e,t,s){return this.refinement(i=>e.test(i),{validation:t,code:h.invalid_string,...m.errToObj(s)})}_addCheck(e){return new O({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...m.errToObj(e)})}url(e){return this._addCheck({kind:"url",...m.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...m.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...m.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...m.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...m.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...m.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...m.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...m.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...m.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...m.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...m.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...m.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...m.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...m.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...m.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...m.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...m.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...m.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...m.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...m.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...m.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...m.errToObj(t)})}nonempty(e){return this.min(1,m.errToObj(e))}trim(){return new O({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new O({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new O({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}O.create=n=>new O({checks:[],typeName:g.ZodString,coerce:(n==null?void 0:n.coerce)??!1,...v(n)});function es(n,e){const t=(n.toString().split(".")[1]||"").length,s=(e.toString().split(".")[1]||"").length,i=t>s?t:s,a=Number.parseInt(n.toFixed(i).replace(".","")),r=Number.parseInt(e.toFixed(i).replace(".",""));return a%r/10**i}class Y extends x{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==p.number){const a=this._getOrReturnCtx(e);return u(a,{code:h.invalid_type,expected:p.number,received:a.parsedType}),y}let s;const i=new k;for(const a of this._def.checks)a.kind==="int"?_.isInteger(e.data)||(s=this._getOrReturnCtx(e,s),u(s,{code:h.invalid_type,expected:"integer",received:"float",message:a.message}),i.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),i.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),i.dirty()):a.kind==="multipleOf"?es(e.data,a.value)!==0&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.not_multiple_of,multipleOf:a.value,message:a.message}),i.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(s=this._getOrReturnCtx(e,s),u(s,{code:h.not_finite,message:a.message}),i.dirty()):_.assertNever(a);return{status:i.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,m.toString(t))}gt(e,t){return this.setLimit("min",e,!1,m.toString(t))}lte(e,t){return this.setLimit("max",e,!0,m.toString(t))}lt(e,t){return this.setLimit("max",e,!1,m.toString(t))}setLimit(e,t,s,i){return new Y({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:m.toString(i)}]})}_addCheck(e){return new Y({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:m.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:m.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:m.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:m.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:m.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:m.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:m.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:m.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:m.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&_.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const s of this._def.checks){if(s.kind==="finite"||s.kind==="int"||s.kind==="multipleOf")return!0;s.kind==="min"?(t===null||s.value>t)&&(t=s.value):s.kind==="max"&&(e===null||s.value<e)&&(e=s.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Y.create=n=>new Y({checks:[],typeName:g.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...v(n)});class ne extends x{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==p.bigint)return this._getInvalidInput(e);let s;const i=new k;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),i.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),i.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(s=this._getOrReturnCtx(e,s),u(s,{code:h.not_multiple_of,multipleOf:a.value,message:a.message}),i.dirty()):_.assertNever(a);return{status:i.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return u(t,{code:h.invalid_type,expected:p.bigint,received:t.parsedType}),y}gte(e,t){return this.setLimit("min",e,!0,m.toString(t))}gt(e,t){return this.setLimit("min",e,!1,m.toString(t))}lte(e,t){return this.setLimit("max",e,!0,m.toString(t))}lt(e,t){return this.setLimit("max",e,!1,m.toString(t))}setLimit(e,t,s,i){return new ne({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:m.toString(i)}]})}_addCheck(e){return new ne({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:m.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:m.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:m.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:m.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:m.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}ne.create=n=>new ne({checks:[],typeName:g.ZodBigInt,coerce:(n==null?void 0:n.coerce)??!1,...v(n)});class xe extends x{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==p.boolean){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:p.boolean,received:s.parsedType}),y}return B(e.data)}}xe.create=n=>new xe({typeName:g.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...v(n)});class ce extends x{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==p.date){const a=this._getOrReturnCtx(e);return u(a,{code:h.invalid_type,expected:p.date,received:a.parsedType}),y}if(Number.isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return u(a,{code:h.invalid_date}),y}const s=new k;let i;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:h.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),s.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:h.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),s.dirty()):_.assertNever(a);return{status:s.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ce({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:m.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:m.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}ce.create=n=>new ce({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:g.ZodDate,...v(n)});class Me extends x{_parse(e){if(this._getType(e)!==p.symbol){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:p.symbol,received:s.parsedType}),y}return B(e.data)}}Me.create=n=>new Me({typeName:g.ZodSymbol,...v(n)});class De extends x{_parse(e){if(this._getType(e)!==p.undefined){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:p.undefined,received:s.parsedType}),y}return B(e.data)}}De.create=n=>new De({typeName:g.ZodUndefined,...v(n)});class Ne extends x{_parse(e){if(this._getType(e)!==p.null){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:p.null,received:s.parsedType}),y}return B(e.data)}}Ne.create=n=>new Ne({typeName:g.ZodNull,...v(n)});class Oe extends x{constructor(){super(...arguments),this._any=!0}_parse(e){return B(e.data)}}Oe.create=n=>new Oe({typeName:g.ZodAny,...v(n)});class Ae extends x{constructor(){super(...arguments),this._unknown=!0}_parse(e){return B(e.data)}}Ae.create=n=>new Ae({typeName:g.ZodUnknown,...v(n)});class H extends x{_parse(e){const t=this._getOrReturnCtx(e);return u(t,{code:h.invalid_type,expected:p.never,received:t.parsedType}),y}}H.create=n=>new H({typeName:g.ZodNever,...v(n)});class Ze extends x{_parse(e){if(this._getType(e)!==p.undefined){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:p.void,received:s.parsedType}),y}return B(e.data)}}Ze.create=n=>new Ze({typeName:g.ZodVoid,...v(n)});class R extends x{_parse(e){const{ctx:t,status:s}=this._processInputParams(e),i=this._def;if(t.parsedType!==p.array)return u(t,{code:h.invalid_type,expected:p.array,received:t.parsedType}),y;if(i.exactLength!==null){const r=t.data.length>i.exactLength.value,o=t.data.length<i.exactLength.value;(r||o)&&(u(t,{code:r?h.too_big:h.too_small,minimum:o?i.exactLength.value:void 0,maximum:r?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),s.dirty())}if(i.minLength!==null&&t.data.length<i.minLength.value&&(u(t,{code:h.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),s.dirty()),i.maxLength!==null&&t.data.length>i.maxLength.value&&(u(t,{code:h.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),s.dirty()),t.common.async)return Promise.all([...t.data].map((r,o)=>i.type._parseAsync(new $(t,r,t.path,o)))).then(r=>k.mergeArray(s,r));const a=[...t.data].map((r,o)=>i.type._parseSync(new $(t,r,t.path,o)));return k.mergeArray(s,a)}get element(){return this._def.type}min(e,t){return new R({...this._def,minLength:{value:e,message:m.toString(t)}})}max(e,t){return new R({...this._def,maxLength:{value:e,message:m.toString(t)}})}length(e,t){return new R({...this._def,exactLength:{value:e,message:m.toString(t)}})}nonempty(e){return this.min(1,e)}}R.create=(n,e)=>new R({type:n,minLength:null,maxLength:null,exactLength:null,typeName:g.ZodArray,...v(e)});function U(n){if(n instanceof w){const e={};for(const t in n.shape){const s=n.shape[t];e[t]=A.create(U(s))}return new w({...n._def,shape:()=>e})}else return n instanceof R?new R({...n._def,type:U(n.element)}):n instanceof A?A.create(U(n.unwrap())):n instanceof Q?Q.create(U(n.unwrap())):n instanceof j?j.create(n.items.map(e=>U(e))):n}class w extends x{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=_.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==p.object){const c=this._getOrReturnCtx(e);return u(c,{code:h.invalid_type,expected:p.object,received:c.parsedType}),y}const{status:s,ctx:i}=this._processInputParams(e),{shape:a,keys:r}=this._getCached(),o=[];if(!(this._def.catchall instanceof H&&this._def.unknownKeys==="strip"))for(const c in i.data)r.includes(c)||o.push(c);const d=[];for(const c of r){const f=a[c],b=i.data[c];d.push({key:{status:"valid",value:c},value:f._parse(new $(i,b,i.path,c)),alwaysSet:c in i.data})}if(this._def.catchall instanceof H){const c=this._def.unknownKeys;if(c==="passthrough")for(const f of o)d.push({key:{status:"valid",value:f},value:{status:"valid",value:i.data[f]}});else if(c==="strict")o.length>0&&(u(i,{code:h.unrecognized_keys,keys:o}),s.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const f of o){const b=i.data[f];d.push({key:{status:"valid",value:f},value:c._parse(new $(i,b,i.path,f)),alwaysSet:f in i.data})}}return i.common.async?Promise.resolve().then(async()=>{const c=[];for(const f of d){const b=await f.key,E=await f.value;c.push({key:b,value:E,alwaysSet:f.alwaysSet})}return c}).then(c=>k.mergeObjectSync(s,c)):k.mergeObjectSync(s,d)}get shape(){return this._def.shape()}strict(e){return m.errToObj,new w({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,s)=>{var a,r;const i=((r=(a=this._def).errorMap)==null?void 0:r.call(a,t,s).message)??s.defaultError;return t.code==="unrecognized_keys"?{message:m.errToObj(e).message??i}:{message:i}}}:{}})}strip(){return new w({...this._def,unknownKeys:"strip"})}passthrough(){return new w({...this._def,unknownKeys:"passthrough"})}extend(e){return new w({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new w({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:g.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new w({...this._def,catchall:e})}pick(e){const t={};for(const s of _.objectKeys(e))e[s]&&this.shape[s]&&(t[s]=this.shape[s]);return new w({...this._def,shape:()=>t})}omit(e){const t={};for(const s of _.objectKeys(this.shape))e[s]||(t[s]=this.shape[s]);return new w({...this._def,shape:()=>t})}deepPartial(){return U(this)}partial(e){const t={};for(const s of _.objectKeys(this.shape)){const i=this.shape[s];e&&!e[s]?t[s]=i:t[s]=i.optional()}return new w({...this._def,shape:()=>t})}required(e){const t={};for(const s of _.objectKeys(this.shape))if(e&&!e[s])t[s]=this.shape[s];else{let a=this.shape[s];for(;a instanceof A;)a=a._def.innerType;t[s]=a}return new w({...this._def,shape:()=>t})}keyof(){return nt(_.objectKeys(this.shape))}}w.create=(n,e)=>new w({shape:()=>n,unknownKeys:"strip",catchall:H.create(),typeName:g.ZodObject,...v(e)});w.strictCreate=(n,e)=>new w({shape:()=>n,unknownKeys:"strict",catchall:H.create(),typeName:g.ZodObject,...v(e)});w.lazycreate=(n,e)=>new w({shape:n,unknownKeys:"strip",catchall:H.create(),typeName:g.ZodObject,...v(e)});class he extends x{_parse(e){const{ctx:t}=this._processInputParams(e),s=this._def.options;function i(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const r=a.map(o=>new P(o.ctx.common.issues));return u(t,{code:h.invalid_union,unionErrors:r}),y}if(t.common.async)return Promise.all(s.map(async a=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(i);{let a;const r=[];for(const d of s){const c={...t,common:{...t.common,issues:[]},parent:null},f=d._parseSync({data:t.data,path:t.path,parent:c});if(f.status==="valid")return f;f.status==="dirty"&&!a&&(a={result:f,ctx:c}),c.common.issues.length&&r.push(c.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;const o=r.map(d=>new P(d));return u(t,{code:h.invalid_union,unionErrors:o}),y}}get options(){return this._def.options}}he.create=(n,e)=>new he({options:n,typeName:g.ZodUnion,...v(e)});function _e(n,e){const t=M(n),s=M(e);if(n===e)return{valid:!0,data:n};if(t===p.object&&s===p.object){const i=_.objectKeys(e),a=_.objectKeys(n).filter(o=>i.indexOf(o)!==-1),r={...n,...e};for(const o of a){const d=_e(n[o],e[o]);if(!d.valid)return{valid:!1};r[o]=d.data}return{valid:!0,data:r}}else if(t===p.array&&s===p.array){if(n.length!==e.length)return{valid:!1};const i=[];for(let a=0;a<n.length;a++){const r=n[a],o=e[a],d=_e(r,o);if(!d.valid)return{valid:!1};i.push(d.data)}return{valid:!0,data:i}}else return t===p.date&&s===p.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class ue extends x{_parse(e){const{status:t,ctx:s}=this._processInputParams(e),i=(a,r)=>{if(ze(a)||ze(r))return y;const o=_e(a.value,r.value);return o.valid?((Re(a)||Re(r))&&t.dirty(),{status:t.value,value:o.data}):(u(s,{code:h.invalid_intersection_types}),y)};return s.common.async?Promise.all([this._def.left._parseAsync({data:s.data,path:s.path,parent:s}),this._def.right._parseAsync({data:s.data,path:s.path,parent:s})]).then(([a,r])=>i(a,r)):i(this._def.left._parseSync({data:s.data,path:s.path,parent:s}),this._def.right._parseSync({data:s.data,path:s.path,parent:s}))}}ue.create=(n,e,t)=>new ue({left:n,right:e,typeName:g.ZodIntersection,...v(t)});class j extends x{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==p.array)return u(s,{code:h.invalid_type,expected:p.array,received:s.parsedType}),y;if(s.data.length<this._def.items.length)return u(s,{code:h.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),y;!this._def.rest&&s.data.length>this._def.items.length&&(u(s,{code:h.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const a=[...s.data].map((r,o)=>{const d=this._def.items[o]||this._def.rest;return d?d._parse(new $(s,r,s.path,o)):null}).filter(r=>!!r);return s.common.async?Promise.all(a).then(r=>k.mergeArray(t,r)):k.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new j({...this._def,rest:e})}}j.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new j({items:n,typeName:g.ZodTuple,rest:null,...v(e)})};class $e extends x{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==p.map)return u(s,{code:h.invalid_type,expected:p.map,received:s.parsedType}),y;const i=this._def.keyType,a=this._def.valueType,r=[...s.data.entries()].map(([o,d],c)=>({key:i._parse(new $(s,o,s.path,[c,"key"])),value:a._parse(new $(s,d,s.path,[c,"value"]))}));if(s.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const d of r){const c=await d.key,f=await d.value;if(c.status==="aborted"||f.status==="aborted")return y;(c.status==="dirty"||f.status==="dirty")&&t.dirty(),o.set(c.value,f.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const d of r){const c=d.key,f=d.value;if(c.status==="aborted"||f.status==="aborted")return y;(c.status==="dirty"||f.status==="dirty")&&t.dirty(),o.set(c.value,f.value)}return{status:t.value,value:o}}}}$e.create=(n,e,t)=>new $e({valueType:e,keyType:n,typeName:g.ZodMap,...v(t)});class ae extends x{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==p.set)return u(s,{code:h.invalid_type,expected:p.set,received:s.parsedType}),y;const i=this._def;i.minSize!==null&&s.data.size<i.minSize.value&&(u(s,{code:h.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),t.dirty()),i.maxSize!==null&&s.data.size>i.maxSize.value&&(u(s,{code:h.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),t.dirty());const a=this._def.valueType;function r(d){const c=new Set;for(const f of d){if(f.status==="aborted")return y;f.status==="dirty"&&t.dirty(),c.add(f.value)}return{status:t.value,value:c}}const o=[...s.data.values()].map((d,c)=>a._parse(new $(s,d,s.path,c)));return s.common.async?Promise.all(o).then(d=>r(d)):r(o)}min(e,t){return new ae({...this._def,minSize:{value:e,message:m.toString(t)}})}max(e,t){return new ae({...this._def,maxSize:{value:e,message:m.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}ae.create=(n,e)=>new ae({valueType:n,minSize:null,maxSize:null,typeName:g.ZodSet,...v(e)});class He extends x{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}He.create=(n,e)=>new He({getter:n,typeName:g.ZodLazy,...v(e)});class be extends x{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return u(t,{received:t.data,code:h.invalid_literal,expected:this._def.value}),y}return{status:"valid",value:e.data}}get value(){return this._def.value}}be.create=(n,e)=>new be({value:n,typeName:g.ZodLiteral,...v(e)});function nt(n,e){return new X({values:n,typeName:g.ZodEnum,...v(e)})}class X extends x{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),s=this._def.values;return u(t,{expected:_.joinValues(s),received:t.parsedType,code:h.invalid_type}),y}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),s=this._def.values;return u(t,{received:t.data,code:h.invalid_enum_value,options:s}),y}return B(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return X.create(e,{...this._def,...t})}exclude(e,t=this._def){return X.create(this.options.filter(s=>!e.includes(s)),{...this._def,...t})}}X.create=nt;class je extends x{_parse(e){const t=_.getValidEnumValues(this._def.values),s=this._getOrReturnCtx(e);if(s.parsedType!==p.string&&s.parsedType!==p.number){const i=_.objectValues(t);return u(s,{expected:_.joinValues(i),received:s.parsedType,code:h.invalid_type}),y}if(this._cache||(this._cache=new Set(_.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const i=_.objectValues(t);return u(s,{received:s.data,code:h.invalid_enum_value,options:i}),y}return B(e.data)}get enum(){return this._def.values}}je.create=(n,e)=>new je({values:n,typeName:g.ZodNativeEnum,...v(e)});class pe extends x{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==p.promise&&t.common.async===!1)return u(t,{code:h.invalid_type,expected:p.promise,received:t.parsedType}),y;const s=t.parsedType===p.promise?t.data:Promise.resolve(t.data);return B(s.then(i=>this._def.type.parseAsync(i,{path:t.path,errorMap:t.common.contextualErrorMap})))}}pe.create=(n,e)=>new pe({type:n,typeName:g.ZodPromise,...v(e)});class J extends x{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===g.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:s}=this._processInputParams(e),i=this._def.effect||null,a={addIssue:r=>{u(s,r),r.fatal?t.abort():t.dirty()},get path(){return s.path}};if(a.addIssue=a.addIssue.bind(a),i.type==="preprocess"){const r=i.transform(s.data,a);if(s.common.async)return Promise.resolve(r).then(async o=>{if(t.value==="aborted")return y;const d=await this._def.schema._parseAsync({data:o,path:s.path,parent:s});return d.status==="aborted"?y:d.status==="dirty"||t.value==="dirty"?te(d.value):d});{if(t.value==="aborted")return y;const o=this._def.schema._parseSync({data:r,path:s.path,parent:s});return o.status==="aborted"?y:o.status==="dirty"||t.value==="dirty"?te(o.value):o}}if(i.type==="refinement"){const r=o=>{const d=i.refinement(o,a);if(s.common.async)return Promise.resolve(d);if(d instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(s.common.async===!1){const o=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});return o.status==="aborted"?y:(o.status==="dirty"&&t.dirty(),r(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(o=>o.status==="aborted"?y:(o.status==="dirty"&&t.dirty(),r(o.value).then(()=>({status:t.value,value:o.value}))))}if(i.type==="transform")if(s.common.async===!1){const r=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});if(!q(r))return y;const o=i.transform(r.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(r=>q(r)?Promise.resolve(i.transform(r.value,a)).then(o=>({status:t.value,value:o})):y);_.assertNever(i)}}J.create=(n,e,t)=>new J({schema:n,typeName:g.ZodEffects,effect:e,...v(t)});J.createWithPreprocess=(n,e,t)=>new J({schema:e,effect:{type:"preprocess",transform:n},typeName:g.ZodEffects,...v(t)});class A extends x{_parse(e){return this._getType(e)===p.undefined?B(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}A.create=(n,e)=>new A({innerType:n,typeName:g.ZodOptional,...v(e)});class Q extends x{_parse(e){return this._getType(e)===p.null?B(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Q.create=(n,e)=>new Q({innerType:n,typeName:g.ZodNullable,...v(e)});class we extends x{_parse(e){const{ctx:t}=this._processInputParams(e);let s=t.data;return t.parsedType===p.undefined&&(s=this._def.defaultValue()),this._def.innerType._parse({data:s,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}we.create=(n,e)=>new we({innerType:n,typeName:g.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...v(e)});class Ce extends x{_parse(e){const{ctx:t}=this._processInputParams(e),s={...t,common:{...t.common,issues:[]}},i=this._def.innerType._parse({data:s.data,path:s.path,parent:{...s}});return de(i)?i.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new P(s.common.issues)},input:s.data})})):{status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new P(s.common.issues)},input:s.data})}}removeCatch(){return this._def.innerType}}Ce.create=(n,e)=>new Ce({innerType:n,typeName:g.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...v(e)});class Ve extends x{_parse(e){if(this._getType(e)!==p.nan){const s=this._getOrReturnCtx(e);return u(s,{code:h.invalid_type,expected:p.nan,received:s.parsedType}),y}return{status:"valid",value:e.data}}}Ve.create=n=>new Ve({typeName:g.ZodNaN,...v(n)});class ts extends x{_parse(e){const{ctx:t}=this._processInputParams(e),s=t.data;return this._def.type._parse({data:s,path:t.path,parent:t})}unwrap(){return this._def.type}}class ke extends x{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:s.data,path:s.path,parent:s});return a.status==="aborted"?y:a.status==="dirty"?(t.dirty(),te(a.value)):this._def.out._parseAsync({data:a.value,path:s.path,parent:s})})();{const i=this._def.in._parseSync({data:s.data,path:s.path,parent:s});return i.status==="aborted"?y:i.status==="dirty"?(t.dirty(),{status:"dirty",value:i.value}):this._def.out._parseSync({data:i.value,path:s.path,parent:s})}}static create(e,t){return new ke({in:e,out:t,typeName:g.ZodPipeline})}}class Te extends x{_parse(e){const t=this._def.innerType._parse(e),s=i=>(q(i)&&(i.value=Object.freeze(i.value)),i);return de(t)?t.then(i=>s(i)):s(t)}unwrap(){return this._def.innerType}}Te.create=(n,e)=>new Te({innerType:n,typeName:g.ZodReadonly,...v(e)});var g;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(g||(g={}));const D=O.create,z=Y.create,at=xe.create;H.create;const Se=R.create,V=w.create,ss=he.create;ue.create;j.create;const se=be.create,Fe=X.create;pe.create;A.create;Q.create;const rt=V({x:z().int().min(0),y:z().int().min(0)}),is=V({tileId:z().int().min(0),position:rt,rotation:ss([se(0),se(90),se(180),se(270)]).optional()}),ns=V({id:D().min(1),name:D().min(1),zIndex:z().int(),visible:at(),tiles:Se(is)}),as=V({width:z().int().min(1).max(256),height:z().int().min(1).max(256),tileWidth:z().int().min(1),tileHeight:z().int().min(1)}),rs=V({position:rt,type:Fe(["floor","blocker","slow","hole","conveyor","hazard-burn","door","exit","spawn"]),direction:Fe(["north","east","south","west"]).optional(),doorId:D().optional(),open:at().optional(),damage:z().int().min(0).optional()}),os=V({id:D(),name:D(),author:D().optional(),created:D(),modified:D(),version:z().int().min(1)}),ls=V({version:se(1),metadata:os,grid:as,layers:Se(ns).min(1),tileBehaviors:Se(rs).optional()});function ds(n){return ls.parse(n)}function me(n,e={}){const t=n.toData();return e.pretty?JSON.stringify(t,null,2):JSON.stringify(t)}function fe(n){const e=JSON.parse(n),t=ds(e);return Z.fromData(t)}function cs(n,e){const t=me(n,{pretty:!0}),s=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download=e??`${n.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)}function ot(n){return new Promise((e,t)=>{const s=new FileReader;s.onload=i=>{var a;try{const r=(a=i.target)==null?void 0:a.result,o=fe(r);e(o)}catch(r){t(r)}},s.onerror=()=>{t(new Error("Failed to read file"))},s.readAsText(n)})}function hs(n,e="isometric_level"){const t=me(n);localStorage.setItem(e,t)}function us(n="isometric_level"){const e=localStorage.getItem(n);if(!e)return null;try{return fe(e)}catch{return null}}class ps{constructor(e,t){l(this,"canvas");l(this,"camera");l(this,"renderer");l(this,"tileRegistry");l(this,"state");l(this,"history");l(this,"_level");l(this,"tools",new Map);l(this,"activeTool",null);l(this,"animationFrameId",null);l(this,"isRunning",!1);l(this,"handleMouseDown",e=>{if(e.button!==0)return;const t=this.getGridCoord(e);t&&this.activeTool&&this.activeTool.onMouseDown(this.getToolContext(),t)});l(this,"handleMouseMove",e=>{const t=this.getGridCoord(e);if(this.state.setHoveredCoord(t),t?this.renderer.setHoveredCoord(t):this.renderer.setHoveredCoord(null),t&&this.activeTool){const s=(e.buttons&1)!==0;this.activeTool.onMouseMove(this.getToolContext(),t,s)}});l(this,"handleMouseUp",e=>{if(e.button!==0)return;const t=this.getGridCoord(e);t&&this.activeTool&&this.activeTool.onMouseUp(this.getToolContext(),t)});l(this,"handleMouseLeave",()=>{this.state.setHoveredCoord(null),this.renderer.setHoveredCoord(null)});l(this,"handleWheel",e=>{e.preventDefault();const t=-e.deltaY*.001,s=this.canvas.element.getBoundingClientRect(),i=e.clientX-s.left,a=e.clientY-s.top;this.camera.zoomBy(t,i,a)});l(this,"handleKeyDown",e=>{if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)){if(e.key==="z"&&(e.ctrlKey||e.metaKey)){e.shiftKey?this.history.redo():this.history.undo(),e.preventDefault();return}if(e.key==="y"&&(e.ctrlKey||e.metaKey)){this.history.redo(),e.preventDefault();return}if(e.key==="s"&&(e.ctrlKey||e.metaKey)){this.saveToStorage(),e.preventDefault();return}for(const t of this.tools.values())if(t.shortcut===e.key.toLowerCase()){this.setTool(t.type);return}}});l(this,"renderLoop",()=>{this.isRunning&&(this.render(),this.animationFrameId=requestAnimationFrame(this.renderLoop))});this.canvas=new Xe({canvas:e.canvas,container:e.container}),this.camera=new Qe({zoom:2}),this.tileRegistry=t,this.renderer=new et(this.canvas,this.camera,t),this.state=new wt,this.history=new Ct({maxSize:100}),this._level=Z.createDefault();const s=this._level.getLayers()[0];s&&this.state.setActiveLayer(s.config.id),this.registerTool(new Lt),this.registerTool(new It),this.setTool("brush"),this.setupEventListeners()}get level(){return this._level}registerTool(e){this.tools.set(e.type,e)}setTool(e){var i,a,r,o,d;const t=this.tools.get(e);if(!t)return;this.activeTool&&((a=(i=this.activeTool).onDeactivate)==null||a.call(i,this.getToolContext())),this.activeTool=t,(o=(r=this.activeTool).onActivate)==null||o.call(r,this.getToolContext()),this.state.setActiveTool(e);const s=((d=t.getCursor)==null?void 0:d.call(t))??"default";this.canvas.element.style.cursor=s}getToolContext(){return{level:this._level,editorState:this.state,history:this.history}}newLevel(e,t={}){const s=Z.createDefault(e,t);this.setLevel(s),this.camera.setPosition(0,0)}loadLevel(e){const t=fe(e);this.setLevel(t)}async loadLevelFromFile(e){const t=await ot(e);this.setLevel(t)}setLevel(e){this._level=e,this.history.clear();const t=this._level.getLayers()[0];t&&this.state.setActiveLayer(t.config.id),this.state.notifyLevelLoaded(e.toData()),this.state.markClean()}saveLevel(){const e=me(this._level,{pretty:!0});return this.history.markSaved(),this.state.markClean(),e}downloadLevel(e){cs(this._level,e),this.history.markSaved(),this.state.markClean()}saveToStorage(){hs(this._level),this.history.markSaved(),this.state.markClean()}loadFromStorage(){const e=us();return e?(this.setLevel(e),!0):!1}setupEventListeners(){const e=this.canvas.element;e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("mousemove",this.handleMouseMove),e.addEventListener("mouseup",this.handleMouseUp),e.addEventListener("mouseleave",this.handleMouseLeave),e.addEventListener("wheel",this.handleWheel,{passive:!1}),window.addEventListener("keydown",this.handleKeyDown)}getGridCoord(e){const t=this.canvas.element.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,a=this.renderer.screenToGrid(s,i,this._level);return this._level.isInBounds(a)?a:null}start(){this.isRunning||(this.isRunning=!0,this.renderLoop())}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}render(){this.renderer.render(this._level)}dispose(){this.stop();const e=this.canvas.element;e.removeEventListener("mousedown",this.handleMouseDown),e.removeEventListener("mousemove",this.handleMouseMove),e.removeEventListener("mouseup",this.handleMouseUp),e.removeEventListener("mouseleave",this.handleMouseLeave),e.removeEventListener("wheel",this.handleWheel),window.removeEventListener("keydown",this.handleKeyDown),this.canvas.dispose()}}class ms{constructor(e,t,s){l(this,"container");l(this,"editor");l(this,"tileRegistry");l(this,"selectedTileId",null);l(this,"tileElements",new Map);const i=document.getElementById(e);if(!i)throw new Error(`Container not found: ${e}`);this.container=i,this.editor=t,this.tileRegistry=s,this.render(),this.setupEventListeners()}render(){this.container.innerHTML="";const e=this.tileRegistry.getAllTileIds(),t=document.createElement("div");t.id="tile-grid";for(const s of e){const i=this.createTileItem(s);this.tileElements.set(s,i),t.appendChild(i)}this.container.appendChild(t)}createTileItem(e){const t=document.createElement("div");t.className="tile-item",t.dataset.tileId=String(e);const s=this.tileRegistry.createTilePreview(e,1.5);return s.style.imageRendering="pixelated",t.appendChild(s),t}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest(".tile-item");if(s&&s.dataset.tileId){const i=parseInt(s.dataset.tileId,10);this.selectTile(i)}}),this.editor.state.on("tile:selected",e=>{const{tileId:t}=e;this.updateSelection(t)})}selectTile(e){this.selectedTileId=e,this.editor.state.setSelectedTile(e),this.updateSelection(e)}updateSelection(e){if(this.tileElements.forEach(t=>{t.classList.remove("selected")}),e!==null){const t=this.tileElements.get(e);t==null||t.classList.add("selected")}this.selectedTileId=e}getSelectedTileId(){return this.selectedTileId}}class fs{constructor(e,t){l(this,"container");l(this,"editor");l(this,"layerElements",new Map);const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.render(),this.setupEventListeners()}render(){this.container.innerHTML="",this.layerElements.clear();const e=this.editor.level.getLayers(),t=this.editor.state.activeLayerId,s=[...e].reverse();for(const i of s){const a=this.createLayerItem(i,i.config.id===t);this.layerElements.set(i.config.id,a),this.container.appendChild(a)}}createLayerItem(e,t){const s=document.createElement("div");s.className=`layer-item${t?" active":""}`,s.dataset.layerId=e.config.id;const i=document.createElement("button");i.className="layer-visibility",i.textContent=e.config.visible?"":"",i.title=e.config.visible?"Hide layer":"Show layer",i.addEventListener("click",o=>{o.stopPropagation(),this.toggleLayerVisibility(e.config.id)});const a=document.createElement("span");a.className="layer-name",a.textContent=e.config.name;const r=document.createElement("span");return r.className="layer-count",r.textContent=String(e.tileCount),r.style.cssText="font-size: 11px; color: #666; margin-left: auto;",s.appendChild(i),s.appendChild(a),s.appendChild(r),s}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest(".layer-item");s&&s.dataset.layerId&&this.selectLayer(s.dataset.layerId)}),this.editor.state.on("layer:changed",()=>{this.updateActiveLayer()}),this.editor.history.on("change",()=>{this.updateTileCounts()}),this.editor.state.on("level:loaded",()=>{this.render()})}selectLayer(e){this.editor.state.setActiveLayer(e),this.updateActiveLayer()}toggleLayerVisibility(e){const t=this.editor.level.getLayer(e);t&&(t.toggleVisible(),this.render())}updateActiveLayer(){const e=this.editor.state.activeLayerId;this.layerElements.forEach((t,s)=>{s===e?t.classList.add("active"):t.classList.remove("active")})}updateTileCounts(){const e=this.editor.level.getLayers();for(const t of e){const s=this.layerElements.get(t.config.id);if(s){const i=s.querySelector(".layer-count");i&&(i.textContent=String(t.tileCount))}}}}const ys=[{type:"brush",name:"Brush",icon:"",shortcut:"B"},{type:"eraser",name:"Eraser",icon:"",shortcut:"E"}];class gs{constructor(e,t){l(this,"container");l(this,"editor");l(this,"buttonElements",new Map);l(this,"fileInput");l(this,"handleFileInputChange",async()=>{var t;const e=(t=this.fileInput.files)==null?void 0:t[0];if(e)try{await this.editor.loadLevelFromFile(e)}catch(s){const i=s instanceof Error?s.message:"Unknown error";window.alert(`Failed to import level: ${i}`)}finally{this.fileInput.value=""}});const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.fileInput=this.createFileInput(),this.render(),this.container.appendChild(this.fileInput),this.setupEventListeners()}render(){this.container.innerHTML="";for(const t of ys){const s=this.createToolButton(t);this.buttonElements.set(t.type,s),this.container.appendChild(s)}const e=document.createElement("div");e.style.cssText="width: 1px; height: 24px; background: #0f3460; margin: 0 8px;",this.container.appendChild(e),this.addActionButton("","Save (Ctrl+S)",()=>{this.editor.saveToStorage()}),this.addActionButton("","Import JSON",()=>{this.fileInput.click()}),this.addActionButton("","Download JSON",()=>{this.editor.downloadLevel()}),this.addActionButton("","Undo (Ctrl+Z)",()=>{this.editor.history.undo()}),this.addActionButton("","Redo (Ctrl+Y)",()=>{this.editor.history.redo()}),this.updateActiveButton()}createToolButton(e){const t=document.createElement("button");return t.className="tool-btn",t.dataset.tool=e.type,t.title=`${e.name} (${e.shortcut})`,t.textContent=`${e.icon} ${e.name}`,t}addActionButton(e,t,s){const i=document.createElement("button");i.className="tool-btn",i.title=t,i.textContent=e,i.addEventListener("click",s),this.container.appendChild(i)}createFileInput(){const e=document.createElement("input");return e.type="file",e.accept="application/json",e.style.display="none",e.addEventListener("change",this.handleFileInputChange),e}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest(".tool-btn[data-tool]");s&&s.dataset.tool&&this.editor.setTool(s.dataset.tool)}),this.editor.state.on("tool:changed",()=>{this.updateActiveButton()})}updateActiveButton(){const e=this.editor.state.activeTool;this.buttonElements.forEach((t,s)=>{s===e?t.classList.add("active"):t.classList.remove("active")})}}class vs{constructor(e){l(this,"positionEl");l(this,"tileEl");l(this,"layerEl");l(this,"editor");this.editor=e,this.positionEl=document.getElementById("status-position"),this.tileEl=document.getElementById("status-tile"),this.layerEl=document.getElementById("status-layer"),this.setupEventListeners(),this.update()}setupEventListeners(){this.editor.state.on("hover:changed",()=>{this.updatePosition()}),this.editor.state.on("tile:selected",()=>{this.updateTile()}),this.editor.state.on("layer:changed",()=>{this.updateLayer()})}update(){this.updatePosition(),this.updateTile(),this.updateLayer()}updatePosition(){const e=this.editor.state.hoveredCoord;e?this.positionEl.textContent=`Position: ${e.x}, ${e.y}`:this.positionEl.textContent="Position: --"}updateTile(){const e=this.editor.state.selectedTileId;e!==null?this.tileEl.textContent=`Tile: ${e}`:this.tileEl.textContent="Tile: --"}updateLayer(){const e=this.editor.state.activeLayerId;if(e){const t=this.editor.level.getLayer(e);this.layerEl.textContent=`Layer: ${(t==null?void 0:t.config.name)??e}`}else this.layerEl.textContent="Layer: --"}}class xs{constructor(e,t){l(this,"container");l(this,"editor");l(this,"zoomInput");l(this,"zoomValue");const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.zoomInput=document.createElement("input"),this.zoomValue=document.createElement("span"),this.render(),this.setupEventListeners(),this.updateZoomDisplay(this.editor.camera.zoom)}render(){this.container.innerHTML="";const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Zoom";const s=document.createElement("div");s.className="control-row",this.zoomInput.type="range",this.zoomInput.className="control-range",this.zoomInput.min=String(this.editor.camera.minZoomLevel),this.zoomInput.max=String(this.editor.camera.maxZoomLevel),this.zoomInput.step="0.1",this.zoomInput.value=String(this.editor.camera.zoom),this.zoomInput.setAttribute("aria-label","Zoom level"),this.zoomValue.className="control-value",s.appendChild(this.zoomInput),s.appendChild(this.zoomValue),e.appendChild(t),e.appendChild(s),this.container.appendChild(e)}setupEventListeners(){this.zoomInput.addEventListener("input",()=>{const e=Number(this.zoomInput.value),t=this.editor.canvas.element.getBoundingClientRect(),s=t.width/2,i=t.height/2;this.editor.camera.setZoom(e,s,i)}),this.editor.camera.onZoomChange(e=>{this.updateZoomDisplay(e)})}updateZoomDisplay(e){const t=Math.round(e*100)/100;this.zoomInput.value=String(t),this.zoomValue.textContent=`${Math.round(t*100)}%`}}const _s=[8,16,32,64,128];class bs{constructor(e,t){l(this,"container");l(this,"editor");l(this,"sizeButtons",new Map);l(this,"sizeMeta");l(this,"clearButton");const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.sizeMeta=document.createElement("div"),this.clearButton=document.createElement("button"),this.render(),this.setupEventListeners(),this.updateSizeDisplay()}render(){this.container.innerHTML="",this.sizeButtons.clear();const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Map Size",this.sizeMeta.className="control-meta";const s=document.createElement("div");s.className="button-group";for(const i of _s){const a=document.createElement("button");a.type="button",a.className="tool-btn size-btn",a.dataset.size=String(i),a.textContent=`${i}x${i}`,a.setAttribute("aria-pressed","false"),this.sizeButtons.set(i,a),s.appendChild(a)}e.appendChild(t),e.appendChild(this.sizeMeta),e.appendChild(s),this.clearButton.type="button",this.clearButton.className="tool-btn danger full-width",this.clearButton.textContent="Clear All",this.clearButton.title="Clear all tiles from all layers",this.container.appendChild(e),this.container.appendChild(this.clearButton)}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest("button[data-size]");if(s!=null&&s.dataset.size){const i=Number(s.dataset.size);this.confirmResize(i);return}}),this.clearButton.addEventListener("click",()=>{this.clearAllTiles()}),this.editor.state.on("level:loaded",()=>{this.updateSizeDisplay()})}confirmResize(e){const{gridWidth:t,gridHeight:s}=this.editor.level;if(t===e&&s===e||!window.confirm(`Resize map to ${e}x${e}? This will clear all tiles and start a new level.`))return;const a=this.editor.level.metadata.name;this.editor.newLevel(a,{width:e,height:e}),this.updateSizeDisplay()}clearAllTiles(){const t=this.editor.level.getLayers().filter(r=>r.tileCount>0);if(t.length===0||!window.confirm("Clear all tiles from every layer?"))return;const i=t.map(r=>new Et(this.editor.level,r.config.id)),a=new kt(i,"Clear all layers");this.editor.history.execute(a),this.editor.state.markDirty()}updateSizeDisplay(){const e=this.editor.level.gridWidth,t=this.editor.level.gridHeight;this.sizeMeta.textContent=`Current: ${e}x${t}`,this.sizeButtons.forEach((s,i)=>{const a=e===t&&i===e;s.classList.toggle("active",a),s.setAttribute("aria-pressed",String(a))})}}const Ue={floor:"rgba(74, 158, 255, 0.08)",blocker:"rgba(255, 74, 74, 0.45)",slow:"rgba(255, 199, 94, 0.35)",hole:"rgba(20, 20, 20, 0.6)",conveyor:"rgba(74, 158, 255, 0.22)","hazard-burn":"rgba(255, 132, 74, 0.38)",door:"rgba(156, 132, 255, 0.4)",exit:"rgba(74, 255, 198, 0.35)",spawn:"rgba(138, 255, 74, 0.32)"},ws="rgba(74, 255, 158, 0.5)",Cs="rgba(74, 158, 255, 0.65)",Ts="rgba(74, 255, 158, 0.9)",Ss="rgba(255, 221, 94, 0.9)",We="rgba(255, 132, 132, 0.9)";class ks{constructor(e){l(this,"canvas");l(this,"camera");l(this,"renderer");l(this,"tileRegistry");l(this,"level");l(this,"selected",null);l(this,"hovered",null);l(this,"clickMode","move");l(this,"listeners",new Map);l(this,"animationFrame",null);l(this,"lastTimestamp",0);l(this,"isRunning",!1);l(this,"isPaused",!0);l(this,"baseStepDuration",.25);l(this,"defaultHazardDamage",1);l(this,"defaultConveyorDirection","east");l(this,"hazardPenalty",2.5);l(this,"exitTile",null);l(this,"speedMultiplier",1);l(this,"player",{position:{x:0,y:0},spawn:null,hp:2,maxHp:2,alive:!0,reachedExit:!1,destination:null,path:[],segmentIndex:0,segmentProgress:0,currentStepDuration:.25,moving:!1,isAnimating:!1,stepMode:!1,pendingStep:!0,lastDamageAt:0,pathHasHazard:!1,state:"normal"});this.tileRegistry=e.tileRegistry,this.canvas=new Xe({canvas:e.canvas,container:e.container}),this.camera=new Qe({zoom:2}),this.renderer=new et(this.canvas,this.camera,this.tileRegistry),this.renderer.setOptions({showHover:!1,showSelection:!1}),this.level=Z.createDefault("Movement Test"),this.setupEventListeners(),this.resetPlayerPosition(),this.start()}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;return(s=this.listeners.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.listeners.get(e))==null||s.forEach(i=>{i(t)})}emitPlayerState(){const e=this.player.path[this.player.segmentIndex+1]??null;this.emit("player:updated",{position:{...this.player.position},hp:this.player.hp,maxHp:this.player.maxHp,alive:this.player.alive,spawn:this.player.spawn,stepMode:this.player.stepMode,reachedExit:this.player.reachedExit,destination:this.player.destination,nextStep:e,state:this.player.state,paused:this.isPaused,speed:this.speedMultiplier,pathHasHazard:this.player.pathHasHazard})}getLevel(){return this.level}getSelectedCoord(){return this.selected}getTileBehavior(e){const t=this.level.getTileBehavior(e);return t?t.type==="conveyor"?{type:"conveyor",direction:t.direction??this.defaultConveyorDirection}:t.type==="door"?{type:"door",doorId:t.doorId,open:t.open??!1}:t.type==="hazard-burn"?{type:"hazard-burn",damage:t.damage??this.defaultHazardDamage}:t:{type:"floor"}}setClickMode(e){this.clickMode!==e&&(this.clickMode=e,this.emit("mode:changed",{mode:e}))}setPaused(e){this.isPaused!==e&&(this.isPaused=e,this.emitPlayerState())}setSpeed(e){[1,2,4].includes(e)&&this.speedMultiplier!==e&&(this.speedMultiplier=e,this.emitPlayerState())}setStepMode(e){this.player.stepMode=e,this.player.pendingStep=!e,this.emitPlayerState()}setDefaultConveyorDirection(e){this.defaultConveyorDirection=e}setDefaultHazardDamage(e){Number.isFinite(e)&&(this.defaultHazardDamage=Math.max(1,Math.round(e)))}advanceTurn(){this.player.alive&&this.player.stepMode&&(this.player.pendingStep=!0)}async loadLevelFromFile(e){const t=await ot(e);this.setLevel(t)}useLevelClone(e){const t=me(e),s=fe(t);this.setLevel(s)}setLevel(e){this.level=e,this.isPaused=!0,this.exitTile=this.findExitTile(),this.selected=null,this.hovered=null,this.resetPlayerPosition(),this.emit("selection:changed",{coord:null,behavior:{type:"floor"}}),this.emit("level:changed",{level:e})}setSelectedKind(e){this.selected&&(this.setTileBehavior(this.selected,this.createDefaultBehavior(e)),this.emitSelection(this.selected))}setTileBehavior(e,t){if(!this.level.isInBounds(e))return;const s=this.getTileBehavior(e),i=this.isBlocked(e);this.level.setTileBehavior(e,t),((t==null?void 0:t.type)==="spawn"||this.player.spawn&&this.sameCoord(this.player.spawn,e))&&(this.player.spawn=this.findSpawnPoint()),((t==null?void 0:t.type)==="exit"||(s==null?void 0:s.type)==="exit")&&(this.exitTile=this.findExitTile(),this.planDefaultDestination()),this.player.destination&&this.player.moving&&i!==this.isBlocked(e)?this.rebuildPathToDestination():this.player.destination&&this.player.moving&&this.rebuildPathToDestination(),this.emitSelection(e)}updateSelectedBehavior(e){if(!this.selected)return;const t=this.getTileBehavior(this.selected);t.type!=="floor"&&this.setTileBehavior(this.selected,{...t,...e})}toggleDoorState(e){const t=this.getTileBehavior(e);t.type==="door"&&this.setTileBehavior(e,{...t,open:!t.open})}start(){this.isRunning||(this.isRunning=!0,this.lastTimestamp=performance.now(),this.loop(this.lastTimestamp))}stop(){this.isRunning=!1,this.animationFrame!==null&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)}resetPlayer(){this.isPaused=!0,this.resetPlayerPosition()}setupEventListeners(){const e=this.canvas.element;e.addEventListener("mousedown",t=>{if(t.button!==0)return;const s=this.screenToGrid(t);s&&(this.clickMode==="edit"?this.selectCoord(s):(this.selectCoord(s),this.movePlayerTo(s)))}),e.addEventListener("mousemove",t=>{const s=this.screenToGrid(t);this.hovered=s}),e.addEventListener("mouseleave",()=>{this.hovered=null}),e.addEventListener("wheel",t=>{t.preventDefault();const s=-t.deltaY*.001,i=e.getBoundingClientRect();this.camera.zoomBy(s,t.clientX-i.left,t.clientY-i.top)},{passive:!1})}selectCoord(e){this.selected=e,this.emitSelection(e)}emitSelection(e){this.emit("selection:changed",{coord:e,behavior:this.getTileBehavior(e)})}screenToGrid(e){const t=this.canvas.element.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,a=this.renderer.screenToGrid(s,i,this.level);return this.level.isInBounds(a)?a:null}resetPlayerPosition(){const e=this.findSpawnPoint()??this.findFirstWalkable()??{x:0,y:0};this.player.position=e,this.player.spawn=e,this.player.hp=this.player.maxHp,this.player.alive=!0,this.player.reachedExit=!1,this.player.state="normal",this.player.destination=null,this.player.path=[e],this.player.segmentIndex=0,this.player.segmentProgress=0,this.player.currentStepDuration=this.baseStepDuration,this.player.moving=!1,this.player.isAnimating=!1,this.player.pendingStep=!this.player.stepMode,this.player.pathHasHazard=!1,this.emit("path:updated",{hasPath:!1,path:this.player.path}),this.planDefaultDestination(),this.emitPlayerState()}createDefaultBehavior(e){switch(e){case"blocker":case"slow":case"hole":case"exit":case"spawn":return{type:e};case"conveyor":return{type:"conveyor",direction:this.defaultConveyorDirection};case"hazard-burn":return{type:"hazard-burn",damage:this.defaultHazardDamage};case"door":return{type:"door",open:!1};case"floor":default:return null}}planDefaultDestination(){if(!this.exitTile){this.player.destination=null,this.player.moving=!1,this.player.pathHasHazard=!1,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:this.player.path}),this.emitPlayerState();return}this.movePlayerTo(this.exitTile)}movePlayerTo(e){if(!this.level.isInBounds(e)||!this.player.alive||this.isBlocked(e))return;const t=this.roundCoord(this.player.position),s=this.findPath(t,e);if(!s||s.length===0){this.stopMovement();return}if(s.length<=1){this.player.destination=e,this.player.path=s,this.player.moving=!1,this.player.isAnimating=!1,this.player.pathHasHazard=!1,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:s}),this.emitPlayerState();return}this.player.destination=e,this.player.path=s,this.player.segmentIndex=0,this.player.segmentProgress=0,this.player.currentStepDuration=this.getStepDuration(s[1]??e),this.player.moving=!0,this.player.isAnimating=!1,this.player.pendingStep=!this.player.stepMode,this.player.pathHasHazard=this.pathContainsHazard(s,1),this.updateClopState(),this.emit("path:updated",{hasPath:!0,path:s}),this.emitPlayerState()}findPath(e,t){const s=this.key(e),i=this.key(t),a=[s],r=new Map,o=new Map([[s,0]]),d=new Map([[s,this.heuristic(e,t)]]);for(r.set(s,null);a.length>0;){a.sort((b,E)=>(d.get(b)??1/0)-(d.get(E)??1/0));const c=a.shift();if(c===i)return this.reconstructPath(r,c);const f=this.fromKey(c);for(const b of this.getNeighbors(f)){const E=this.key(b);if(this.isBlocked(b)||this.isHole(b))continue;const re=this.getTraversalCost(b);if(!Number.isFinite(re))continue;const ye=(o.get(c)??1/0)+re;ye<(o.get(E)??1/0)&&(r.set(E,c),o.set(E,ye),d.set(E,ye+this.heuristic(b,t)),a.includes(E)||a.push(E))}}return null}heuristic(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}getTraversalCost(e){const t=this.getTileBehavior(e).type;return t==="slow"?2.5:t==="hazard-burn"?this.hazardPenalty:1}getStepDuration(e){return this.getTileBehavior(e).type==="slow"?this.baseStepDuration*2.5:this.baseStepDuration}reconstructPath(e,t){const s=[this.fromKey(t)];let i=e.get(t);for(;i;)s.push(this.fromKey(i)),i=e.get(i);return s.reverse()}getNeighbors(e){return[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].filter(s=>this.level.isInBounds(s))}isBlocked(e){const t=this.getTileBehavior(e);return t.type==="blocker"||t.type==="door"&&!t.open}isHole(e){return this.getTileBehavior(e).type==="hole"}stopMovement(){this.player.moving=!1,this.player.isAnimating=!1,this.player.path=[this.roundCoord(this.player.position)],this.player.pathHasHazard=!1,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:this.player.path}),this.emitPlayerState()}roundCoord(e){return{x:Math.round(e.x),y:Math.round(e.y)}}loop(e){if(!this.isRunning)return;const t=e-this.lastTimestamp;this.lastTimestamp=e,this.update(t/1e3),this.render(),this.animationFrame=requestAnimationFrame(s=>this.loop(s))}update(e){if(!this.player.alive||(!this.player.destination&&this.exitTile&&this.movePlayerTo(this.exitTile),this.isPaused)||(this.shouldStartNextSegment()&&this.beginSegment(),!this.player.isAnimating||this.player.path.length<2))return;const t=this.player.segmentIndex,s=t+1,i=this.player.path[t],a=this.player.path[s];if(!i||!a){this.stopMovement();return}const r=e*this.speedMultiplier;if(this.player.segmentProgress+=r/this.player.currentStepDuration,this.player.segmentProgress>=1)this.player.position={x:a.x,y:a.y},this.player.segmentIndex=s,this.player.segmentProgress=0,this.player.isAnimating=!1,s>=this.player.path.length-1?(this.player.moving=!1,this.emit("path:updated",{hasPath:!1,path:this.player.path})):this.player.pendingStep=!this.player.stepMode,this.handleTileArrival(a);else{const o=this.player.segmentProgress;this.player.position={x:i.x+(a.x-i.x)*o,y:i.y+(a.y-i.y)*o}}}shouldStartNextSegment(){return!(!this.player.moving||this.player.isAnimating||this.player.segmentIndex>=this.player.path.length-1||this.isPaused||this.player.stepMode&&!this.player.pendingStep)}beginSegment(){const e=this.player.path[this.player.segmentIndex+1];e&&(this.player.currentStepDuration=this.getStepDuration(e),this.player.isAnimating=!0,this.player.pendingStep=!1)}handleTileArrival(e){const t=this.getTileBehavior(e);if(t.type==="spawn"&&(this.player.spawn=e),t.type==="hole"){this.player.alive=!1,this.player.moving=!1,this.player.destination=null,this.player.pathHasHazard=!1,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:[e]}),this.emitPlayerState();return}if(!(t.type==="hazard-burn"&&(this.applyDamage(t.damage??this.defaultHazardDamage),!this.player.alive))){if(t.type==="exit"){this.player.reachedExit=!0,this.player.moving=!1,this.player.pathHasHazard=!1,this.isPaused=!0,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:[e]}),this.emitPlayerState();return}if(t.type==="conveyor"){const s=this.getConveyorTarget(e,t.direction??this.defaultConveyorDirection);if(s){this.forceMoveTo(s);return}}if(this.player.destination&&!this.sameCoord(e,this.player.destination)&&this.player.alive){this.rebuildPathToDestination();return}if(this.player.destination&&this.sameCoord(e,this.player.destination)&&this.exitTile&&!this.sameCoord(e,this.exitTile)){this.movePlayerTo(this.exitTile);return}this.player.pathHasHazard=this.pathContainsHazard(this.player.path,this.player.segmentIndex+1),this.updateClopState(),this.emitPlayerState()}}getConveyorTarget(e,t){const s=t==="north"?{x:e.x,y:e.y-1}:t==="south"?{x:e.x,y:e.y+1}:t==="west"?{x:e.x-1,y:e.y}:{x:e.x+1,y:e.y};return!this.level.isInBounds(s)||this.isBlocked(s)?null:s}forceMoveTo(e){this.player.path=[this.roundCoord(this.player.position),e],this.player.segmentIndex=0,this.player.segmentProgress=0,this.player.currentStepDuration=this.getStepDuration(e),this.player.moving=!0,this.player.isAnimating=!1,this.player.pendingStep=!0,this.player.pathHasHazard=this.pathContainsHazard(this.player.path,1),this.updateClopState(),this.emit("path:updated",{hasPath:!0,path:this.player.path}),this.emitPlayerState()}rebuildPathToDestination(){if(!this.player.destination)return;const e=this.roundCoord(this.player.position),t=this.findPath(e,this.player.destination);if(!t||t.length===0){this.stopMovement(),this.emitPlayerState();return}this.player.path=t,this.player.segmentIndex=0,this.player.segmentProgress=0,this.player.currentStepDuration=this.getStepDuration(t[1]??this.player.destination),this.player.moving=!0,this.player.isAnimating=!1,this.player.pendingStep=!this.player.stepMode,this.player.pathHasHazard=this.pathContainsHazard(t,1),this.updateClopState(),this.emit("path:updated",{hasPath:!0,path:t}),this.emitPlayerState()}updateClopState(){this.player.alive&&(this.player.hp<this.player.maxHp?this.player.state="hurt":!this.player.destination||this.player.pathHasHazard||!this.player.moving&&this.player.path.length<=1?this.player.state="scared":this.player.state="normal")}applyDamage(e){this.player.hp=Math.max(0,this.player.hp-e),this.player.lastDamageAt=performance.now(),this.player.hp<=0&&(this.player.alive=!1,this.player.moving=!1,this.player.destination=null,this.player.pathHasHazard=!1,this.emit("path:updated",{hasPath:!1,path:[this.roundCoord(this.player.position)]})),this.updateClopState(),this.emitPlayerState()}render(){this.renderer.render(this.level);const e=this.canvas.ctx;e.save(),this.camera.applyTransform(e);const t=le(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,this.level.gridWidth,this.level.gridHeight);this.renderKindOverlays(e,t.x,t.y),this.renderSelection(e,t.x,t.y),this.renderPath(e,t.x,t.y),this.renderPlayer(e,t.x,t.y),e.restore()}renderKindOverlays(e,t,s){e.save(),e.font="10px sans-serif",e.textAlign="center",e.textBaseline="middle",e.strokeStyle="rgba(0,0,0,0.6)";for(let i=0;i<this.level.gridHeight;i++)for(let a=0;a<this.level.gridWidth;a++){const r={x:a,y:i},o=this.getTileBehavior(r),d=this.getOverlayColor(o);this.drawDiamond(e,r,t,s,d),this.drawTileIcon(e,r,o,t,s)}e.restore()}renderSelection(e,t,s){this.selected&&this.drawDiamond(e,this.selected,t,s,ws)}renderPath(e,t,s){if(this.player.path.length){e.strokeStyle=Cs,e.lineWidth=2,e.beginPath();for(let i=0;i<this.player.path.length;i++){const a=this.player.path[i];if(!a)continue;const r=I(a.x,a.y,t,s);i===0?e.moveTo(r.x,r.y+C/2):e.lineTo(r.x,r.y+C/2)}e.stroke()}}renderPlayer(e,t,s){const i=I(this.player.position.x,this.player.position.y,t,s),a=performance.now()-this.player.lastDamageAt<400,r=this.player.state==="hurt"?We:this.player.state==="scared"?Ss:Ts;e.fillStyle=a?We:r,e.beginPath(),e.arc(i.x,i.y+C/2,S/4,0,Math.PI*2),e.fill();const o=`${this.player.hp}/${this.player.maxHp}`;e.fillStyle="rgba(15,15,20,0.75)",e.strokeStyle="rgba(0,0,0,0.6)",e.lineWidth=2,this.drawRoundedRect(e,i.x-16,i.y-6,32,14,6),e.fill(),e.stroke(),e.fillStyle="#fff",e.font="10px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(o,i.x,i.y+1)}drawDiamond(e,t,s,i,a){const r=I(t.x,t.y,s,i);e.fillStyle=a,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(r.x+S/2,r.y+C/2),e.lineTo(r.x,r.y+C),e.lineTo(r.x-S/2,r.y+C/2),e.closePath(),e.fill()}drawTileIcon(e,t,s,i,a){const r=I(t.x,t.y,i,a),o=r.x,d=r.y+C/2;switch(s.type){case"hole":e.fillStyle="rgba(0,0,0,0.6)",e.beginPath(),e.ellipse(o,d+2,S/5,C/3,0,0,Math.PI*2),e.fill();break;case"conveyor":this.drawArrow(e,o,d,s.direction??this.defaultConveyorDirection);break;case"hazard-burn":this.drawFlame(e,o,d);break;case"door":this.drawDoor(e,o,d,s.open??!1);break;case"exit":this.drawStar(e,o,d,"#4affc6");break;case"spawn":this.drawStar(e,o,d,"#8aff4a",4);break}}drawArrow(e,t,s,i){e.save(),e.strokeStyle="#d2e8ff",e.fillStyle="#d2e8ff",e.lineWidth=2,e.beginPath();const a=8,r=i==="east"?1:i==="west"?-1:0,o=i==="south"?1:i==="north"?-1:0;e.moveTo(t-r*a*.4,s-o*a*.4),e.lineTo(t+r*a*.8,s+o*a*.8),e.stroke(),e.beginPath(),e.moveTo(t+r*a,s+o*a),e.lineTo(t+r*a-o*4+r*2,s+o*a+r*4+o*2),e.lineTo(t+r*a+o*4+r*2,s+o*a-r*4+o*2),e.closePath(),e.fill(),e.restore()}drawFlame(e,t,s){e.save(),e.fillStyle="#ffb347",e.beginPath(),e.moveTo(t,s-6),e.quadraticCurveTo(t+6,s-2,t,s+6),e.quadraticCurveTo(t-6,s-2,t,s-6),e.fill(),e.fillStyle="#ff6b3d",e.beginPath(),e.moveTo(t,s-4),e.quadraticCurveTo(t+3,s,t,s+4),e.quadraticCurveTo(t-3,s,t,s-4),e.fill(),e.restore()}drawDoor(e,t,s,i){e.save(),e.fillStyle=i?"rgba(200,255,200,0.9)":"rgba(120,90,180,0.9)",e.strokeStyle="rgba(0,0,0,0.45)",e.lineWidth=2,this.drawRoundedRect(e,t-8,s-6,16,12,3),e.fill(),e.stroke(),i||(e.beginPath(),e.moveTo(t-4,s),e.lineTo(t+4,s),e.stroke()),e.restore()}drawStar(e,t,s,i,a=5){e.save(),e.fillStyle=i;const r=7,o=3,d=Math.PI/a;e.beginPath();for(let c=0;c<2*a;c++){const f=c%2===0?r:o,b=c*d-Math.PI/2;e.lineTo(t+Math.cos(b)*f,s+Math.sin(b)*f)}e.closePath(),e.fill(),e.restore()}getOverlayColor(e){return e.type==="door"&&e.open?"rgba(138, 255, 200, 0.3)":Ue[e.type]??Ue.floor}findFirstWalkable(){for(let e=0;e<this.level.gridHeight;e++)for(let t=0;t<this.level.gridWidth;t++){const s={x:t,y:e},i=this.getTileBehavior(s);if(!this.isBlocked(s)&&i.type!=="hole")return s}return null}findExitTile(){let e=null;return this.level.forEachTileBehavior(t=>{t.type==="exit"&&!e&&(e=t.position)}),e}findSpawnPoint(){let e=null;return this.level.forEachTileBehavior(t=>{t.type==="spawn"&&!e&&(e=t.position)}),e}pathContainsHazard(e,t=0){return e.slice(t).some(s=>this.getTileBehavior(s).type==="hazard-burn")}sameCoord(e,t){return!!e&&!!t&&e.x===t.x&&e.y===t.y}drawRoundedRect(e,t,s,i,a,r){const o=Math.min(r,i/2,a/2);e.beginPath(),e.moveTo(t+o,s),e.lineTo(t+i-o,s),e.quadraticCurveTo(t+i,s,t+i,s+o),e.lineTo(t+i,s+a-o),e.quadraticCurveTo(t+i,s+a,t+i-o,s+a),e.lineTo(t+o,s+a),e.quadraticCurveTo(t,s+a,t,s+a-o),e.lineTo(t,s+o),e.quadraticCurveTo(t,s,t+o,s),e.closePath()}key(e){return`${e.x},${e.y}`}fromKey(e){const[t,s]=e.split(","),i=Number(t??0),a=Number(s??0);return{x:i,y:a}}}const Es=0,Ls=60;function F(n,e,t){const s=Z.createDefault(n,{width:e,height:t});for(let i=0;i<t;i++)for(let a=0;a<e;a++)s.setTile("terrain",{x:a,y:i},{tileId:Es});return s}function T(n,e,t){n.setTileBehavior(e,t)}function ee(n,e){e.forEach(t=>{n.setTileBehavior(t,{type:"blocker"}),n.setTile("terrain",t,{tileId:Ls})})}function L(n,e,t){e.forEach(s=>n.setTileBehavior(s,t))}function Is(){const n=F("Test Map 1: Slow Path",8,6);return T(n,{x:1,y:5},{type:"spawn"}),T(n,{x:6,y:0},{type:"exit"}),ee(n,[{x:0,y:3},{x:1,y:3},{x:2,y:3},{x:5,y:3},{x:5,y:1},{x:5,y:0}]),L(n,[{x:1,y:4},{x:2,y:4},{x:3,y:4},{x:4,y:3},{x:4,y:2},{x:5,y:2},{x:6,y:2},{x:6,y:1}],{type:"slow"}),n}function Bs(){const n=F("Test Map 2: Hole Maze",10,8);return T(n,{x:1,y:7},{type:"spawn"}),T(n,{x:8,y:1},{type:"exit"}),ee(n,[{x:0,y:4},{x:1,y:4},{x:2,y:4},{x:3,y:4},{x:6,y:4},{x:7,y:4},{x:8,y:4},{x:9,y:4},{x:4,y:0},{x:4,y:1},{x:4,y:2},{x:4,y:3}]),L(n,[{x:2,y:6},{x:3,y:6},{x:4,y:6},{x:6,y:6},{x:6,y:5},{x:6,y:3},{x:7,y:2},{x:5,y:1}],{type:"hole"}),n}function zs(){const n=F("Test Map 3: Conveyor Loop",8,8);return T(n,{x:1,y:6},{type:"spawn"}),T(n,{x:6,y:1},{type:"exit"}),ee(n,[{x:3,y:3},{x:3,y:4},{x:4,y:3},{x:4,y:4},{x:2,y:1},{x:5,y:6}]),L(n,[{x:1,y:5},{x:2,y:5},{x:3,y:5}],{type:"conveyor",direction:"east"}),L(n,[{x:4,y:5},{x:5,y:5}],{type:"conveyor",direction:"north"}),L(n,[{x:5,y:4},{x:5,y:3},{x:5,y:2}],{type:"conveyor",direction:"west"}),L(n,[{x:4,y:2},{x:3,y:2}],{type:"conveyor",direction:"north"}),L(n,[{x:3,y:1},{x:4,y:1}],{type:"conveyor",direction:"east"}),n}function Rs(){const n=F("Test Map 4: Hazard Run",7,10);T(n,{x:3,y:9},{type:"spawn"}),T(n,{x:3,y:0},{type:"exit"}),T(n,{x:3,y:8},{type:"door",doorId:"A",open:!1}),ee(n,[{x:1,y:5},{x:2,y:5},{x:4,y:5},{x:5,y:5}]);const e=[];for(let t=1;t<=7;t++)e.push({x:3,y:t});return L(n,e,{type:"hazard-burn",damage:1}),L(n,[{x:2,y:7},{x:4,y:7}],{type:"hole"}),n}const lt=[{id:"slow-path",name:"Test Map 1",description:"Simple path with slow tiles.",phase:1,build:Is},{id:"hole-maze",name:"Test Map 2",description:"Maze featuring holes and blockers.",phase:1,build:Bs},{id:"conveyor-puzzle",name:"Test Map 3",description:"Conveyor loop that pushes the token around.",phase:1,build:zs},{id:"hazard-run",name:"Test Map 4",description:"Hazard gauntlet with a blocking door.",phase:1,build:Rs}];function Ps(){const n=F("Test Map 5: Straight Shot",10,3);return T(n,{x:1,y:1},{type:"spawn"}),T(n,{x:8,y:1},{type:"exit"}),n}function Ms(){const n=F("Test Map 6: Obstacle Maze",10,8);return T(n,{x:1,y:6},{type:"spawn"}),T(n,{x:8,y:1},{type:"exit"}),ee(n,[{x:3,y:1},{x:3,y:2},{x:3,y:3},{x:3,y:4},{x:5,y:3},{x:6,y:3},{x:7,y:3},{x:7,y:4},{x:2,y:6},{x:4,y:6},{x:6,y:6},{x:7,y:6}]),L(n,[{x:5,y:5},{x:5,y:4},{x:5,y:2}],{type:"slow"}),n}function Ds(){const n=F("Test Map 7: Hazard Shortcut",9,7);return T(n,{x:1,y:5},{type:"spawn"}),T(n,{x:7,y:1},{type:"exit"}),ee(n,[{x:3,y:2},{x:3,y:3},{x:3,y:4},{x:5,y:1},{x:5,y:2},{x:5,y:3},{x:5,y:4},{x:5,y:5}]),L(n,[{x:2,y:5},{x:3,y:5},{x:4,y:5}],{type:"slow"}),L(n,[{x:4,y:2},{x:4,y:1},{x:6,y:1},{x:6,y:2}],{type:"hazard-burn",damage:1}),n}const dt=[{id:"straight-shot",name:"Test Map 5",description:"Straight line to the exit (basic pathfinding).",phase:2,build:Ps},{id:"obstacle-maze",name:"Test Map 6",description:"Maze that forces rerouting around blockers.",phase:2,build:Ms},{id:"hazard-shortcut",name:"Test Map 7",description:"Choose between safe detour or hazardous shortcut.",phase:2,build:Ds}];[...lt,...dt];class Ns{constructor(e,t,s){l(this,"container");l(this,"tester");l(this,"editor");l(this,"fileInput");l(this,"modeButtons",new Map);l(this,"kindButtons",new Map);l(this,"scenarioButtons",new Map);l(this,"selectionLabel");l(this,"kindLabel");l(this,"pathLabel");l(this,"hpLabel");l(this,"stateLabel");l(this,"nextMoveLabel");l(this,"stepLabel");l(this,"statusLabel");l(this,"stepToggleBtn");l(this,"advanceBtn");l(this,"resetBtn");l(this,"playPauseBtn");l(this,"speedButtons",new Map);l(this,"directionSelect");l(this,"doorIdInput");l(this,"doorToggleBtn");l(this,"hazardDamageInput");l(this,"propertyRows",{direction:document.createElement("div"),doorId:document.createElement("div"),doorState:document.createElement("div"),hazard:document.createElement("div")});l(this,"selectedCoord",null);l(this,"selectionBehavior",{type:"floor"});l(this,"playerState",null);l(this,"hasPath",!1);const i=document.getElementById(e);if(!i)throw new Error(`Container not found: ${e}`);this.container=i,this.tester=t,this.editor=s,this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".json,application/json",this.fileInput.style.display="none",this.selectionLabel=document.createElement("div"),this.kindLabel=document.createElement("div"),this.pathLabel=document.createElement("div"),this.hpLabel=document.createElement("div"),this.stateLabel=document.createElement("div"),this.nextMoveLabel=document.createElement("div"),this.stepLabel=document.createElement("div"),this.statusLabel=document.createElement("div"),this.playPauseBtn=document.createElement("button"),this.stepToggleBtn=document.createElement("button"),this.advanceBtn=document.createElement("button"),this.resetBtn=document.createElement("button"),this.directionSelect=document.createElement("select"),this.doorIdInput=document.createElement("input"),this.doorToggleBtn=document.createElement("button"),this.hazardDamageInput=document.createElement("input"),this.render(),this.setupListeners()}render(){this.container.innerHTML="",this.container.appendChild(this.fileInput),this.container.appendChild(this.renderLoadSection()),this.container.appendChild(this.renderScenarioSection("Phase 1 Test Maps",lt)),this.container.appendChild(this.renderScenarioSection("Phase 2 Test Maps",dt)),this.container.appendChild(this.renderMovementSection()),this.container.appendChild(this.renderModeSection()),this.container.appendChild(this.renderKindSection()),this.container.appendChild(this.renderPropertiesSection()),this.container.appendChild(this.renderLegendSection()),this.container.appendChild(this.renderStatusSection())}renderLoadSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Map Input";const s=document.createElement("button");s.className="tool-btn full-width",s.type="button",s.textContent="Load Map JSON",s.addEventListener("click",()=>this.fileInput.click());const i=document.createElement("button");return i.className="tool-btn full-width",i.type="button",i.textContent="Use Current Editor Map",i.addEventListener("click",()=>{this.tester.useLevelClone(this.editor.level)}),e.appendChild(t),e.appendChild(s),e.appendChild(i),e}renderScenarioSection(e,t){const s=document.createElement("div");s.className="control-group";const i=document.createElement("div");i.className="control-label",i.textContent=e;const a=document.createElement("div");return a.className="button-group",t.forEach(r=>{const o=document.createElement("button");o.type="button",o.className="tool-btn small",o.textContent=r.name,o.title=r.description,o.addEventListener("click",()=>{const d=r.build();this.tester.setLevel(d)}),this.scenarioButtons.set(r.id,o),a.appendChild(o)}),s.appendChild(i),s.appendChild(a),s}renderMovementSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Simulation";const s=document.createElement("div");s.className="button-group",this.playPauseBtn.type="button",this.playPauseBtn.className="tool-btn small",this.playPauseBtn.textContent="Play",this.playPauseBtn.addEventListener("click",()=>{var o;const r=((o=this.playerState)==null?void 0:o.paused)??!0;this.tester.setPaused(!r)});const i=document.createElement("div");i.className="button-group",this.addSpeedButton(i,1),this.addSpeedButton(i,2),this.addSpeedButton(i,4);const a=document.createElement("div");return a.className="button-group",this.stepToggleBtn.type="button",this.stepToggleBtn.className="tool-btn small",this.stepToggleBtn.textContent="Step-by-step: Off",this.stepToggleBtn.addEventListener("click",()=>{var o;const r=!(((o=this.playerState)==null?void 0:o.stepMode)??!1);this.tester.setStepMode(r),this.updateStepToggle(r)}),this.advanceBtn.type="button",this.advanceBtn.className="tool-btn small",this.advanceBtn.textContent="Advance Turn",this.advanceBtn.addEventListener("click",()=>this.tester.advanceTurn()),this.resetBtn.type="button",this.resetBtn.className="tool-btn small",this.resetBtn.textContent="Reset to Spawn",this.resetBtn.addEventListener("click",()=>this.tester.resetPlayer()),s.appendChild(this.playPauseBtn),a.appendChild(this.stepToggleBtn),a.appendChild(this.advanceBtn),a.appendChild(this.resetBtn),e.appendChild(t),e.appendChild(s),e.appendChild(i),e.appendChild(a),e}addSpeedButton(e,t){const s=document.createElement("button");s.type="button",s.className="tool-btn small",s.textContent=`${t}x`,s.addEventListener("click",()=>{this.tester.setSpeed(t),this.updateSpeedButtons(t)}),this.speedButtons.set(t,s),e.appendChild(s)}renderModeSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Canvas Click Action";const s=document.createElement("div");return s.className="button-group",this.addModeButton(s,"move","Move Token"),this.addModeButton(s,"edit","Select Tile"),e.appendChild(t),e.appendChild(s),e}addModeButton(e,t,s){const i=document.createElement("button");i.type="button",i.className="tool-btn small",i.dataset.mode=t,i.textContent=s,i.addEventListener("click",()=>{this.tester.setClickMode(t),this.updateModeButtons(t)}),this.modeButtons.set(t,i),e.appendChild(i)}renderKindSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Tile Kind";const s=document.createElement("div");return s.className="button-group",this.addKindButton(s,"floor","Floor"),this.addKindButton(s,"blocker","Blocker"),this.addKindButton(s,"slow","Slow"),this.addKindButton(s,"hole","Hole"),this.addKindButton(s,"conveyor","Conveyor"),this.addKindButton(s,"hazard-burn","Hazard (Burn)"),this.addKindButton(s,"door","Door"),this.addKindButton(s,"exit","Exit"),this.addKindButton(s,"spawn","Spawn"),e.appendChild(t),e.appendChild(s),e}addKindButton(e,t,s){const i=document.createElement("button");i.type="button",i.className="tool-btn small",i.dataset.kind=t,i.textContent=s,i.addEventListener("click",()=>{this.tester.setSelectedKind(t),this.updateKindButtons(t)}),this.kindButtons.set(t,i),e.appendChild(i)}renderPropertiesSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Tile Properties",this.propertyRows.direction.className="control-row";const s=document.createElement("span");s.className="control-meta",s.textContent="Conveyor Direction",["north","east","south","west"].forEach(o=>{const d=document.createElement("option");d.value=o,d.textContent=o,this.directionSelect.appendChild(d)}),this.directionSelect.addEventListener("change",()=>{const o=this.directionSelect.value;this.tester.setDefaultConveyorDirection(o),this.selectionBehavior.type==="conveyor"&&this.tester.updateSelectedBehavior({direction:o})}),this.propertyRows.direction.appendChild(s),this.propertyRows.direction.appendChild(this.directionSelect),this.propertyRows.doorId.className="control-row";const i=document.createElement("span");i.className="control-meta",i.textContent="Door Link ID",this.doorIdInput.type="text",this.doorIdInput.placeholder="e.g., A1",this.doorIdInput.addEventListener("input",()=>{this.selectionBehavior.type==="door"&&this.tester.updateSelectedBehavior({doorId:this.doorIdInput.value})}),this.propertyRows.doorId.appendChild(i),this.propertyRows.doorId.appendChild(this.doorIdInput),this.propertyRows.doorState.className="control-row";const a=document.createElement("span");a.className="control-meta",a.textContent="Door State",this.doorToggleBtn.type="button",this.doorToggleBtn.className="tool-btn small",this.doorToggleBtn.textContent="Toggle Door",this.doorToggleBtn.addEventListener("click",()=>{this.selectedCoord&&this.tester.toggleDoorState(this.selectedCoord)}),this.propertyRows.doorState.appendChild(a),this.propertyRows.doorState.appendChild(this.doorToggleBtn),this.propertyRows.hazard.className="control-row";const r=document.createElement("span");return r.className="control-meta",r.textContent="Hazard Damage",this.hazardDamageInput.type="number",this.hazardDamageInput.min="1",this.hazardDamageInput.value="1",this.hazardDamageInput.addEventListener("change",()=>{const o=parseInt(this.hazardDamageInput.value,10);this.tester.setDefaultHazardDamage(o),this.selectionBehavior.type==="hazard-burn"&&this.tester.updateSelectedBehavior({damage:o||1})}),this.propertyRows.hazard.appendChild(r),this.propertyRows.hazard.appendChild(this.hazardDamageInput),e.appendChild(t),e.appendChild(this.propertyRows.direction),e.appendChild(this.propertyRows.doorId),e.appendChild(this.propertyRows.doorState),e.appendChild(this.propertyRows.hazard),this.updatePropertyVisibility(this.selectionBehavior),e}renderLegendSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Legend";const s=document.createElement("div");return s.className="legend-grid",s.appendChild(this.createLegendRow("Floor","#4a9eff")),s.appendChild(this.createLegendRow("Blocker","#ff4a4a")),s.appendChild(this.createLegendRow("Slow","#ffc75e")),s.appendChild(this.createLegendRow("Hole","#303040")),s.appendChild(this.createLegendRow("Conveyor","#87c4ff")),s.appendChild(this.createLegendRow("Hazard (Burn)","#ff8451")),s.appendChild(this.createLegendRow("Door","#9c84ff")),s.appendChild(this.createLegendRow("Exit","#4affc6")),s.appendChild(this.createLegendRow("Spawn","#8aff4a")),e.appendChild(t),e.appendChild(s),e}createLegendRow(e,t){const s=document.createElement("div");s.className="kind-row";const i=document.createElement("span");i.className="kind-indicator",i.style.backgroundColor=t;const a=document.createElement("span");return a.textContent=e,s.appendChild(i),s.appendChild(a),s}renderStatusSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");return t.className="control-label",t.textContent="Status",this.selectionLabel.className="control-meta",this.kindLabel.className="control-meta",this.pathLabel.className="control-meta",this.hpLabel.className="control-meta",this.stateLabel.className="control-meta",this.nextMoveLabel.className="control-meta",this.stepLabel.className="control-meta",this.statusLabel.className="control-meta",e.appendChild(t),e.appendChild(this.selectionLabel),e.appendChild(this.kindLabel),e.appendChild(this.pathLabel),e.appendChild(this.hpLabel),e.appendChild(this.stateLabel),e.appendChild(this.nextMoveLabel),e.appendChild(this.stepLabel),e.appendChild(this.statusLabel),this.updateSelectionStatus(null,{type:"floor"}),this.updatePathStatus(!1,[]),this.updatePlayerStatus({hp:3,maxHp:3,alive:!0,reachedExit:!1,state:"normal",paused:!0,speed:1,nextStep:null,pathHasHazard:!1,stepMode:!1,destination:null,spawn:null}),e}setupListeners(){this.fileInput.addEventListener("change",async()=>{var t;const e=(t=this.fileInput.files)==null?void 0:t[0];if(e)try{await this.tester.loadLevelFromFile(e)}finally{this.fileInput.value=""}}),this.tester.on("selection:changed",({coord:e,behavior:t})=>{this.selectedCoord=e,this.selectionBehavior=t,this.updateSelectionStatus(e,t),this.updateKindButtons(t.type),this.syncProperties(t)}),this.tester.on("mode:changed",({mode:e})=>{this.updateModeButtons(e)}),this.tester.on("level:changed",()=>{this.updateSelectionStatus(null,{type:"floor"}),this.updatePathStatus(!1,[])}),this.tester.on("path:updated",({hasPath:e,path:t})=>{this.hasPath=e,this.updatePathStatus(e,t)}),this.tester.on("player:updated",e=>{this.playerState=e,this.updatePlayerStatus(e),this.updateStepToggle(e.stepMode),this.updatePlayPause(e.paused),this.updateSpeedButtons(e.speed),this.refreshButtonStates()}),this.updateModeButtons("move"),this.updateKindButtons("floor"),this.updatePlayPause(!0),this.updateSpeedButtons(1),this.refreshButtonStates()}updateSelectionStatus(e,t){e?this.selectionLabel.textContent=`Tile: ${e.x}, ${e.y}`:this.selectionLabel.textContent="Tile: --",this.kindLabel.textContent=`Kind: ${t.type}`}updateModeButtons(e){this.modeButtons.forEach((t,s)=>{const i=s===e;t.classList.toggle("active",i),t.setAttribute("aria-pressed",String(i))})}updateKindButtons(e){this.kindButtons.forEach((t,s)=>{const i=s===e;t.classList.toggle("active",i),t.setAttribute("aria-pressed",String(i))})}updatePathStatus(e,t){var i;const s=(i=this.playerState)!=null&&i.pathHasHazard?" (hazard ahead)":"";e&&t.length>1?this.pathLabel.textContent=`Path: ${t.length-1} steps${s}`:this.pathLabel.textContent="Path: none",this.refreshButtonStates()}updatePlayerStatus(e){this.hpLabel.textContent=`HP: ${e.hp}/${e.maxHp}`;const t=e.spawn?`Spawn: ${e.spawn.x}, ${e.spawn.y}`:"Spawn: --",s=e.destination?`Destination: ${e.destination.x}, ${e.destination.y}`:"Destination: --";this.stepLabel.textContent=`${t}  ${s}`;const i=e.nextStep?`${e.nextStep.x}, ${e.nextStep.y}`:"--";if(this.stateLabel.textContent=`State: ${e.state}`,this.nextMoveLabel.textContent=`Next Move: ${i}`,!e.alive)this.statusLabel.textContent="Status: Down (reset to respawn)";else if(e.reachedExit)this.statusLabel.textContent="Status: Exit reached";else{const a=e.stepMode?"Step-by-step":"Auto movement";this.statusLabel.textContent=e.paused?"Status: Paused":`Status: ${a}`}}updateStepToggle(e){this.stepToggleBtn.textContent=e?"Step-by-step: On":"Step-by-step: Off",this.stepToggleBtn.classList.toggle("active",e)}updatePlayPause(e){this.playPauseBtn.textContent=e?"Play":"Pause",this.playPauseBtn.classList.toggle("active",!e)}updateSpeedButtons(e){this.speedButtons.forEach((t,s)=>{const i=s===e;t.classList.toggle("active",i),t.setAttribute("aria-pressed",String(i))})}syncProperties(e){e.type==="conveyor"&&e.direction&&(this.directionSelect.value=e.direction),e.type==="door"&&(this.doorIdInput.value=e.doorId??"",this.doorToggleBtn.textContent=e.open?"Close Door":"Open Door"),e.type==="hazard-burn"&&e.damage&&(this.hazardDamageInput.value=String(e.damage)),this.updatePropertyVisibility(e)}updatePropertyVisibility(e){this.propertyRows.direction.style.display=e.type==="conveyor"?"flex":"none",this.propertyRows.doorId.style.display=e.type==="door"?"flex":"none",this.propertyRows.doorState.style.display=e.type==="door"?"flex":"none",this.propertyRows.hazard.style.display=e.type==="hazard-burn"?"flex":"none"}refreshButtonStates(){var t,s,i;const e=((t=this.playerState)==null?void 0:t.alive)??!0;this.advanceBtn.disabled=!e||!this.hasPath||!(((s=this.playerState)==null?void 0:s.paused)??!0)||!(((i=this.playerState)==null?void 0:i.stepMode)??!1),this.resetBtn.disabled=!1}}async function Ke(){console.log("Initializing Isometric Level Editor...");const n=document.createElement("div");n.id="loading",n.style.cssText=`
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    color: #4a9eff;
    z-index: 1000;
  `,n.textContent="Loading assets...",document.body.appendChild(n);try{const e=new vt;await e.initialize(),console.log(`Loaded ${e.getTileCount()} tiles`);const t=new ps({canvas:"#editor-canvas",container:"#canvas-stack"},e),s=t.loadFromStorage();console.log(s?"Loaded level from localStorage":"Created new default level");const i=new gs("toolbar",t),a=new xs("view-controls",t),r=new bs("map-controls",t),o=new fs("layer-list",t),d=new ms("tile-palette",t,e),c=new vs(t),f=new ks({canvas:"#movement-canvas",container:"#canvas-stack",tileRegistry:e}),b=new Ns("movement-controls",f,t);d.selectTile(0),t.start(),f.start(),Os(),window.editor=t,n.remove(),console.log("Editor initialized successfully!"),console.log("Controls:"),console.log("  - Click to place tiles"),console.log("  - B: Brush tool"),console.log("  - E: Eraser tool"),console.log("  - Ctrl+Z: Undo"),console.log("  - Ctrl+Y/Ctrl+Shift+Z: Redo"),console.log("  - Ctrl+S: Save to localStorage"),console.log("  - Mouse wheel: Zoom")}catch(e){console.error("Failed to initialize editor:",e),n.textContent=`Error: ${e instanceof Error?e.message:"Unknown error"}`,n.style.color="#ff4a4a"}}function Os(){const n=document.getElementById("canvas-mode-toggle"),e=document.getElementById("sidebar-active-title"),t=document.getElementById("editor-canvas"),s=document.getElementById("movement-canvas"),i=document.getElementById("editor-pane"),a=document.getElementById("movement-pane");if(!n||!t||!s||!i||!a)return;const r=o=>{const d=o==="editor";t.classList.toggle("inactive",!d),s.classList.toggle("inactive",d),i.classList.toggle("active",d),a.classList.toggle("active",!d),n.querySelectorAll("button[data-canvas]").forEach(c=>{const f=c.dataset.canvas;c.classList.toggle("active",f===o)}),e&&(e.textContent=d?"Map Editor":"Movement Tester")};n.addEventListener("click",o=>{const c=o.target.closest("button[data-canvas]");if(!c)return;const f=c.dataset.canvas==="movement"?"movement":"editor";r(f)}),r("editor")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ke):Ke();
