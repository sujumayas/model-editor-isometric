var pt=Object.defineProperty;var mt=(a,e,t)=>e in a?pt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var l=(a,e,t)=>mt(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const q=32,H=32,k=32,_=16,tt=8,st=8,ft="isometric tileset/spritesheet.png",ce=115,yt=[{id:"terrain",name:"Terrain",zIndex:0},{id:"props",name:"Props",zIndex:10},{id:"decorations",name:"Decorations",zIndex:20}],ze="rgba(255, 255, 255, 0.1)",gt="rgba(74, 255, 158, 0.5)",vt="rgba(74, 158, 255, 0.3)";function bt(a){return new Promise((e,t)=>{const s=new Image;s.onload=()=>e(s),s.onerror=()=>t(new Error(`Failed to load image: ${a}`)),s.src=a})}async function Ct(a){return bt(a)}const Me=11,Re=[{id:"dirt",name:"Dirt/Soil",startId:0,endId:19},{id:"grass-transition",name:"Grass Transition",startId:20,endId:28},{id:"vegetation",name:"Vegetation",startId:29,endId:39},{id:"props",name:"Props",startId:40,endId:59},{id:"rocks-brown",name:"Brown Rocks",startId:60,endId:66},{id:"rocks-gray",name:"Gray Rocks",startId:67,endId:81},{id:"ice",name:"Ice/Snow",startId:82,endId:89},{id:"water-deep",name:"Deep Water",startId:90,endId:99},{id:"water-shallow",name:"Shallow Water",startId:100,endId:114}];class xt{constructor(){l(this,"spritesheet",null);l(this,"uvCache",new Map);l(this,"_isReady",!1)}async initialize(){this.spritesheet=await Ct(ft),this.buildUVCache(),this._isReady=!0}get isReady(){return this._isReady}getSpritesheet(){if(!this.spritesheet)throw new Error("TileRegistry not initialized. Call initialize() first.");return this.spritesheet}getTileUV(e){const t=this.uvCache.get(e);if(!t)throw new Error(`Invalid tile ID: ${e}`);return t}isValidTileId(e){return e>=0&&e<ce}getTileCount(){return ce}getAllTileIds(){return Array.from({length:ce},(e,t)=>t)}getTilesByCategory(e){const t=Re.find(i=>i.id===e);if(!t)return[];const s=[];for(let i=t.startId;i<=t.endId;i++)s.push(i);return s}getCategoryForTile(e){return Re.find(t=>e>=t.startId&&e<=t.endId)}buildUVCache(){for(let e=0;e<ce;e++){const t=e%Me,s=Math.floor(e/Me);this.uvCache.set(e,{x:t*q,y:s*H,width:q,height:H})}}drawTile(e,t,s,i,n=1){if(!this.spritesheet)throw new Error("TileRegistry not initialized");const r=this.getTileUV(t),o=q*n,d=H*n;e.drawImage(this.spritesheet,r.x,r.y,r.width,r.height,s,i,o,d)}createTilePreview(e,t=1){const s=document.createElement("canvas");s.width=q*t,s.height=H*t;const i=s.getContext("2d");return i&&(i.imageSmoothingEnabled=!1,this.drawTile(i,e,0,0,t)),s}}function G(a){return`${a.x},${a.y}`}function it(a){const[e,t]=a.split(",").map(Number);return{x:e,y:t}}class re{constructor(e){l(this,"config");l(this,"tiles",new Map);this.config={visible:!0,locked:!1,opacity:1,...e}}getTile(e){const t=G(e);return this.tiles.get(t)??null}setTile(e,t){const s=G(e);this.tiles.set(s,t)}removeTile(e){const t=G(e);return this.tiles.delete(t)}hasTile(e){const t=G(e);return this.tiles.has(t)}get tileCount(){return this.tiles.size}clear(){this.tiles.clear()}forEachTile(e){this.tiles.forEach((t,s)=>{const i=it(s);e(t,i)})}getAllTiles(){const e=[];return this.forEachTile((t,s)=>{e.push({tile:t,coord:s})}),e}setVisible(e){this.config.visible=e}toggleVisible(){this.config.visible=!this.config.visible}setLocked(e){this.config.locked=e}setOpacity(e){this.config.opacity=Math.max(0,Math.min(1,e))}clone(){const e=new re({...this.config});return this.tiles.forEach((t,s)=>{e.tiles.set(s,{...t})}),e}toData(){const e=[];return this.forEachTile((t,s)=>{e.push({tileId:t.tileId,position:s,rotation:t.rotation})}),{id:this.config.id,name:this.config.name,zIndex:this.config.zIndex,visible:this.config.visible,tiles:e}}static fromData(e){const t=new re({id:e.id,name:e.name,zIndex:e.zIndex,visible:e.visible});for(const s of e.tiles)t.setTile(s.position,{tileId:s.tileId,rotation:s.rotation});return t}}class R{constructor(e={},t={}){l(this,"metadata");l(this,"gridConfig");l(this,"layers",[]);l(this,"layerMap",new Map);l(this,"tileBehaviors",new Map);this.metadata={id:e.id??crypto.randomUUID(),name:e.name??"Untitled Level",author:e.author,created:e.created??new Date().toISOString(),modified:e.modified??new Date().toISOString(),version:e.version??1},this.gridConfig={width:t.width??tt,height:t.height??st,tileWidth:t.tileWidth??q,tileHeight:t.tileHeight??H}}get gridWidth(){return this.gridConfig.width}get gridHeight(){return this.gridConfig.height}getLayers(){return this.layers}getVisibleLayers(){return this.layers.filter(e=>e.config.visible).sort((e,t)=>e.config.zIndex-t.config.zIndex)}getLayer(e){return this.layerMap.get(e)}getLayerByIndex(e){return this.layers[e]}getTileBehavior(e){const t=G(e);return this.tileBehaviors.get(t)??null}setTileBehavior(e,t){const s=G(e);if(!t||t.type==="floor"){this.tileBehaviors.delete(s);return}this.tileBehaviors.set(s,{...t})}clearTileBehaviors(){this.tileBehaviors.clear()}forEachTileBehavior(e){this.tileBehaviors.forEach((t,s)=>{e({position:it(s),...t})})}getTileBehaviors(){const e=[];return this.forEachTileBehavior(t=>e.push(t)),e}addLayer(e){if(this.layerMap.has(e.config.id))throw new Error(`Layer with id "${e.config.id}" already exists`);this.layers.push(e),this.layerMap.set(e.config.id,e),this.sortLayers()}removeLayer(e){const t=this.layers.findIndex(s=>s.config.id===e);return t===-1?!1:(this.layers.splice(t,1),this.layerMap.delete(e),!0)}sortLayers(){this.layers.sort((e,t)=>e.config.zIndex-t.config.zIndex)}isInBounds(e){return e.x>=0&&e.x<this.gridConfig.width&&e.y>=0&&e.y<this.gridConfig.height}getTile(e,t){const s=this.layerMap.get(e);return s?s.getTile(t):null}setTile(e,t,s){if(!this.isInBounds(t))return!1;const i=this.layerMap.get(e);return!i||i.config.locked?!1:(i.setTile(t,s),!0)}removeTile(e,t){const s=this.layerMap.get(e);return!s||s.config.locked?!1:s.removeTile(t)}getTopTileAt(e){const t=this.getVisibleLayers().reverse();for(const s of t){const i=s.getTile(e);if(i)return{tile:i,layerId:s.config.id}}return null}touch(){this.metadata.modified=new Date().toISOString()}toData(){return{version:1,metadata:{...this.metadata},grid:{...this.gridConfig},layers:this.layers.map(e=>e.toData()),tileBehaviors:this.getTileBehaviors()}}static fromData(e){const t=new R(e.metadata,e.grid);for(const s of e.layers){const i=re.fromData(s);t.addLayer(i)}if(e.tileBehaviors)for(const s of e.tileBehaviors)t.setTileBehavior(s.position,s);return t}static createDefault(e="Untitled Level",t={}){const s=new R({name:e},t);for(const i of yt){const n=new re({id:i.id,name:i.name,zIndex:i.zIndex});s.addLayer(n)}return s}}class Ee{constructor(e){l(this,"element");l(this,"ctx");l(this,"container");l(this,"handleDPR");l(this,"backgroundColor");l(this,"resizeObserver",null);l(this,"_viewport",{width:0,height:0});l(this,"_dpr",1);if(typeof e.canvas=="string"){const s=document.querySelector(e.canvas);if(!s)throw new Error(`Canvas not found: ${e.canvas}`);this.element=s}else this.element=e.canvas;const t=this.element.getContext("2d");if(!t)throw new Error("Failed to get 2d context");if(this.ctx=t,e.container)if(typeof e.container=="string"){const s=document.querySelector(e.container);if(!s)throw new Error(`Container not found: ${e.container}`);this.container=s}else this.container=e.container;else this.container=this.element.parentElement||document.body;this.handleDPR=e.handleDPR??!0,this.backgroundColor=e.backgroundColor??"#0f0f23",this.updateSize(),this.setupResizeObserver()}get viewport(){return this._viewport}get dpr(){return this._dpr}updateSize(){const e=this.container.getBoundingClientRect();this._dpr=this.handleDPR&&window.devicePixelRatio||1,this.element.style.width=`${e.width}px`,this.element.style.height=`${e.height}px`,this.element.width=e.width*this._dpr,this.element.height=e.height*this._dpr,this._viewport={width:e.width,height:e.height},this.handleDPR&&this.ctx.scale(this._dpr,this._dpr),this.ctx.imageSmoothingEnabled=!1}setupResizeObserver(){this.resizeObserver=new ResizeObserver(()=>{this.updateSize()}),this.resizeObserver.observe(this.container)}clear(){this.ctx.setTransform(1,0,0,1,0,0),this.handleDPR&&this.ctx.scale(this._dpr,this._dpr),this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this._viewport.width,this._viewport.height)}dispose(){var e;(e=this.resizeObserver)==null||e.disconnect(),this.resizeObserver=null}}function E(a,e,t=0,s=0){return{x:(a-e)*(k/2)+t,y:(a+e)*(_/2)+s}}function Y(a,e,t=0,s=0){const i=a-t,n=e-s,r=(i/(k/2)+n/(_/2))/2,o=(n/(_/2)-i/(k/2))/2;return{x:Math.floor(r),y:Math.floor(o)}}function nt(a,e,t=0){return t*1e4+(a+e)}function wt(a,e,t,s){const i=E(a,e,t,s),n=H-_;return{x:i.x-q/2,y:i.y-n}}function _t(a,e,t,s,i,n){const r=Y(0,0,t,s),o=Y(a,0,t,s),d=Y(0,e,t,s),h=Y(a,e,t,s),p=Math.max(0,Math.min(r.x,d.x)-1),b=Math.min(i-1,Math.max(o.x,h.x)+1),w=Math.max(0,Math.min(r.y,o.y)-1),T=Math.min(n-1,Math.max(d.y,h.y)+1);return{minX:p,minY:w,maxX:b,maxY:T}}function ae(a,e,t,s){const i=E(0,0),n=E(t-1,0),r=E(0,s-1),o=E(t-1,s-1),d=n.x-r.x+k,h=o.y-i.y+H;return{x:(a-d)/2+(t-1)*(k/2),y:(e-h)/2+H/2}}function St(a,e){const t=[];for(let s=a.minY;s<=a.maxY;s++)for(let i=a.minX;i<=a.maxX;i++)t.push({x:i,y:s,depth:nt(i,s)});t.sort((s,i)=>s.depth-i.depth);for(const s of t)e(s.x,s.y,s.depth)}class Le{constructor(e={}){l(this,"state");l(this,"minZoom");l(this,"maxZoom");l(this,"viewport",{width:0,height:0});l(this,"zoomListeners",new Set);this.state={x:e.x??0,y:e.y??0,zoom:e.zoom??1},this.minZoom=e.minZoom??.5,this.maxZoom=e.maxZoom??3}get x(){return this.state.x}get y(){return this.state.y}get zoom(){return this.state.zoom}get minZoomLevel(){return this.minZoom}get maxZoomLevel(){return this.maxZoom}setViewport(e){this.viewport=e}setPosition(e,t){this.state.x=e,this.state.y=t}pan(e,t){this.state.x+=e,this.state.y+=t}setZoom(e,t,s){const i=Math.max(this.minZoom,Math.min(this.maxZoom,e)),n=this.state.zoom;if(t!==void 0&&s!==void 0){const r=i/this.state.zoom;this.state.x=t-(t-this.state.x)*r,this.state.y=s-(s-this.state.y)*r}this.state.zoom=i,n!==i&&this.emitZoomChange()}zoomBy(e,t,s){this.setZoom(this.state.zoom*(1+e),t,s)}reset(){this.state.x=0,this.state.y=0,this.setZoom(1)}centerOn(e,t){const s=E(e,t);this.state.x=this.viewport.width/2-s.x*this.state.zoom,this.state.y=this.viewport.height/2-s.y*this.state.zoom}screenToWorld(e,t){return{x:(e-this.state.x)/this.state.zoom,y:(t-this.state.y)/this.state.zoom}}worldToScreen(e,t){return{x:e*this.state.zoom+this.state.x,y:t*this.state.zoom+this.state.y}}screenToGrid(e,t){const s=this.screenToWorld(e,t);return Y(s.x,s.y)}getVisibleBounds(e=tt,t=st){return _t(this.viewport.width/this.state.zoom,this.viewport.height/this.state.zoom,-this.state.x/this.state.zoom,-this.state.y/this.state.zoom,e,t)}applyTransform(e){e.translate(this.state.x,this.state.y),e.scale(this.state.zoom,this.state.zoom)}getState(){return{...this.state}}setState(e){this.state={...e},this.emitZoomChange()}onZoomChange(e){return this.zoomListeners.add(e),()=>{this.zoomListeners.delete(e)}}emitZoomChange(){for(const e of this.zoomListeners)e(this.state.zoom)}}class Ie{constructor(e,t,s){l(this,"canvas");l(this,"camera");l(this,"tileRegistry");l(this,"options",{showGrid:!0,showHover:!0,showSelection:!0});l(this,"hoveredCoord",null);l(this,"selectedCoords",[]);this.canvas=e,this.camera=t,this.tileRegistry=s,this.camera.setViewport(this.canvas.viewport)}setOptions(e){this.options={...this.options,...e}}setHoveredCoord(e){this.hoveredCoord=e}setSelectedCoords(e){this.selectedCoords=e}render(e){const t=this.canvas.ctx;this.camera.setViewport(this.canvas.viewport),this.canvas.clear(),t.save(),this.camera.applyTransform(t);const s=ae(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,e.gridWidth,e.gridHeight),i={minX:0,minY:0,maxX:e.gridWidth-1,maxY:e.gridHeight-1};this.options.showGrid&&this.renderGrid(t,i,s.x,s.y);const n=this.collectRenderItems(e,i);n.sort((r,o)=>r.depth-o.depth);for(const r of n)this.renderTile(t,r.tileId,r.screenX,r.screenY);if(this.options.showHover&&this.hoveredCoord&&this.renderTileOverlay(t,this.hoveredCoord,s.x,s.y,vt),this.options.showSelection&&this.selectedCoords.length>0)for(const r of this.selectedCoords)this.renderTileOverlay(t,r,s.x,s.y,gt);t.restore()}collectRenderItems(e,t){const s=[],i=ae(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,e.gridWidth,e.gridHeight),n=e.getVisibleLayers();for(const r of n){const o=this.getLayerYOffset(r);r.forEachTile((d,h)=>{if(h.x>=t.minX&&h.x<=t.maxX&&h.y>=t.minY&&h.y<=t.maxY){const p=wt(h.x,h.y,i.x,i.y),b=nt(h.x,h.y,r.config.zIndex);s.push({tileId:d.tileId,screenX:p.x,screenY:p.y-o,depth:b})}})}return s}getLayerYOffset(e){return e.config.id==="props"||e.config.id==="decorations"?_/2:0}renderTile(e,t,s,i){this.tileRegistry.drawTile(e,t,s,i)}renderGrid(e,t,s,i){e.strokeStyle=ze,e.lineWidth=1,St(t,(n,r)=>{this.renderTileOutline(e,{x:n,y:r},s,i,ze)})}renderTileOutline(e,t,s,i,n){const r=E(t.x,t.y,s,i);e.strokeStyle=n,e.lineWidth=1,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(r.x+k/2,r.y+_/2),e.lineTo(r.x,r.y+_),e.lineTo(r.x-k/2,r.y+_/2),e.closePath(),e.stroke()}renderTileOverlay(e,t,s,i,n){const r=E(t.x,t.y,s,i);e.fillStyle=n,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(r.x+k/2,r.y+_/2),e.lineTo(r.x,r.y+_),e.lineTo(r.x-k/2,r.y+_/2),e.closePath(),e.fill()}screenToGrid(e,t,s){const i=this.camera.screenToWorld(e,t),n=ae(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,s.gridWidth,s.gridHeight);return Y(i.x,i.y,n.x,n.y)}}class Tt{constructor(){l(this,"state");l(this,"listeners",new Map);this.state={activeTool:"brush",activeLayerId:null,selectedTileId:null,hoveredCoord:null,isDirty:!1}}get activeTool(){return this.state.activeTool}get activeLayerId(){return this.state.activeLayerId}get selectedTileId(){return this.state.selectedTileId}get hoveredCoord(){return this.state.hoveredCoord}get isDirty(){return this.state.isDirty}setActiveTool(e){this.state.activeTool!==e&&(this.state.activeTool=e,this.emit("tool:changed",{tool:e}))}setActiveLayer(e){this.state.activeLayerId!==e&&(this.state.activeLayerId=e,this.emit("layer:changed",{layerId:e}))}setSelectedTile(e){this.state.selectedTileId!==e&&(this.state.selectedTileId=e,this.emit("tile:selected",{tileId:e}))}setHoveredCoord(e){var s,i;(((s=this.state.hoveredCoord)==null?void 0:s.x)!==(e==null?void 0:e.x)||((i=this.state.hoveredCoord)==null?void 0:i.y)!==(e==null?void 0:e.y))&&(this.state.hoveredCoord=e,this.emit("hover:changed",{coord:e}))}setDirty(e){this.state.isDirty!==e&&(this.state.isDirty=e,this.emit("dirty:changed",{isDirty:e}))}markDirty(){this.setDirty(!0)}markClean(){this.setDirty(!1)}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;(s=this.listeners.get(e))==null||s.delete(t)}}off(e,t){var s;(s=this.listeners.get(e))==null||s.delete(t)}emit(e,t){var s;(s=this.listeners.get(e))==null||s.forEach(i=>i(t))}notifyLevelLoaded(e){this.emit("level:loaded",{level:e})}getSnapshot(){return{...this.state}}restore(e){e.activeTool!==void 0&&this.setActiveTool(e.activeTool),e.activeLayerId!==void 0&&this.setActiveLayer(e.activeLayerId),e.selectedTileId!==void 0&&this.setSelectedTile(e.selectedTileId)}}class kt{constructor(e={}){l(this,"undoStack",[]);l(this,"redoStack",[]);l(this,"maxSize");l(this,"savePoint",0);l(this,"listeners",new Map);this.maxSize=e.maxSize??100}execute(e){for(e.execute(),this.undoStack.push(e),this.redoStack=[];this.undoStack.length>this.maxSize;)this.undoStack.shift(),this.savePoint>0&&this.savePoint--;this.emit("change")}undo(){const e=this.undoStack.pop();return e?(e.undo(),this.redoStack.push(e),this.emit("change"),!0):!1}redo(){const e=this.redoStack.pop();return e?(e.execute(),this.undoStack.push(e),this.emit("change"),!0):!1}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoDescription(){const e=this.undoStack[this.undoStack.length-1];return(e==null?void 0:e.description)??null}getRedoDescription(){const e=this.redoStack[this.redoStack.length-1];return(e==null?void 0:e.description)??null}markSaved(){this.savePoint=this.undoStack.length,this.emit("save")}isDirty(){return this.undoStack.length!==this.savePoint}clear(){this.undoStack=[],this.redoStack=[],this.savePoint=0,this.emit("change")}get undoCount(){return this.undoStack.length}get redoCount(){return this.redoStack.length}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;(s=this.listeners.get(e))==null||s.delete(t)}}off(e,t){var s;(s=this.listeners.get(e))==null||s.delete(t)}emit(e){var t;(t=this.listeners.get(e))==null||t.forEach(s=>s())}}class at{constructor(){l(this,"shortcut");l(this,"lastCoord",null);l(this,"isDrawing",!1)}onActivate(e){this.lastCoord=null,this.isDrawing=!1}onDeactivate(e){this.lastCoord=null,this.isDrawing=!1}getCursor(){return"default"}hasCoordChanged(e){return this.lastCoord?this.lastCoord.x!==e.x||this.lastCoord.y!==e.y:!0}updateLastCoord(e){this.lastCoord={...e}}}class Et{constructor(e,t,s,i,n){l(this,"description");this.level=e,this.layerId=t,this.coord=s,this.newTile=i,this.previousTile=n,this.description=`Place tile ${i.tileId} at (${s.x}, ${s.y})`}execute(){this.level.setTile(this.layerId,this.coord,this.newTile)}undo(){this.previousTile?this.level.setTile(this.layerId,this.coord,this.previousTile):this.level.removeTile(this.layerId,this.coord)}}class Lt{constructor(e,t,s,i){l(this,"description");this.level=e,this.layerId=t,this.coord=s,this.previousTile=i,this.description=`Remove tile at (${s.x}, ${s.y})`}execute(){this.level.removeTile(this.layerId,this.coord)}undo(){this.level.setTile(this.layerId,this.coord,this.previousTile)}}class It{constructor(e,t){l(this,"description");this.commands=e,this.description=t??`Batch operation (${e.length} tiles)`}execute(){for(const e of this.commands)e.execute()}undo(){for(let e=this.commands.length-1;e>=0;e--)this.commands[e].undo()}}class Bt{constructor(e,t){l(this,"description");l(this,"previousTiles",[]);this.level=e,this.layerId=t,this.description=`Clear layer "${t}"`;const s=this.level.getLayer(t);s&&(this.previousTiles=s.getAllTiles().map(({tile:i,coord:n})=>({coord:n,tile:{...i}})))}execute(){const e=this.level.getLayer(this.layerId);e==null||e.clear()}undo(){for(const{coord:e,tile:t}of this.previousTiles)this.level.setTile(this.layerId,e,t)}}class Pt extends at{constructor(){super(...arguments);l(this,"type","brush");l(this,"name","Brush");l(this,"description","Place tiles on the map");l(this,"shortcut","b");l(this,"placedCoords",new Set)}onActivate(t){super.onActivate(t),this.placedCoords.clear()}onDeactivate(t){super.onDeactivate(t),this.placedCoords.clear()}onMouseDown(t,s){this.isDrawing=!0,this.placedCoords.clear(),this.placeTile(t,s)}onMouseMove(t,s,i){i&&this.isDrawing&&this.hasCoordChanged(s)&&this.placeTile(t,s),this.updateLastCoord(s)}onMouseUp(t,s){this.isDrawing=!1,this.placedCoords.clear()}getCursor(){return"crosshair"}placeTile(t,s){const{level:i,editorState:n,history:r}=t,o=n.activeLayerId,d=n.selectedTileId;if(!o||d===null||!i.isInBounds(s))return;const h=`${s.x},${s.y}`;if(this.placedCoords.has(h))return;this.placedCoords.add(h);const p=i.getTile(o,s);if((p==null?void 0:p.tileId)===d)return;const b=new Et(i,o,s,{tileId:d},p);r.execute(b),n.markDirty()}}class zt extends at{constructor(){super(...arguments);l(this,"type","eraser");l(this,"name","Eraser");l(this,"description","Remove tiles from the map");l(this,"shortcut","e");l(this,"erasedCoords",new Set)}onActivate(t){super.onActivate(t),this.erasedCoords.clear()}onDeactivate(t){super.onDeactivate(t),this.erasedCoords.clear()}onMouseDown(t,s){this.isDrawing=!0,this.erasedCoords.clear(),this.eraseTile(t,s)}onMouseMove(t,s,i){i&&this.isDrawing&&this.hasCoordChanged(s)&&this.eraseTile(t,s),this.updateLastCoord(s)}onMouseUp(t,s){this.isDrawing=!1,this.erasedCoords.clear()}getCursor(){return"crosshair"}eraseTile(t,s){const{level:i,editorState:n,history:r}=t,o=n.activeLayerId;if(!o||!i.isInBounds(s))return;const d=`${s.x},${s.y}`;if(this.erasedCoords.has(d))return;this.erasedCoords.add(d);const h=i.getTile(o,s);if(!h)return;const p=new Lt(i,o,s,h);r.execute(p),n.markDirty()}}var x;(function(a){a.assertEqual=i=>{};function e(i){}a.assertIs=e;function t(i){throw new Error}a.assertNever=t,a.arrayToEnum=i=>{const n={};for(const r of i)n[r]=r;return n},a.getValidEnumValues=i=>{const n=a.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),r={};for(const o of n)r[o]=i[o];return a.objectValues(r)},a.objectValues=i=>a.objectKeys(i).map(function(n){return i[n]}),a.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const n=[];for(const r in i)Object.prototype.hasOwnProperty.call(i,r)&&n.push(r);return n},a.find=(i,n)=>{for(const r of i)if(n(r))return r},a.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&Number.isFinite(i)&&Math.floor(i)===i;function s(i,n=" | "){return i.map(r=>typeof r=="string"?`'${r}'`:r).join(n)}a.joinValues=s,a.jsonStringifyReplacer=(i,n)=>typeof n=="bigint"?n.toString():n})(x||(x={}));var De;(function(a){a.mergeShapes=(e,t)=>({...e,...t})})(De||(De={}));const m=x.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),O=a=>{switch(typeof a){case"undefined":return m.undefined;case"string":return m.string;case"number":return Number.isNaN(a)?m.nan:m.number;case"boolean":return m.boolean;case"function":return m.function;case"bigint":return m.bigint;case"symbol":return m.symbol;case"object":return Array.isArray(a)?m.array:a===null?m.null:a.then&&typeof a.then=="function"&&a.catch&&typeof a.catch=="function"?m.promise:typeof Map<"u"&&a instanceof Map?m.map:typeof Set<"u"&&a instanceof Set?m.set:typeof Date<"u"&&a instanceof Date?m.date:m.object;default:return m.unknown}},c=x.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class D extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=s=>{this.issues=[...this.issues,s]},this.addIssues=(s=[])=>{this.issues=[...this.issues,...s]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(n){return n.message},s={_errors:[]},i=n=>{for(const r of n.issues)if(r.code==="invalid_union")r.unionErrors.map(i);else if(r.code==="invalid_return_type")i(r.returnTypeError);else if(r.code==="invalid_arguments")i(r.argumentsError);else if(r.path.length===0)s._errors.push(t(r));else{let o=s,d=0;for(;d<r.path.length;){const h=r.path[d];d===r.path.length-1?(o[h]=o[h]||{_errors:[]},o[h]._errors.push(t(r))):o[h]=o[h]||{_errors:[]},o=o[h],d++}}};return i(this),s}static assert(e){if(!(e instanceof D))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,x.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},s=[];for(const i of this.issues)if(i.path.length>0){const n=i.path[0];t[n]=t[n]||[],t[n].push(e(i))}else s.push(e(i));return{formErrors:s,fieldErrors:t}}get formErrors(){return this.flatten()}}D.create=a=>new D(a);const be=(a,e)=>{let t;switch(a.code){case c.invalid_type:a.received===m.undefined?t="Required":t=`Expected ${a.expected}, received ${a.received}`;break;case c.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(a.expected,x.jsonStringifyReplacer)}`;break;case c.unrecognized_keys:t=`Unrecognized key(s) in object: ${x.joinValues(a.keys,", ")}`;break;case c.invalid_union:t="Invalid input";break;case c.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${x.joinValues(a.options)}`;break;case c.invalid_enum_value:t=`Invalid enum value. Expected ${x.joinValues(a.options)}, received '${a.received}'`;break;case c.invalid_arguments:t="Invalid function arguments";break;case c.invalid_return_type:t="Invalid function return type";break;case c.invalid_date:t="Invalid date";break;case c.invalid_string:typeof a.validation=="object"?"includes"in a.validation?(t=`Invalid input: must include "${a.validation.includes}"`,typeof a.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${a.validation.position}`)):"startsWith"in a.validation?t=`Invalid input: must start with "${a.validation.startsWith}"`:"endsWith"in a.validation?t=`Invalid input: must end with "${a.validation.endsWith}"`:x.assertNever(a.validation):a.validation!=="regex"?t=`Invalid ${a.validation}`:t="Invalid";break;case c.too_small:a.type==="array"?t=`Array must contain ${a.exact?"exactly":a.inclusive?"at least":"more than"} ${a.minimum} element(s)`:a.type==="string"?t=`String must contain ${a.exact?"exactly":a.inclusive?"at least":"over"} ${a.minimum} character(s)`:a.type==="number"?t=`Number must be ${a.exact?"exactly equal to ":a.inclusive?"greater than or equal to ":"greater than "}${a.minimum}`:a.type==="bigint"?t=`Number must be ${a.exact?"exactly equal to ":a.inclusive?"greater than or equal to ":"greater than "}${a.minimum}`:a.type==="date"?t=`Date must be ${a.exact?"exactly equal to ":a.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(a.minimum))}`:t="Invalid input";break;case c.too_big:a.type==="array"?t=`Array must contain ${a.exact?"exactly":a.inclusive?"at most":"less than"} ${a.maximum} element(s)`:a.type==="string"?t=`String must contain ${a.exact?"exactly":a.inclusive?"at most":"under"} ${a.maximum} character(s)`:a.type==="number"?t=`Number must be ${a.exact?"exactly":a.inclusive?"less than or equal to":"less than"} ${a.maximum}`:a.type==="bigint"?t=`BigInt must be ${a.exact?"exactly":a.inclusive?"less than or equal to":"less than"} ${a.maximum}`:a.type==="date"?t=`Date must be ${a.exact?"exactly":a.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(a.maximum))}`:t="Invalid input";break;case c.custom:t="Invalid input";break;case c.invalid_intersection_types:t="Intersection results could not be merged";break;case c.not_multiple_of:t=`Number must be a multiple of ${a.multipleOf}`;break;case c.not_finite:t="Number must be finite";break;default:t=e.defaultError,x.assertNever(a)}return{message:t}};let Mt=be;function Rt(){return Mt}const Dt=a=>{const{data:e,path:t,errorMaps:s,issueData:i}=a,n=[...t,...i.path||[]],r={...i,path:n};if(i.message!==void 0)return{...i,path:n,message:i.message};let o="";const d=s.filter(h=>!!h).slice().reverse();for(const h of d)o=h(r,{data:e,defaultError:o}).message;return{...i,path:n,message:o}};function u(a,e){const t=Rt(),s=Dt({issueData:e,data:a.data,path:a.path,errorMaps:[a.common.contextualErrorMap,a.schemaErrorMap,t,t===be?void 0:be].filter(i=>!!i)});a.common.issues.push(s)}class I{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const s=[];for(const i of t){if(i.status==="aborted")return y;i.status==="dirty"&&e.dirty(),s.push(i.value)}return{status:e.value,value:s}}static async mergeObjectAsync(e,t){const s=[];for(const i of t){const n=await i.key,r=await i.value;s.push({key:n,value:r})}return I.mergeObjectSync(e,s)}static mergeObjectSync(e,t){const s={};for(const i of t){const{key:n,value:r}=i;if(n.status==="aborted"||r.status==="aborted")return y;n.status==="dirty"&&e.dirty(),r.status==="dirty"&&e.dirty(),n.value!=="__proto__"&&(typeof r.value<"u"||i.alwaysSet)&&(s[n.value]=r.value)}return{status:e.value,value:s}}}const y=Object.freeze({status:"aborted"}),ie=a=>({status:"dirty",value:a}),P=a=>({status:"valid",value:a}),Ne=a=>a.status==="aborted",Oe=a=>a.status==="dirty",X=a=>a.status==="valid",ue=a=>typeof Promise<"u"&&a instanceof Promise;var f;(function(a){a.errToObj=e=>typeof e=="string"?{message:e}:e||{},a.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(f||(f={}));class j{constructor(e,t,s,i){this._cachedPath=[],this.parent=e,this.data=t,this._path=s,this._key=i}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Ae=(a,e)=>{if(X(e))return{success:!0,data:e.value};if(!a.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new D(a.common.issues);return this._error=t,this._error}}};function v(a){if(!a)return{};const{errorMap:e,invalid_type_error:t,required_error:s,description:i}=a;if(e&&(t||s))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:i}:{errorMap:(r,o)=>{const{message:d}=a;return r.code==="invalid_enum_value"?{message:d??o.defaultError}:typeof o.data>"u"?{message:d??s??o.defaultError}:r.code!=="invalid_type"?{message:o.defaultError}:{message:d??t??o.defaultError}},description:i}}class C{get description(){return this._def.description}_getType(e){return O(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:O(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new I,ctx:{common:e.parent.common,data:e.data,parsedType:O(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(ue(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const s=this.safeParse(e,t);if(s.success)return s.data;throw s.error}safeParse(e,t){const s={common:{issues:[],async:(t==null?void 0:t.async)??!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:O(e)},i=this._parseSync({data:e,path:s.path,parent:s});return Ae(s,i)}"~validate"(e){var s,i;const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:O(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return X(n)?{value:n.value}:{issues:t.common.issues}}catch(n){(i=(s=n==null?void 0:n.message)==null?void 0:s.toLowerCase())!=null&&i.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(n=>X(n)?{value:n.value}:{issues:t.common.issues})}async parseAsync(e,t){const s=await this.safeParseAsync(e,t);if(s.success)return s.data;throw s.error}async safeParseAsync(e,t){const s={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:O(e)},i=this._parse({data:e,path:s.path,parent:s}),n=await(ue(i)?i:Promise.resolve(i));return Ae(s,n)}refine(e,t){const s=i=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(i):t;return this._refinement((i,n)=>{const r=e(i),o=()=>n.addIssue({code:c.custom,...s(i)});return typeof Promise<"u"&&r instanceof Promise?r.then(d=>d?!0:(o(),!1)):r?!0:(o(),!1)})}refinement(e,t){return this._refinement((s,i)=>e(s)?!0:(i.addIssue(typeof t=="function"?t(s,i):t),!1))}_refinement(e){return new ee({schema:this,typeName:g.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return Z.create(this,this._def)}nullable(){return te.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return M.create(this)}promise(){return ye.create(this,this._def)}or(e){return me.create([this,e],this._def)}and(e){return fe.create(this,e,this._def)}transform(e){return new ee({...v(this._def),schema:this,typeName:g.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new _e({...v(this._def),innerType:this,defaultValue:t,typeName:g.ZodDefault})}brand(){return new ns({typeName:g.ZodBranded,type:this,...v(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Se({...v(this._def),innerType:this,catchValue:t,typeName:g.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Be.create(this,e)}readonly(){return Te.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Nt=/^c[^\s-]{8,}$/i,Ot=/^[0-9a-z]+$/,At=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Ht=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,$t=/^[a-z0-9_-]{21}$/i,Zt=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,jt=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Ft=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Vt="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let ve;const Ut=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Wt=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Kt=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,qt=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Gt=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Yt=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,rt="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Xt=new RegExp(`^${rt}$`);function ot(a){let e="[0-5]\\d";a.precision?e=`${e}\\.\\d{${a.precision}}`:a.precision==null&&(e=`${e}(\\.\\d+)?`);const t=a.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function Jt(a){return new RegExp(`^${ot(a)}$`)}function Qt(a){let e=`${rt}T${ot(a)}`;const t=[];return t.push(a.local?"Z?":"Z"),a.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function es(a,e){return!!((e==="v4"||!e)&&Ut.test(a)||(e==="v6"||!e)&&Kt.test(a))}function ts(a,e){if(!Zt.test(a))return!1;try{const[t]=a.split(".");if(!t)return!1;const s=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),i=JSON.parse(atob(s));return!(typeof i!="object"||i===null||"typ"in i&&(i==null?void 0:i.typ)!=="JWT"||!i.alg||e&&i.alg!==e)}catch{return!1}}function ss(a,e){return!!((e==="v4"||!e)&&Wt.test(a)||(e==="v6"||!e)&&qt.test(a))}class $ extends C{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==m.string){const n=this._getOrReturnCtx(e);return u(n,{code:c.invalid_type,expected:m.string,received:n.parsedType}),y}const s=new I;let i;for(const n of this._def.checks)if(n.kind==="min")e.data.length<n.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:c.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),s.dirty());else if(n.kind==="max")e.data.length>n.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:c.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),s.dirty());else if(n.kind==="length"){const r=e.data.length>n.value,o=e.data.length<n.value;(r||o)&&(i=this._getOrReturnCtx(e,i),r?u(i,{code:c.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}):o&&u(i,{code:c.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}),s.dirty())}else if(n.kind==="email")Ft.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"email",code:c.invalid_string,message:n.message}),s.dirty());else if(n.kind==="emoji")ve||(ve=new RegExp(Vt,"u")),ve.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"emoji",code:c.invalid_string,message:n.message}),s.dirty());else if(n.kind==="uuid")Ht.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"uuid",code:c.invalid_string,message:n.message}),s.dirty());else if(n.kind==="nanoid")$t.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"nanoid",code:c.invalid_string,message:n.message}),s.dirty());else if(n.kind==="cuid")Nt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"cuid",code:c.invalid_string,message:n.message}),s.dirty());else if(n.kind==="cuid2")Ot.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"cuid2",code:c.invalid_string,message:n.message}),s.dirty());else if(n.kind==="ulid")At.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"ulid",code:c.invalid_string,message:n.message}),s.dirty());else if(n.kind==="url")try{new URL(e.data)}catch{i=this._getOrReturnCtx(e,i),u(i,{validation:"url",code:c.invalid_string,message:n.message}),s.dirty()}else n.kind==="regex"?(n.regex.lastIndex=0,n.regex.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"regex",code:c.invalid_string,message:n.message}),s.dirty())):n.kind==="trim"?e.data=e.data.trim():n.kind==="includes"?e.data.includes(n.value,n.position)||(i=this._getOrReturnCtx(e,i),u(i,{code:c.invalid_string,validation:{includes:n.value,position:n.position},message:n.message}),s.dirty()):n.kind==="toLowerCase"?e.data=e.data.toLowerCase():n.kind==="toUpperCase"?e.data=e.data.toUpperCase():n.kind==="startsWith"?e.data.startsWith(n.value)||(i=this._getOrReturnCtx(e,i),u(i,{code:c.invalid_string,validation:{startsWith:n.value},message:n.message}),s.dirty()):n.kind==="endsWith"?e.data.endsWith(n.value)||(i=this._getOrReturnCtx(e,i),u(i,{code:c.invalid_string,validation:{endsWith:n.value},message:n.message}),s.dirty()):n.kind==="datetime"?Qt(n).test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{code:c.invalid_string,validation:"datetime",message:n.message}),s.dirty()):n.kind==="date"?Xt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{code:c.invalid_string,validation:"date",message:n.message}),s.dirty()):n.kind==="time"?Jt(n).test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{code:c.invalid_string,validation:"time",message:n.message}),s.dirty()):n.kind==="duration"?jt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"duration",code:c.invalid_string,message:n.message}),s.dirty()):n.kind==="ip"?es(e.data,n.version)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"ip",code:c.invalid_string,message:n.message}),s.dirty()):n.kind==="jwt"?ts(e.data,n.alg)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"jwt",code:c.invalid_string,message:n.message}),s.dirty()):n.kind==="cidr"?ss(e.data,n.version)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"cidr",code:c.invalid_string,message:n.message}),s.dirty()):n.kind==="base64"?Gt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"base64",code:c.invalid_string,message:n.message}),s.dirty()):n.kind==="base64url"?Yt.test(e.data)||(i=this._getOrReturnCtx(e,i),u(i,{validation:"base64url",code:c.invalid_string,message:n.message}),s.dirty()):x.assertNever(n);return{status:s.value,value:e.data}}_regex(e,t,s){return this.refinement(i=>e.test(i),{validation:t,code:c.invalid_string,...f.errToObj(s)})}_addCheck(e){return new $({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...f.errToObj(e)})}url(e){return this._addCheck({kind:"url",...f.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...f.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...f.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...f.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...f.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...f.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...f.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...f.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...f.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...f.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...f.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...f.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...f.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...f.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...f.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...f.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...f.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...f.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...f.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...f.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...f.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...f.errToObj(t)})}nonempty(e){return this.min(1,f.errToObj(e))}trim(){return new $({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new $({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new $({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}$.create=a=>new $({checks:[],typeName:g.ZodString,coerce:(a==null?void 0:a.coerce)??!1,...v(a)});function is(a,e){const t=(a.toString().split(".")[1]||"").length,s=(e.toString().split(".")[1]||"").length,i=t>s?t:s,n=Number.parseInt(a.toFixed(i).replace(".","")),r=Number.parseInt(e.toFixed(i).replace(".",""));return n%r/10**i}class J extends C{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==m.number){const n=this._getOrReturnCtx(e);return u(n,{code:c.invalid_type,expected:m.number,received:n.parsedType}),y}let s;const i=new I;for(const n of this._def.checks)n.kind==="int"?x.isInteger(e.data)||(s=this._getOrReturnCtx(e,s),u(s,{code:c.invalid_type,expected:"integer",received:"float",message:n.message}),i.dirty()):n.kind==="min"?(n.inclusive?e.data<n.value:e.data<=n.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:c.too_small,minimum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),i.dirty()):n.kind==="max"?(n.inclusive?e.data>n.value:e.data>=n.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:c.too_big,maximum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),i.dirty()):n.kind==="multipleOf"?is(e.data,n.value)!==0&&(s=this._getOrReturnCtx(e,s),u(s,{code:c.not_multiple_of,multipleOf:n.value,message:n.message}),i.dirty()):n.kind==="finite"?Number.isFinite(e.data)||(s=this._getOrReturnCtx(e,s),u(s,{code:c.not_finite,message:n.message}),i.dirty()):x.assertNever(n);return{status:i.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,f.toString(t))}gt(e,t){return this.setLimit("min",e,!1,f.toString(t))}lte(e,t){return this.setLimit("max",e,!0,f.toString(t))}lt(e,t){return this.setLimit("max",e,!1,f.toString(t))}setLimit(e,t,s,i){return new J({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:f.toString(i)}]})}_addCheck(e){return new J({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:f.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:f.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:f.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:f.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:f.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:f.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:f.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:f.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:f.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&x.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const s of this._def.checks){if(s.kind==="finite"||s.kind==="int"||s.kind==="multipleOf")return!0;s.kind==="min"?(t===null||s.value>t)&&(t=s.value):s.kind==="max"&&(e===null||s.value<e)&&(e=s.value)}return Number.isFinite(t)&&Number.isFinite(e)}}J.create=a=>new J({checks:[],typeName:g.ZodNumber,coerce:(a==null?void 0:a.coerce)||!1,...v(a)});class oe extends C{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==m.bigint)return this._getInvalidInput(e);let s;const i=new I;for(const n of this._def.checks)n.kind==="min"?(n.inclusive?e.data<n.value:e.data<=n.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:c.too_small,type:"bigint",minimum:n.value,inclusive:n.inclusive,message:n.message}),i.dirty()):n.kind==="max"?(n.inclusive?e.data>n.value:e.data>=n.value)&&(s=this._getOrReturnCtx(e,s),u(s,{code:c.too_big,type:"bigint",maximum:n.value,inclusive:n.inclusive,message:n.message}),i.dirty()):n.kind==="multipleOf"?e.data%n.value!==BigInt(0)&&(s=this._getOrReturnCtx(e,s),u(s,{code:c.not_multiple_of,multipleOf:n.value,message:n.message}),i.dirty()):x.assertNever(n);return{status:i.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return u(t,{code:c.invalid_type,expected:m.bigint,received:t.parsedType}),y}gte(e,t){return this.setLimit("min",e,!0,f.toString(t))}gt(e,t){return this.setLimit("min",e,!1,f.toString(t))}lte(e,t){return this.setLimit("max",e,!0,f.toString(t))}lt(e,t){return this.setLimit("max",e,!1,f.toString(t))}setLimit(e,t,s,i){return new oe({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:f.toString(i)}]})}_addCheck(e){return new oe({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:f.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:f.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:f.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:f.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:f.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}oe.create=a=>new oe({checks:[],typeName:g.ZodBigInt,coerce:(a==null?void 0:a.coerce)??!1,...v(a)});class Ce extends C{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==m.boolean){const s=this._getOrReturnCtx(e);return u(s,{code:c.invalid_type,expected:m.boolean,received:s.parsedType}),y}return P(e.data)}}Ce.create=a=>new Ce({typeName:g.ZodBoolean,coerce:(a==null?void 0:a.coerce)||!1,...v(a)});class pe extends C{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==m.date){const n=this._getOrReturnCtx(e);return u(n,{code:c.invalid_type,expected:m.date,received:n.parsedType}),y}if(Number.isNaN(e.data.getTime())){const n=this._getOrReturnCtx(e);return u(n,{code:c.invalid_date}),y}const s=new I;let i;for(const n of this._def.checks)n.kind==="min"?e.data.getTime()<n.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:c.too_small,message:n.message,inclusive:!0,exact:!1,minimum:n.value,type:"date"}),s.dirty()):n.kind==="max"?e.data.getTime()>n.value&&(i=this._getOrReturnCtx(e,i),u(i,{code:c.too_big,message:n.message,inclusive:!0,exact:!1,maximum:n.value,type:"date"}),s.dirty()):x.assertNever(n);return{status:s.value,value:new Date(e.data.getTime())}}_addCheck(e){return new pe({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:f.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:f.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}pe.create=a=>new pe({checks:[],coerce:(a==null?void 0:a.coerce)||!1,typeName:g.ZodDate,...v(a)});class He extends C{_parse(e){if(this._getType(e)!==m.symbol){const s=this._getOrReturnCtx(e);return u(s,{code:c.invalid_type,expected:m.symbol,received:s.parsedType}),y}return P(e.data)}}He.create=a=>new He({typeName:g.ZodSymbol,...v(a)});class $e extends C{_parse(e){if(this._getType(e)!==m.undefined){const s=this._getOrReturnCtx(e);return u(s,{code:c.invalid_type,expected:m.undefined,received:s.parsedType}),y}return P(e.data)}}$e.create=a=>new $e({typeName:g.ZodUndefined,...v(a)});class Ze extends C{_parse(e){if(this._getType(e)!==m.null){const s=this._getOrReturnCtx(e);return u(s,{code:c.invalid_type,expected:m.null,received:s.parsedType}),y}return P(e.data)}}Ze.create=a=>new Ze({typeName:g.ZodNull,...v(a)});class je extends C{constructor(){super(...arguments),this._any=!0}_parse(e){return P(e.data)}}je.create=a=>new je({typeName:g.ZodAny,...v(a)});class Fe extends C{constructor(){super(...arguments),this._unknown=!0}_parse(e){return P(e.data)}}Fe.create=a=>new Fe({typeName:g.ZodUnknown,...v(a)});class F extends C{_parse(e){const t=this._getOrReturnCtx(e);return u(t,{code:c.invalid_type,expected:m.never,received:t.parsedType}),y}}F.create=a=>new F({typeName:g.ZodNever,...v(a)});class Ve extends C{_parse(e){if(this._getType(e)!==m.undefined){const s=this._getOrReturnCtx(e);return u(s,{code:c.invalid_type,expected:m.void,received:s.parsedType}),y}return P(e.data)}}Ve.create=a=>new Ve({typeName:g.ZodVoid,...v(a)});class M extends C{_parse(e){const{ctx:t,status:s}=this._processInputParams(e),i=this._def;if(t.parsedType!==m.array)return u(t,{code:c.invalid_type,expected:m.array,received:t.parsedType}),y;if(i.exactLength!==null){const r=t.data.length>i.exactLength.value,o=t.data.length<i.exactLength.value;(r||o)&&(u(t,{code:r?c.too_big:c.too_small,minimum:o?i.exactLength.value:void 0,maximum:r?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),s.dirty())}if(i.minLength!==null&&t.data.length<i.minLength.value&&(u(t,{code:c.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),s.dirty()),i.maxLength!==null&&t.data.length>i.maxLength.value&&(u(t,{code:c.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),s.dirty()),t.common.async)return Promise.all([...t.data].map((r,o)=>i.type._parseAsync(new j(t,r,t.path,o)))).then(r=>I.mergeArray(s,r));const n=[...t.data].map((r,o)=>i.type._parseSync(new j(t,r,t.path,o)));return I.mergeArray(s,n)}get element(){return this._def.type}min(e,t){return new M({...this._def,minLength:{value:e,message:f.toString(t)}})}max(e,t){return new M({...this._def,maxLength:{value:e,message:f.toString(t)}})}length(e,t){return new M({...this._def,exactLength:{value:e,message:f.toString(t)}})}nonempty(e){return this.min(1,e)}}M.create=(a,e)=>new M({type:a,minLength:null,maxLength:null,exactLength:null,typeName:g.ZodArray,...v(e)});function K(a){if(a instanceof S){const e={};for(const t in a.shape){const s=a.shape[t];e[t]=Z.create(K(s))}return new S({...a._def,shape:()=>e})}else return a instanceof M?new M({...a._def,type:K(a.element)}):a instanceof Z?Z.create(K(a.unwrap())):a instanceof te?te.create(K(a.unwrap())):a instanceof V?V.create(a.items.map(e=>K(e))):a}class S extends C{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=x.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==m.object){const h=this._getOrReturnCtx(e);return u(h,{code:c.invalid_type,expected:m.object,received:h.parsedType}),y}const{status:s,ctx:i}=this._processInputParams(e),{shape:n,keys:r}=this._getCached(),o=[];if(!(this._def.catchall instanceof F&&this._def.unknownKeys==="strip"))for(const h in i.data)r.includes(h)||o.push(h);const d=[];for(const h of r){const p=n[h],b=i.data[h];d.push({key:{status:"valid",value:h},value:p._parse(new j(i,b,i.path,h)),alwaysSet:h in i.data})}if(this._def.catchall instanceof F){const h=this._def.unknownKeys;if(h==="passthrough")for(const p of o)d.push({key:{status:"valid",value:p},value:{status:"valid",value:i.data[p]}});else if(h==="strict")o.length>0&&(u(i,{code:c.unrecognized_keys,keys:o}),s.dirty());else if(h!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const h=this._def.catchall;for(const p of o){const b=i.data[p];d.push({key:{status:"valid",value:p},value:h._parse(new j(i,b,i.path,p)),alwaysSet:p in i.data})}}return i.common.async?Promise.resolve().then(async()=>{const h=[];for(const p of d){const b=await p.key,w=await p.value;h.push({key:b,value:w,alwaysSet:p.alwaysSet})}return h}).then(h=>I.mergeObjectSync(s,h)):I.mergeObjectSync(s,d)}get shape(){return this._def.shape()}strict(e){return f.errToObj,new S({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,s)=>{var n,r;const i=((r=(n=this._def).errorMap)==null?void 0:r.call(n,t,s).message)??s.defaultError;return t.code==="unrecognized_keys"?{message:f.errToObj(e).message??i}:{message:i}}}:{}})}strip(){return new S({...this._def,unknownKeys:"strip"})}passthrough(){return new S({...this._def,unknownKeys:"passthrough"})}extend(e){return new S({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new S({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:g.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new S({...this._def,catchall:e})}pick(e){const t={};for(const s of x.objectKeys(e))e[s]&&this.shape[s]&&(t[s]=this.shape[s]);return new S({...this._def,shape:()=>t})}omit(e){const t={};for(const s of x.objectKeys(this.shape))e[s]||(t[s]=this.shape[s]);return new S({...this._def,shape:()=>t})}deepPartial(){return K(this)}partial(e){const t={};for(const s of x.objectKeys(this.shape)){const i=this.shape[s];e&&!e[s]?t[s]=i:t[s]=i.optional()}return new S({...this._def,shape:()=>t})}required(e){const t={};for(const s of x.objectKeys(this.shape))if(e&&!e[s])t[s]=this.shape[s];else{let n=this.shape[s];for(;n instanceof Z;)n=n._def.innerType;t[s]=n}return new S({...this._def,shape:()=>t})}keyof(){return lt(x.objectKeys(this.shape))}}S.create=(a,e)=>new S({shape:()=>a,unknownKeys:"strip",catchall:F.create(),typeName:g.ZodObject,...v(e)});S.strictCreate=(a,e)=>new S({shape:()=>a,unknownKeys:"strict",catchall:F.create(),typeName:g.ZodObject,...v(e)});S.lazycreate=(a,e)=>new S({shape:a,unknownKeys:"strip",catchall:F.create(),typeName:g.ZodObject,...v(e)});class me extends C{_parse(e){const{ctx:t}=this._processInputParams(e),s=this._def.options;function i(n){for(const o of n)if(o.result.status==="valid")return o.result;for(const o of n)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const r=n.map(o=>new D(o.ctx.common.issues));return u(t,{code:c.invalid_union,unionErrors:r}),y}if(t.common.async)return Promise.all(s.map(async n=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await n._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(i);{let n;const r=[];for(const d of s){const h={...t,common:{...t.common,issues:[]},parent:null},p=d._parseSync({data:t.data,path:t.path,parent:h});if(p.status==="valid")return p;p.status==="dirty"&&!n&&(n={result:p,ctx:h}),h.common.issues.length&&r.push(h.common.issues)}if(n)return t.common.issues.push(...n.ctx.common.issues),n.result;const o=r.map(d=>new D(d));return u(t,{code:c.invalid_union,unionErrors:o}),y}}get options(){return this._def.options}}me.create=(a,e)=>new me({options:a,typeName:g.ZodUnion,...v(e)});function xe(a,e){const t=O(a),s=O(e);if(a===e)return{valid:!0,data:a};if(t===m.object&&s===m.object){const i=x.objectKeys(e),n=x.objectKeys(a).filter(o=>i.indexOf(o)!==-1),r={...a,...e};for(const o of n){const d=xe(a[o],e[o]);if(!d.valid)return{valid:!1};r[o]=d.data}return{valid:!0,data:r}}else if(t===m.array&&s===m.array){if(a.length!==e.length)return{valid:!1};const i=[];for(let n=0;n<a.length;n++){const r=a[n],o=e[n],d=xe(r,o);if(!d.valid)return{valid:!1};i.push(d.data)}return{valid:!0,data:i}}else return t===m.date&&s===m.date&&+a==+e?{valid:!0,data:a}:{valid:!1}}class fe extends C{_parse(e){const{status:t,ctx:s}=this._processInputParams(e),i=(n,r)=>{if(Ne(n)||Ne(r))return y;const o=xe(n.value,r.value);return o.valid?((Oe(n)||Oe(r))&&t.dirty(),{status:t.value,value:o.data}):(u(s,{code:c.invalid_intersection_types}),y)};return s.common.async?Promise.all([this._def.left._parseAsync({data:s.data,path:s.path,parent:s}),this._def.right._parseAsync({data:s.data,path:s.path,parent:s})]).then(([n,r])=>i(n,r)):i(this._def.left._parseSync({data:s.data,path:s.path,parent:s}),this._def.right._parseSync({data:s.data,path:s.path,parent:s}))}}fe.create=(a,e,t)=>new fe({left:a,right:e,typeName:g.ZodIntersection,...v(t)});class V extends C{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==m.array)return u(s,{code:c.invalid_type,expected:m.array,received:s.parsedType}),y;if(s.data.length<this._def.items.length)return u(s,{code:c.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),y;!this._def.rest&&s.data.length>this._def.items.length&&(u(s,{code:c.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const n=[...s.data].map((r,o)=>{const d=this._def.items[o]||this._def.rest;return d?d._parse(new j(s,r,s.path,o)):null}).filter(r=>!!r);return s.common.async?Promise.all(n).then(r=>I.mergeArray(t,r)):I.mergeArray(t,n)}get items(){return this._def.items}rest(e){return new V({...this._def,rest:e})}}V.create=(a,e)=>{if(!Array.isArray(a))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new V({items:a,typeName:g.ZodTuple,rest:null,...v(e)})};class Ue extends C{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==m.map)return u(s,{code:c.invalid_type,expected:m.map,received:s.parsedType}),y;const i=this._def.keyType,n=this._def.valueType,r=[...s.data.entries()].map(([o,d],h)=>({key:i._parse(new j(s,o,s.path,[h,"key"])),value:n._parse(new j(s,d,s.path,[h,"value"]))}));if(s.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const d of r){const h=await d.key,p=await d.value;if(h.status==="aborted"||p.status==="aborted")return y;(h.status==="dirty"||p.status==="dirty")&&t.dirty(),o.set(h.value,p.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const d of r){const h=d.key,p=d.value;if(h.status==="aborted"||p.status==="aborted")return y;(h.status==="dirty"||p.status==="dirty")&&t.dirty(),o.set(h.value,p.value)}return{status:t.value,value:o}}}}Ue.create=(a,e,t)=>new Ue({valueType:e,keyType:a,typeName:g.ZodMap,...v(t)});class le extends C{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==m.set)return u(s,{code:c.invalid_type,expected:m.set,received:s.parsedType}),y;const i=this._def;i.minSize!==null&&s.data.size<i.minSize.value&&(u(s,{code:c.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),t.dirty()),i.maxSize!==null&&s.data.size>i.maxSize.value&&(u(s,{code:c.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),t.dirty());const n=this._def.valueType;function r(d){const h=new Set;for(const p of d){if(p.status==="aborted")return y;p.status==="dirty"&&t.dirty(),h.add(p.value)}return{status:t.value,value:h}}const o=[...s.data.values()].map((d,h)=>n._parse(new j(s,d,s.path,h)));return s.common.async?Promise.all(o).then(d=>r(d)):r(o)}min(e,t){return new le({...this._def,minSize:{value:e,message:f.toString(t)}})}max(e,t){return new le({...this._def,maxSize:{value:e,message:f.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}le.create=(a,e)=>new le({valueType:a,minSize:null,maxSize:null,typeName:g.ZodSet,...v(e)});class We extends C{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}We.create=(a,e)=>new We({getter:a,typeName:g.ZodLazy,...v(e)});class we extends C{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return u(t,{received:t.data,code:c.invalid_literal,expected:this._def.value}),y}return{status:"valid",value:e.data}}get value(){return this._def.value}}we.create=(a,e)=>new we({value:a,typeName:g.ZodLiteral,...v(e)});function lt(a,e){return new Q({values:a,typeName:g.ZodEnum,...v(e)})}class Q extends C{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),s=this._def.values;return u(t,{expected:x.joinValues(s),received:t.parsedType,code:c.invalid_type}),y}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),s=this._def.values;return u(t,{received:t.data,code:c.invalid_enum_value,options:s}),y}return P(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Q.create(e,{...this._def,...t})}exclude(e,t=this._def){return Q.create(this.options.filter(s=>!e.includes(s)),{...this._def,...t})}}Q.create=lt;class Ke extends C{_parse(e){const t=x.getValidEnumValues(this._def.values),s=this._getOrReturnCtx(e);if(s.parsedType!==m.string&&s.parsedType!==m.number){const i=x.objectValues(t);return u(s,{expected:x.joinValues(i),received:s.parsedType,code:c.invalid_type}),y}if(this._cache||(this._cache=new Set(x.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const i=x.objectValues(t);return u(s,{received:s.data,code:c.invalid_enum_value,options:i}),y}return P(e.data)}get enum(){return this._def.values}}Ke.create=(a,e)=>new Ke({values:a,typeName:g.ZodNativeEnum,...v(e)});class ye extends C{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==m.promise&&t.common.async===!1)return u(t,{code:c.invalid_type,expected:m.promise,received:t.parsedType}),y;const s=t.parsedType===m.promise?t.data:Promise.resolve(t.data);return P(s.then(i=>this._def.type.parseAsync(i,{path:t.path,errorMap:t.common.contextualErrorMap})))}}ye.create=(a,e)=>new ye({type:a,typeName:g.ZodPromise,...v(e)});class ee extends C{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===g.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:s}=this._processInputParams(e),i=this._def.effect||null,n={addIssue:r=>{u(s,r),r.fatal?t.abort():t.dirty()},get path(){return s.path}};if(n.addIssue=n.addIssue.bind(n),i.type==="preprocess"){const r=i.transform(s.data,n);if(s.common.async)return Promise.resolve(r).then(async o=>{if(t.value==="aborted")return y;const d=await this._def.schema._parseAsync({data:o,path:s.path,parent:s});return d.status==="aborted"?y:d.status==="dirty"||t.value==="dirty"?ie(d.value):d});{if(t.value==="aborted")return y;const o=this._def.schema._parseSync({data:r,path:s.path,parent:s});return o.status==="aborted"?y:o.status==="dirty"||t.value==="dirty"?ie(o.value):o}}if(i.type==="refinement"){const r=o=>{const d=i.refinement(o,n);if(s.common.async)return Promise.resolve(d);if(d instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(s.common.async===!1){const o=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});return o.status==="aborted"?y:(o.status==="dirty"&&t.dirty(),r(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(o=>o.status==="aborted"?y:(o.status==="dirty"&&t.dirty(),r(o.value).then(()=>({status:t.value,value:o.value}))))}if(i.type==="transform")if(s.common.async===!1){const r=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});if(!X(r))return y;const o=i.transform(r.value,n);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(r=>X(r)?Promise.resolve(i.transform(r.value,n)).then(o=>({status:t.value,value:o})):y);x.assertNever(i)}}ee.create=(a,e,t)=>new ee({schema:a,typeName:g.ZodEffects,effect:e,...v(t)});ee.createWithPreprocess=(a,e,t)=>new ee({schema:e,effect:{type:"preprocess",transform:a},typeName:g.ZodEffects,...v(t)});class Z extends C{_parse(e){return this._getType(e)===m.undefined?P(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Z.create=(a,e)=>new Z({innerType:a,typeName:g.ZodOptional,...v(e)});class te extends C{_parse(e){return this._getType(e)===m.null?P(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}te.create=(a,e)=>new te({innerType:a,typeName:g.ZodNullable,...v(e)});class _e extends C{_parse(e){const{ctx:t}=this._processInputParams(e);let s=t.data;return t.parsedType===m.undefined&&(s=this._def.defaultValue()),this._def.innerType._parse({data:s,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}_e.create=(a,e)=>new _e({innerType:a,typeName:g.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...v(e)});class Se extends C{_parse(e){const{ctx:t}=this._processInputParams(e),s={...t,common:{...t.common,issues:[]}},i=this._def.innerType._parse({data:s.data,path:s.path,parent:{...s}});return ue(i)?i.then(n=>({status:"valid",value:n.status==="valid"?n.value:this._def.catchValue({get error(){return new D(s.common.issues)},input:s.data})})):{status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new D(s.common.issues)},input:s.data})}}removeCatch(){return this._def.innerType}}Se.create=(a,e)=>new Se({innerType:a,typeName:g.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...v(e)});class qe extends C{_parse(e){if(this._getType(e)!==m.nan){const s=this._getOrReturnCtx(e);return u(s,{code:c.invalid_type,expected:m.nan,received:s.parsedType}),y}return{status:"valid",value:e.data}}}qe.create=a=>new qe({typeName:g.ZodNaN,...v(a)});class ns extends C{_parse(e){const{ctx:t}=this._processInputParams(e),s=t.data;return this._def.type._parse({data:s,path:t.path,parent:t})}unwrap(){return this._def.type}}class Be extends C{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.common.async)return(async()=>{const n=await this._def.in._parseAsync({data:s.data,path:s.path,parent:s});return n.status==="aborted"?y:n.status==="dirty"?(t.dirty(),ie(n.value)):this._def.out._parseAsync({data:n.value,path:s.path,parent:s})})();{const i=this._def.in._parseSync({data:s.data,path:s.path,parent:s});return i.status==="aborted"?y:i.status==="dirty"?(t.dirty(),{status:"dirty",value:i.value}):this._def.out._parseSync({data:i.value,path:s.path,parent:s})}}static create(e,t){return new Be({in:e,out:t,typeName:g.ZodPipeline})}}class Te extends C{_parse(e){const t=this._def.innerType._parse(e),s=i=>(X(i)&&(i.value=Object.freeze(i.value)),i);return ue(t)?t.then(i=>s(i)):s(t)}unwrap(){return this._def.innerType}}Te.create=(a,e)=>new Te({innerType:a,typeName:g.ZodReadonly,...v(e)});var g;(function(a){a.ZodString="ZodString",a.ZodNumber="ZodNumber",a.ZodNaN="ZodNaN",a.ZodBigInt="ZodBigInt",a.ZodBoolean="ZodBoolean",a.ZodDate="ZodDate",a.ZodSymbol="ZodSymbol",a.ZodUndefined="ZodUndefined",a.ZodNull="ZodNull",a.ZodAny="ZodAny",a.ZodUnknown="ZodUnknown",a.ZodNever="ZodNever",a.ZodVoid="ZodVoid",a.ZodArray="ZodArray",a.ZodObject="ZodObject",a.ZodUnion="ZodUnion",a.ZodDiscriminatedUnion="ZodDiscriminatedUnion",a.ZodIntersection="ZodIntersection",a.ZodTuple="ZodTuple",a.ZodRecord="ZodRecord",a.ZodMap="ZodMap",a.ZodSet="ZodSet",a.ZodFunction="ZodFunction",a.ZodLazy="ZodLazy",a.ZodLiteral="ZodLiteral",a.ZodEnum="ZodEnum",a.ZodEffects="ZodEffects",a.ZodNativeEnum="ZodNativeEnum",a.ZodOptional="ZodOptional",a.ZodNullable="ZodNullable",a.ZodDefault="ZodDefault",a.ZodCatch="ZodCatch",a.ZodPromise="ZodPromise",a.ZodBranded="ZodBranded",a.ZodPipeline="ZodPipeline",a.ZodReadonly="ZodReadonly"})(g||(g={}));const A=$.create,z=J.create,dt=Ce.create;F.create;const ke=M.create,U=S.create,as=me.create;fe.create;V.create;const ne=we.create,Ge=Q.create;ye.create;Z.create;te.create;const ht=U({x:z().int().min(0),y:z().int().min(0)}),rs=U({tileId:z().int().min(0),position:ht,rotation:as([ne(0),ne(90),ne(180),ne(270)]).optional()}),os=U({id:A().min(1),name:A().min(1),zIndex:z().int(),visible:dt(),tiles:ke(rs)}),ls=U({width:z().int().min(1).max(256),height:z().int().min(1).max(256),tileWidth:z().int().min(1),tileHeight:z().int().min(1)}),ds=U({position:ht,type:Ge(["floor","blocker","slow","hole","conveyor","hazard-burn","door","exit","spawn"]),direction:Ge(["north","east","south","west"]).optional(),doorId:A().optional(),open:dt().optional(),damage:z().int().min(0).optional()}),hs=U({id:A(),name:A(),author:A().optional(),created:A(),modified:A(),version:z().int().min(1)}),cs=U({version:ne(1),metadata:hs,grid:ls,layers:ke(os).min(1),tileBehaviors:ke(ds).optional()});function us(a){return cs.parse(a)}function de(a,e={}){const t=a.toData();return e.pretty?JSON.stringify(t,null,2):JSON.stringify(t)}function he(a){const e=JSON.parse(a),t=us(e);return R.fromData(t)}function ps(a,e){const t=de(a,{pretty:!0}),s=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(s),n=document.createElement("a");n.href=i,n.download=e??`${a.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}function Pe(a){return new Promise((e,t)=>{const s=new FileReader;s.onload=i=>{var n;try{const r=(n=i.target)==null?void 0:n.result,o=he(r);e(o)}catch(r){t(r)}},s.onerror=()=>{t(new Error("Failed to read file"))},s.readAsText(a)})}function ms(a,e="isometric_level"){const t=de(a);localStorage.setItem(e,t)}function fs(a="isometric_level"){const e=localStorage.getItem(a);if(!e)return null;try{return he(e)}catch{return null}}class ys{constructor(e,t){l(this,"canvas");l(this,"camera");l(this,"renderer");l(this,"tileRegistry");l(this,"state");l(this,"history");l(this,"_level");l(this,"tools",new Map);l(this,"activeTool",null);l(this,"animationFrameId",null);l(this,"isRunning",!1);l(this,"handleMouseDown",e=>{if(e.button!==0)return;const t=this.getGridCoord(e);t&&this.activeTool&&this.activeTool.onMouseDown(this.getToolContext(),t)});l(this,"handleMouseMove",e=>{const t=this.getGridCoord(e);if(this.state.setHoveredCoord(t),t?this.renderer.setHoveredCoord(t):this.renderer.setHoveredCoord(null),t&&this.activeTool){const s=(e.buttons&1)!==0;this.activeTool.onMouseMove(this.getToolContext(),t,s)}});l(this,"handleMouseUp",e=>{if(e.button!==0)return;const t=this.getGridCoord(e);t&&this.activeTool&&this.activeTool.onMouseUp(this.getToolContext(),t)});l(this,"handleMouseLeave",()=>{this.state.setHoveredCoord(null),this.renderer.setHoveredCoord(null)});l(this,"handleWheel",e=>{e.preventDefault();const t=-e.deltaY*.001,s=this.canvas.element.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top;this.camera.zoomBy(t,i,n)});l(this,"handleKeyDown",e=>{if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)){if(e.key==="z"&&(e.ctrlKey||e.metaKey)){e.shiftKey?this.history.redo():this.history.undo(),e.preventDefault();return}if(e.key==="y"&&(e.ctrlKey||e.metaKey)){this.history.redo(),e.preventDefault();return}if(e.key==="s"&&(e.ctrlKey||e.metaKey)){this.saveToStorage(),e.preventDefault();return}for(const t of this.tools.values())if(t.shortcut===e.key.toLowerCase()){this.setTool(t.type);return}}});l(this,"renderLoop",()=>{this.isRunning&&(this.render(),this.animationFrameId=requestAnimationFrame(this.renderLoop))});this.canvas=new Ee({canvas:e.canvas,container:e.container}),this.camera=new Le({zoom:2}),this.tileRegistry=t,this.renderer=new Ie(this.canvas,this.camera,t),this.state=new Tt,this.history=new kt({maxSize:100}),this._level=R.createDefault();const s=this._level.getLayers()[0];s&&this.state.setActiveLayer(s.config.id),this.registerTool(new Pt),this.registerTool(new zt),this.setTool("brush"),this.setupEventListeners()}get level(){return this._level}registerTool(e){this.tools.set(e.type,e)}setTool(e){var i,n,r,o,d;const t=this.tools.get(e);if(!t)return;this.activeTool&&((n=(i=this.activeTool).onDeactivate)==null||n.call(i,this.getToolContext())),this.activeTool=t,(o=(r=this.activeTool).onActivate)==null||o.call(r,this.getToolContext()),this.state.setActiveTool(e);const s=((d=t.getCursor)==null?void 0:d.call(t))??"default";this.canvas.element.style.cursor=s}getToolContext(){return{level:this._level,editorState:this.state,history:this.history}}newLevel(e,t={}){const s=R.createDefault(e,t);this.setLevel(s),this.camera.setPosition(0,0)}loadLevel(e){const t=he(e);this.setLevel(t)}async loadLevelFromFile(e){const t=await Pe(e);this.setLevel(t)}setLevel(e){this._level=e,this.history.clear();const t=this._level.getLayers()[0];t&&this.state.setActiveLayer(t.config.id),this.state.notifyLevelLoaded(e.toData()),this.state.markClean()}saveLevel(){const e=de(this._level,{pretty:!0});return this.history.markSaved(),this.state.markClean(),e}downloadLevel(e){ps(this._level,e),this.history.markSaved(),this.state.markClean()}saveToStorage(){ms(this._level),this.history.markSaved(),this.state.markClean()}loadFromStorage(){const e=fs();return e?(this.setLevel(e),!0):!1}setupEventListeners(){const e=this.canvas.element;e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("mousemove",this.handleMouseMove),e.addEventListener("mouseup",this.handleMouseUp),e.addEventListener("mouseleave",this.handleMouseLeave),e.addEventListener("wheel",this.handleWheel,{passive:!1}),window.addEventListener("keydown",this.handleKeyDown)}getGridCoord(e){const t=this.canvas.element.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,n=this.renderer.screenToGrid(s,i,this._level);return this._level.isInBounds(n)?n:null}start(){this.isRunning||(this.isRunning=!0,this.renderLoop())}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}render(){this.renderer.render(this._level)}dispose(){this.stop();const e=this.canvas.element;e.removeEventListener("mousedown",this.handleMouseDown),e.removeEventListener("mousemove",this.handleMouseMove),e.removeEventListener("mouseup",this.handleMouseUp),e.removeEventListener("mouseleave",this.handleMouseLeave),e.removeEventListener("wheel",this.handleWheel),window.removeEventListener("keydown",this.handleKeyDown),this.canvas.dispose()}}class gs{constructor(e,t,s){l(this,"container");l(this,"editor");l(this,"tileRegistry");l(this,"selectedTileId",null);l(this,"tileElements",new Map);const i=document.getElementById(e);if(!i)throw new Error(`Container not found: ${e}`);this.container=i,this.editor=t,this.tileRegistry=s,this.render(),this.setupEventListeners()}render(){this.container.innerHTML="";const e=this.tileRegistry.getAllTileIds(),t=document.createElement("div");t.id="tile-grid";for(const s of e){const i=this.createTileItem(s);this.tileElements.set(s,i),t.appendChild(i)}this.container.appendChild(t)}createTileItem(e){const t=document.createElement("div");t.className="tile-item",t.dataset.tileId=String(e);const s=this.tileRegistry.createTilePreview(e,1.5);return s.style.imageRendering="pixelated",t.appendChild(s),t}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest(".tile-item");if(s&&s.dataset.tileId){const i=parseInt(s.dataset.tileId,10);this.selectTile(i)}}),this.editor.state.on("tile:selected",e=>{const{tileId:t}=e;this.updateSelection(t)})}selectTile(e){this.selectedTileId=e,this.editor.state.setSelectedTile(e),this.updateSelection(e)}updateSelection(e){if(this.tileElements.forEach(t=>{t.classList.remove("selected")}),e!==null){const t=this.tileElements.get(e);t==null||t.classList.add("selected")}this.selectedTileId=e}getSelectedTileId(){return this.selectedTileId}}class vs{constructor(e,t){l(this,"container");l(this,"editor");l(this,"layerElements",new Map);const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.render(),this.setupEventListeners()}render(){this.container.innerHTML="",this.layerElements.clear();const e=this.editor.level.getLayers(),t=this.editor.state.activeLayerId,s=[...e].reverse();for(const i of s){const n=this.createLayerItem(i,i.config.id===t);this.layerElements.set(i.config.id,n),this.container.appendChild(n)}}createLayerItem(e,t){const s=document.createElement("div");s.className=`layer-item${t?" active":""}`,s.dataset.layerId=e.config.id;const i=document.createElement("button");i.className="layer-visibility",i.textContent=e.config.visible?"":"",i.title=e.config.visible?"Hide layer":"Show layer",i.addEventListener("click",o=>{o.stopPropagation(),this.toggleLayerVisibility(e.config.id)});const n=document.createElement("span");n.className="layer-name",n.textContent=e.config.name;const r=document.createElement("span");return r.className="layer-count",r.textContent=String(e.tileCount),r.style.cssText="font-size: 11px; color: #666; margin-left: auto;",s.appendChild(i),s.appendChild(n),s.appendChild(r),s}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest(".layer-item");s&&s.dataset.layerId&&this.selectLayer(s.dataset.layerId)}),this.editor.state.on("layer:changed",()=>{this.updateActiveLayer()}),this.editor.history.on("change",()=>{this.updateTileCounts()}),this.editor.state.on("level:loaded",()=>{this.render()})}selectLayer(e){this.editor.state.setActiveLayer(e),this.updateActiveLayer()}toggleLayerVisibility(e){const t=this.editor.level.getLayer(e);t&&(t.toggleVisible(),this.render())}updateActiveLayer(){const e=this.editor.state.activeLayerId;this.layerElements.forEach((t,s)=>{s===e?t.classList.add("active"):t.classList.remove("active")})}updateTileCounts(){const e=this.editor.level.getLayers();for(const t of e){const s=this.layerElements.get(t.config.id);if(s){const i=s.querySelector(".layer-count");i&&(i.textContent=String(t.tileCount))}}}}const bs=[{type:"brush",name:"Brush",icon:"",shortcut:"B"},{type:"eraser",name:"Eraser",icon:"",shortcut:"E"}];class Cs{constructor(e,t){l(this,"container");l(this,"editor");l(this,"buttonElements",new Map);l(this,"fileInput");l(this,"handleFileInputChange",async()=>{var t;const e=(t=this.fileInput.files)==null?void 0:t[0];if(e)try{await this.editor.loadLevelFromFile(e)}catch(s){const i=s instanceof Error?s.message:"Unknown error";window.alert(`Failed to import level: ${i}`)}finally{this.fileInput.value=""}});const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.fileInput=this.createFileInput(),this.render(),this.container.appendChild(this.fileInput),this.setupEventListeners()}render(){this.container.innerHTML="";for(const t of bs){const s=this.createToolButton(t);this.buttonElements.set(t.type,s),this.container.appendChild(s)}const e=document.createElement("div");e.style.cssText="width: 1px; height: 24px; background: #0f3460; margin: 0 8px;",this.container.appendChild(e),this.addActionButton("","Save (Ctrl+S)",()=>{this.editor.saveToStorage()}),this.addActionButton("","Import JSON",()=>{this.fileInput.click()}),this.addActionButton("","Download JSON",()=>{this.editor.downloadLevel()}),this.addActionButton("","Undo (Ctrl+Z)",()=>{this.editor.history.undo()}),this.addActionButton("","Redo (Ctrl+Y)",()=>{this.editor.history.redo()}),this.updateActiveButton()}createToolButton(e){const t=document.createElement("button");return t.className="tool-btn",t.dataset.tool=e.type,t.title=`${e.name} (${e.shortcut})`,t.textContent=`${e.icon} ${e.name}`,t}addActionButton(e,t,s){const i=document.createElement("button");i.className="tool-btn",i.title=t,i.textContent=e,i.addEventListener("click",s),this.container.appendChild(i)}createFileInput(){const e=document.createElement("input");return e.type="file",e.accept="application/json",e.style.display="none",e.addEventListener("change",this.handleFileInputChange),e}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest(".tool-btn[data-tool]");s&&s.dataset.tool&&this.editor.setTool(s.dataset.tool)}),this.editor.state.on("tool:changed",()=>{this.updateActiveButton()})}updateActiveButton(){const e=this.editor.state.activeTool;this.buttonElements.forEach((t,s)=>{s===e?t.classList.add("active"):t.classList.remove("active")})}}class xs{constructor(e){l(this,"positionEl");l(this,"tileEl");l(this,"layerEl");l(this,"editor");this.editor=e,this.positionEl=document.getElementById("status-position"),this.tileEl=document.getElementById("status-tile"),this.layerEl=document.getElementById("status-layer"),this.setupEventListeners(),this.update()}setupEventListeners(){this.editor.state.on("hover:changed",()=>{this.updatePosition()}),this.editor.state.on("tile:selected",()=>{this.updateTile()}),this.editor.state.on("layer:changed",()=>{this.updateLayer()})}update(){this.updatePosition(),this.updateTile(),this.updateLayer()}updatePosition(){const e=this.editor.state.hoveredCoord;e?this.positionEl.textContent=`Position: ${e.x}, ${e.y}`:this.positionEl.textContent="Position: --"}updateTile(){const e=this.editor.state.selectedTileId;e!==null?this.tileEl.textContent=`Tile: ${e}`:this.tileEl.textContent="Tile: --"}updateLayer(){const e=this.editor.state.activeLayerId;if(e){const t=this.editor.level.getLayer(e);this.layerEl.textContent=`Layer: ${(t==null?void 0:t.config.name)??e}`}else this.layerEl.textContent="Layer: --"}}class ws{constructor(e,t){l(this,"container");l(this,"editor");l(this,"zoomInput");l(this,"zoomValue");const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.zoomInput=document.createElement("input"),this.zoomValue=document.createElement("span"),this.render(),this.setupEventListeners(),this.updateZoomDisplay(this.editor.camera.zoom)}render(){this.container.innerHTML="";const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Zoom";const s=document.createElement("div");s.className="control-row",this.zoomInput.type="range",this.zoomInput.className="control-range",this.zoomInput.min=String(this.editor.camera.minZoomLevel),this.zoomInput.max=String(this.editor.camera.maxZoomLevel),this.zoomInput.step="0.1",this.zoomInput.value=String(this.editor.camera.zoom),this.zoomInput.setAttribute("aria-label","Zoom level"),this.zoomValue.className="control-value",s.appendChild(this.zoomInput),s.appendChild(this.zoomValue),e.appendChild(t),e.appendChild(s),this.container.appendChild(e)}setupEventListeners(){this.zoomInput.addEventListener("input",()=>{const e=Number(this.zoomInput.value),t=this.editor.canvas.element.getBoundingClientRect(),s=t.width/2,i=t.height/2;this.editor.camera.setZoom(e,s,i)}),this.editor.camera.onZoomChange(e=>{this.updateZoomDisplay(e)})}updateZoomDisplay(e){const t=Math.round(e*100)/100;this.zoomInput.value=String(t),this.zoomValue.textContent=`${Math.round(t*100)}%`}}const _s=[8,16,32,64,128];class Ss{constructor(e,t){l(this,"container");l(this,"editor");l(this,"sizeButtons",new Map);l(this,"sizeMeta");l(this,"clearButton");const s=document.getElementById(e);if(!s)throw new Error(`Container not found: ${e}`);this.container=s,this.editor=t,this.sizeMeta=document.createElement("div"),this.clearButton=document.createElement("button"),this.render(),this.setupEventListeners(),this.updateSizeDisplay()}render(){this.container.innerHTML="",this.sizeButtons.clear();const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Map Size",this.sizeMeta.className="control-meta";const s=document.createElement("div");s.className="button-group";for(const i of _s){const n=document.createElement("button");n.type="button",n.className="tool-btn size-btn",n.dataset.size=String(i),n.textContent=`${i}x${i}`,n.setAttribute("aria-pressed","false"),this.sizeButtons.set(i,n),s.appendChild(n)}e.appendChild(t),e.appendChild(this.sizeMeta),e.appendChild(s),this.clearButton.type="button",this.clearButton.className="tool-btn danger full-width",this.clearButton.textContent="Clear All",this.clearButton.title="Clear all tiles from all layers",this.container.appendChild(e),this.container.appendChild(this.clearButton)}setupEventListeners(){this.container.addEventListener("click",e=>{const s=e.target.closest("button[data-size]");if(s!=null&&s.dataset.size){const i=Number(s.dataset.size);this.confirmResize(i);return}}),this.clearButton.addEventListener("click",()=>{this.clearAllTiles()}),this.editor.state.on("level:loaded",()=>{this.updateSizeDisplay()})}confirmResize(e){const{gridWidth:t,gridHeight:s}=this.editor.level;if(t===e&&s===e||!window.confirm(`Resize map to ${e}x${e}? This will clear all tiles and start a new level.`))return;const n=this.editor.level.metadata.name;this.editor.newLevel(n,{width:e,height:e}),this.updateSizeDisplay()}clearAllTiles(){const t=this.editor.level.getLayers().filter(r=>r.tileCount>0);if(t.length===0||!window.confirm("Clear all tiles from every layer?"))return;const i=t.map(r=>new Bt(this.editor.level,r.config.id)),n=new It(i,"Clear all layers");this.editor.history.execute(n),this.editor.state.markDirty()}updateSizeDisplay(){const e=this.editor.level.gridWidth,t=this.editor.level.gridHeight;this.sizeMeta.textContent=`Current: ${e}x${t}`,this.sizeButtons.forEach((s,i)=>{const n=e===t&&i===e;s.classList.toggle("active",n),s.setAttribute("aria-pressed",String(n))})}}const Ye={floor:"rgba(74, 158, 255, 0.08)",blocker:"rgba(255, 74, 74, 0.45)",slow:"rgba(255, 199, 94, 0.35)",hole:"rgba(20, 20, 20, 0.6)",conveyor:"rgba(74, 158, 255, 0.22)","hazard-burn":"rgba(255, 132, 74, 0.38)",door:"rgba(156, 132, 255, 0.4)",exit:"rgba(74, 255, 198, 0.35)",spawn:"rgba(138, 255, 74, 0.32)"},Ts="rgba(74, 255, 158, 0.5)",ks="rgba(74, 158, 255, 0.65)",Es="rgba(74, 255, 158, 0.9)",Ls="rgba(255, 221, 94, 0.9)",Xe="rgba(255, 132, 132, 0.9)";class Is{constructor(e){l(this,"canvas");l(this,"camera");l(this,"renderer");l(this,"tileRegistry");l(this,"level");l(this,"selected",null);l(this,"hovered",null);l(this,"clickMode","move");l(this,"listeners",new Map);l(this,"animationFrame",null);l(this,"lastTimestamp",0);l(this,"isRunning",!1);l(this,"isPaused",!0);l(this,"baseStepDuration",.25);l(this,"defaultHazardDamage",1);l(this,"defaultConveyorDirection","east");l(this,"hazardPenalty",2.5);l(this,"exitTile",null);l(this,"speedMultiplier",1);l(this,"player",{position:{x:0,y:0},spawn:null,hp:2,maxHp:2,alive:!0,reachedExit:!1,destination:null,path:[],segmentIndex:0,segmentProgress:0,currentStepDuration:.25,moving:!1,isAnimating:!1,stepMode:!1,pendingStep:!0,lastDamageAt:0,pathHasHazard:!1,state:"normal"});this.tileRegistry=e.tileRegistry,this.canvas=new Ee({canvas:e.canvas,container:e.container}),this.camera=new Le({zoom:2}),this.renderer=new Ie(this.canvas,this.camera,this.tileRegistry),this.renderer.setOptions({showHover:!1,showSelection:!1}),this.level=R.createDefault("Movement Test"),this.setupEventListeners(),this.resetPlayerPosition(),this.start()}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;return(s=this.listeners.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.listeners.get(e))==null||s.forEach(i=>{i(t)})}emitPlayerState(){const e=this.player.path[this.player.segmentIndex+1]??null;this.emit("player:updated",{position:{...this.player.position},hp:this.player.hp,maxHp:this.player.maxHp,alive:this.player.alive,spawn:this.player.spawn,stepMode:this.player.stepMode,reachedExit:this.player.reachedExit,destination:this.player.destination,nextStep:e,state:this.player.state,paused:this.isPaused,speed:this.speedMultiplier,pathHasHazard:this.player.pathHasHazard})}getLevel(){return this.level}getSelectedCoord(){return this.selected}getTileBehavior(e){const t=this.level.getTileBehavior(e);return t?t.type==="conveyor"?{type:"conveyor",direction:t.direction??this.defaultConveyorDirection}:t.type==="door"?{type:"door",doorId:t.doorId,open:t.open??!1}:t.type==="hazard-burn"?{type:"hazard-burn",damage:t.damage??this.defaultHazardDamage}:t:{type:"floor"}}setClickMode(e){this.clickMode!==e&&(this.clickMode=e,this.emit("mode:changed",{mode:e}))}setPaused(e){this.isPaused!==e&&(this.isPaused=e,this.emitPlayerState())}setSpeed(e){[1,2,4].includes(e)&&this.speedMultiplier!==e&&(this.speedMultiplier=e,this.emitPlayerState())}setStepMode(e){this.player.stepMode=e,this.player.pendingStep=!e,this.emitPlayerState()}setDefaultConveyorDirection(e){this.defaultConveyorDirection=e}setDefaultHazardDamage(e){Number.isFinite(e)&&(this.defaultHazardDamage=Math.max(1,Math.round(e)))}advanceTurn(){this.player.alive&&this.player.stepMode&&(this.player.pendingStep=!0)}async loadLevelFromFile(e){const t=await Pe(e);this.setLevel(t)}useLevelClone(e){const t=de(e),s=he(t);this.setLevel(s)}setLevel(e){this.level=e,this.isPaused=!0,this.exitTile=this.findExitTile(),this.selected=null,this.hovered=null,this.resetPlayerPosition(),this.emit("selection:changed",{coord:null,behavior:{type:"floor"}}),this.emit("level:changed",{level:e})}setSelectedKind(e){this.selected&&(this.setTileBehavior(this.selected,this.createDefaultBehavior(e)),this.emitSelection(this.selected))}setTileBehavior(e,t){if(!this.level.isInBounds(e))return;const s=this.getTileBehavior(e),i=this.isBlocked(e);this.level.setTileBehavior(e,t),((t==null?void 0:t.type)==="spawn"||this.player.spawn&&this.sameCoord(this.player.spawn,e))&&(this.player.spawn=this.findSpawnPoint()),((t==null?void 0:t.type)==="exit"||(s==null?void 0:s.type)==="exit")&&(this.exitTile=this.findExitTile(),this.planDefaultDestination()),this.player.destination&&this.player.moving&&i!==this.isBlocked(e)?this.rebuildPathToDestination():this.player.destination&&this.player.moving&&this.rebuildPathToDestination(),this.emitSelection(e)}updateSelectedBehavior(e){if(!this.selected)return;const t=this.getTileBehavior(this.selected);t.type!=="floor"&&this.setTileBehavior(this.selected,{...t,...e})}toggleDoorState(e){const t=this.getTileBehavior(e);t.type==="door"&&this.setTileBehavior(e,{...t,open:!t.open})}start(){this.isRunning||(this.isRunning=!0,this.lastTimestamp=performance.now(),this.loop(this.lastTimestamp))}stop(){this.isRunning=!1,this.animationFrame!==null&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)}resetPlayer(){this.isPaused=!0,this.resetPlayerPosition()}setupEventListeners(){const e=this.canvas.element;e.addEventListener("mousedown",t=>{if(t.button!==0)return;const s=this.screenToGrid(t);s&&(this.clickMode==="edit"?this.selectCoord(s):(this.selectCoord(s),this.movePlayerTo(s)))}),e.addEventListener("mousemove",t=>{const s=this.screenToGrid(t);this.hovered=s}),e.addEventListener("mouseleave",()=>{this.hovered=null}),e.addEventListener("wheel",t=>{t.preventDefault();const s=-t.deltaY*.001,i=e.getBoundingClientRect();this.camera.zoomBy(s,t.clientX-i.left,t.clientY-i.top)},{passive:!1})}selectCoord(e){this.selected=e,this.emitSelection(e)}emitSelection(e){this.emit("selection:changed",{coord:e,behavior:this.getTileBehavior(e)})}screenToGrid(e){const t=this.canvas.element.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,n=this.renderer.screenToGrid(s,i,this.level);return this.level.isInBounds(n)?n:null}resetPlayerPosition(){const e=this.findSpawnPoint()??this.findFirstWalkable()??{x:0,y:0};this.player.position=e,this.player.spawn=e,this.player.hp=this.player.maxHp,this.player.alive=!0,this.player.reachedExit=!1,this.player.state="normal",this.player.destination=null,this.player.path=[e],this.player.segmentIndex=0,this.player.segmentProgress=0,this.player.currentStepDuration=this.baseStepDuration,this.player.moving=!1,this.player.isAnimating=!1,this.player.pendingStep=!this.player.stepMode,this.player.pathHasHazard=!1,this.emit("path:updated",{hasPath:!1,path:this.player.path}),this.planDefaultDestination(),this.emitPlayerState()}createDefaultBehavior(e){switch(e){case"blocker":case"slow":case"hole":case"exit":case"spawn":return{type:e};case"conveyor":return{type:"conveyor",direction:this.defaultConveyorDirection};case"hazard-burn":return{type:"hazard-burn",damage:this.defaultHazardDamage};case"door":return{type:"door",open:!1};case"floor":default:return null}}planDefaultDestination(){if(!this.exitTile){this.player.destination=null,this.player.moving=!1,this.player.pathHasHazard=!1,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:this.player.path}),this.emitPlayerState();return}this.movePlayerTo(this.exitTile)}movePlayerTo(e){if(!this.level.isInBounds(e)||!this.player.alive||this.isBlocked(e))return;const t=this.roundCoord(this.player.position),s=this.findPath(t,e);if(!s||s.length===0){this.stopMovement();return}if(s.length<=1){this.player.destination=e,this.player.path=s,this.player.moving=!1,this.player.isAnimating=!1,this.player.pathHasHazard=!1,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:s}),this.emitPlayerState();return}this.player.destination=e,this.player.path=s,this.player.segmentIndex=0,this.player.segmentProgress=0,this.player.currentStepDuration=this.getStepDuration(s[1]??e),this.player.moving=!0,this.player.isAnimating=!1,this.player.pendingStep=!this.player.stepMode,this.player.pathHasHazard=this.pathContainsHazard(s,1),this.updateClopState(),this.emit("path:updated",{hasPath:!0,path:s}),this.emitPlayerState()}findPath(e,t){const s=this.key(e),i=this.key(t),n=[s],r=new Map,o=new Map([[s,0]]),d=new Map([[s,this.heuristic(e,t)]]);for(r.set(s,null);n.length>0;){n.sort((b,w)=>(d.get(b)??1/0)-(d.get(w)??1/0));const h=n.shift();if(h===i)return this.reconstructPath(r,h);const p=this.fromKey(h);for(const b of this.getNeighbors(p)){const w=this.key(b);if(this.isBlocked(b)||this.isHole(b))continue;const T=this.getTraversalCost(b);if(!Number.isFinite(T))continue;const N=(o.get(h)??1/0)+T;N<(o.get(w)??1/0)&&(r.set(w,h),o.set(w,N),d.set(w,N+this.heuristic(b,t)),n.includes(w)||n.push(w))}}return null}heuristic(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}getTraversalCost(e){const t=this.getTileBehavior(e).type;return t==="slow"?2.5:t==="hazard-burn"?this.hazardPenalty:1}getStepDuration(e){return this.getTileBehavior(e).type==="slow"?this.baseStepDuration*2.5:this.baseStepDuration}reconstructPath(e,t){const s=[this.fromKey(t)];let i=e.get(t);for(;i;)s.push(this.fromKey(i)),i=e.get(i);return s.reverse()}getNeighbors(e){return[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].filter(s=>this.level.isInBounds(s))}isBlocked(e){const t=this.getTileBehavior(e);return t.type==="blocker"||t.type==="door"&&!t.open}isHole(e){return this.getTileBehavior(e).type==="hole"}stopMovement(){this.player.moving=!1,this.player.isAnimating=!1,this.player.path=[this.roundCoord(this.player.position)],this.player.pathHasHazard=!1,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:this.player.path}),this.emitPlayerState()}roundCoord(e){return{x:Math.round(e.x),y:Math.round(e.y)}}loop(e){if(!this.isRunning)return;const t=e-this.lastTimestamp;this.lastTimestamp=e,this.update(t/1e3),this.render(),this.animationFrame=requestAnimationFrame(s=>this.loop(s))}update(e){if(!this.player.alive||(!this.player.destination&&this.exitTile&&this.movePlayerTo(this.exitTile),this.isPaused)||(this.shouldStartNextSegment()&&this.beginSegment(),!this.player.isAnimating||this.player.path.length<2))return;const t=this.player.segmentIndex,s=t+1,i=this.player.path[t],n=this.player.path[s];if(!i||!n){this.stopMovement();return}const r=e*this.speedMultiplier;if(this.player.segmentProgress+=r/this.player.currentStepDuration,this.player.segmentProgress>=1)this.player.position={x:n.x,y:n.y},this.player.segmentIndex=s,this.player.segmentProgress=0,this.player.isAnimating=!1,s>=this.player.path.length-1?(this.player.moving=!1,this.emit("path:updated",{hasPath:!1,path:this.player.path})):this.player.pendingStep=!this.player.stepMode,this.handleTileArrival(n);else{const o=this.player.segmentProgress;this.player.position={x:i.x+(n.x-i.x)*o,y:i.y+(n.y-i.y)*o}}}shouldStartNextSegment(){return!(!this.player.moving||this.player.isAnimating||this.player.segmentIndex>=this.player.path.length-1||this.isPaused||this.player.stepMode&&!this.player.pendingStep)}beginSegment(){const e=this.player.path[this.player.segmentIndex+1];e&&(this.player.currentStepDuration=this.getStepDuration(e),this.player.isAnimating=!0,this.player.pendingStep=!1)}handleTileArrival(e){const t=this.getTileBehavior(e);if(t.type==="spawn"&&(this.player.spawn=e),t.type==="hole"){this.player.alive=!1,this.player.moving=!1,this.player.destination=null,this.player.pathHasHazard=!1,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:[e]}),this.emitPlayerState();return}if(!(t.type==="hazard-burn"&&(this.applyDamage(t.damage??this.defaultHazardDamage),!this.player.alive))){if(t.type==="exit"){this.player.reachedExit=!0,this.player.moving=!1,this.player.pathHasHazard=!1,this.isPaused=!0,this.updateClopState(),this.emit("path:updated",{hasPath:!1,path:[e]}),this.emitPlayerState();return}if(t.type==="conveyor"){const s=this.getConveyorTarget(e,t.direction??this.defaultConveyorDirection);if(s){this.forceMoveTo(s);return}}if(this.player.destination&&!this.sameCoord(e,this.player.destination)&&this.player.alive){this.rebuildPathToDestination();return}if(this.player.destination&&this.sameCoord(e,this.player.destination)&&this.exitTile&&!this.sameCoord(e,this.exitTile)){this.movePlayerTo(this.exitTile);return}this.player.pathHasHazard=this.pathContainsHazard(this.player.path,this.player.segmentIndex+1),this.updateClopState(),this.emitPlayerState()}}getConveyorTarget(e,t){const s=t==="north"?{x:e.x,y:e.y-1}:t==="south"?{x:e.x,y:e.y+1}:t==="west"?{x:e.x-1,y:e.y}:{x:e.x+1,y:e.y};return!this.level.isInBounds(s)||this.isBlocked(s)?null:s}forceMoveTo(e){this.player.path=[this.roundCoord(this.player.position),e],this.player.segmentIndex=0,this.player.segmentProgress=0,this.player.currentStepDuration=this.getStepDuration(e),this.player.moving=!0,this.player.isAnimating=!1,this.player.pendingStep=!0,this.player.pathHasHazard=this.pathContainsHazard(this.player.path,1),this.updateClopState(),this.emit("path:updated",{hasPath:!0,path:this.player.path}),this.emitPlayerState()}rebuildPathToDestination(){if(!this.player.destination)return;const e=this.roundCoord(this.player.position),t=this.findPath(e,this.player.destination);if(!t||t.length===0){this.stopMovement(),this.emitPlayerState();return}this.player.path=t,this.player.segmentIndex=0,this.player.segmentProgress=0,this.player.currentStepDuration=this.getStepDuration(t[1]??this.player.destination),this.player.moving=!0,this.player.isAnimating=!1,this.player.pendingStep=!this.player.stepMode,this.player.pathHasHazard=this.pathContainsHazard(t,1),this.updateClopState(),this.emit("path:updated",{hasPath:!0,path:t}),this.emitPlayerState()}updateClopState(){this.player.alive&&(this.player.hp<this.player.maxHp?this.player.state="hurt":!this.player.destination||this.player.pathHasHazard||!this.player.moving&&this.player.path.length<=1?this.player.state="scared":this.player.state="normal")}applyDamage(e){this.player.hp=Math.max(0,this.player.hp-e),this.player.lastDamageAt=performance.now(),this.player.hp<=0&&(this.player.alive=!1,this.player.moving=!1,this.player.destination=null,this.player.pathHasHazard=!1,this.emit("path:updated",{hasPath:!1,path:[this.roundCoord(this.player.position)]})),this.updateClopState(),this.emitPlayerState()}render(){this.renderer.render(this.level);const e=this.canvas.ctx;e.save(),this.camera.applyTransform(e);const t=ae(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,this.level.gridWidth,this.level.gridHeight);this.renderKindOverlays(e,t.x,t.y),this.renderSelection(e,t.x,t.y),this.renderPath(e,t.x,t.y),this.renderPlayer(e,t.x,t.y),e.restore()}renderKindOverlays(e,t,s){e.save(),e.font="10px sans-serif",e.textAlign="center",e.textBaseline="middle",e.strokeStyle="rgba(0,0,0,0.6)";for(let i=0;i<this.level.gridHeight;i++)for(let n=0;n<this.level.gridWidth;n++){const r={x:n,y:i},o=this.getTileBehavior(r),d=this.getOverlayColor(o);this.drawDiamond(e,r,t,s,d),this.drawTileIcon(e,r,o,t,s)}e.restore()}renderSelection(e,t,s){this.selected&&this.drawDiamond(e,this.selected,t,s,Ts)}renderPath(e,t,s){if(this.player.path.length){e.strokeStyle=ks,e.lineWidth=2,e.beginPath();for(let i=0;i<this.player.path.length;i++){const n=this.player.path[i];if(!n)continue;const r=E(n.x,n.y,t,s);i===0?e.moveTo(r.x,r.y+_/2):e.lineTo(r.x,r.y+_/2)}e.stroke()}}renderPlayer(e,t,s){const i=E(this.player.position.x,this.player.position.y,t,s),n=performance.now()-this.player.lastDamageAt<400,r=this.player.state==="hurt"?Xe:this.player.state==="scared"?Ls:Es;e.fillStyle=n?Xe:r,e.beginPath(),e.arc(i.x,i.y+_/2,k/4,0,Math.PI*2),e.fill();const o=`${this.player.hp}/${this.player.maxHp}`;e.fillStyle="rgba(15,15,20,0.75)",e.strokeStyle="rgba(0,0,0,0.6)",e.lineWidth=2,this.drawRoundedRect(e,i.x-16,i.y-6,32,14,6),e.fill(),e.stroke(),e.fillStyle="#fff",e.font="10px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(o,i.x,i.y+1)}drawDiamond(e,t,s,i,n){const r=E(t.x,t.y,s,i);e.fillStyle=n,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(r.x+k/2,r.y+_/2),e.lineTo(r.x,r.y+_),e.lineTo(r.x-k/2,r.y+_/2),e.closePath(),e.fill()}drawTileIcon(e,t,s,i,n){const r=E(t.x,t.y,i,n),o=r.x,d=r.y+_/2;switch(s.type){case"hole":e.fillStyle="rgba(0,0,0,0.6)",e.beginPath(),e.ellipse(o,d+2,k/5,_/3,0,0,Math.PI*2),e.fill();break;case"conveyor":this.drawArrow(e,o,d,s.direction??this.defaultConveyorDirection);break;case"hazard-burn":this.drawFlame(e,o,d);break;case"door":this.drawDoor(e,o,d,s.open??!1);break;case"exit":this.drawStar(e,o,d,"#4affc6");break;case"spawn":this.drawStar(e,o,d,"#8aff4a",4);break}}drawArrow(e,t,s,i){e.save(),e.strokeStyle="#d2e8ff",e.fillStyle="#d2e8ff",e.lineWidth=2,e.beginPath();const n=8,r=i==="east"?1:i==="west"?-1:0,o=i==="south"?1:i==="north"?-1:0;e.moveTo(t-r*n*.4,s-o*n*.4),e.lineTo(t+r*n*.8,s+o*n*.8),e.stroke(),e.beginPath(),e.moveTo(t+r*n,s+o*n),e.lineTo(t+r*n-o*4+r*2,s+o*n+r*4+o*2),e.lineTo(t+r*n+o*4+r*2,s+o*n-r*4+o*2),e.closePath(),e.fill(),e.restore()}drawFlame(e,t,s){e.save(),e.fillStyle="#ffb347",e.beginPath(),e.moveTo(t,s-6),e.quadraticCurveTo(t+6,s-2,t,s+6),e.quadraticCurveTo(t-6,s-2,t,s-6),e.fill(),e.fillStyle="#ff6b3d",e.beginPath(),e.moveTo(t,s-4),e.quadraticCurveTo(t+3,s,t,s+4),e.quadraticCurveTo(t-3,s,t,s-4),e.fill(),e.restore()}drawDoor(e,t,s,i){e.save(),e.fillStyle=i?"rgba(200,255,200,0.9)":"rgba(120,90,180,0.9)",e.strokeStyle="rgba(0,0,0,0.45)",e.lineWidth=2,this.drawRoundedRect(e,t-8,s-6,16,12,3),e.fill(),e.stroke(),i||(e.beginPath(),e.moveTo(t-4,s),e.lineTo(t+4,s),e.stroke()),e.restore()}drawStar(e,t,s,i,n=5){e.save(),e.fillStyle=i;const r=7,o=3,d=Math.PI/n;e.beginPath();for(let h=0;h<2*n;h++){const p=h%2===0?r:o,b=h*d-Math.PI/2;e.lineTo(t+Math.cos(b)*p,s+Math.sin(b)*p)}e.closePath(),e.fill(),e.restore()}getOverlayColor(e){return e.type==="door"&&e.open?"rgba(138, 255, 200, 0.3)":Ye[e.type]??Ye.floor}findFirstWalkable(){for(let e=0;e<this.level.gridHeight;e++)for(let t=0;t<this.level.gridWidth;t++){const s={x:t,y:e},i=this.getTileBehavior(s);if(!this.isBlocked(s)&&i.type!=="hole")return s}return null}findExitTile(){let e=null;return this.level.forEachTileBehavior(t=>{t.type==="exit"&&!e&&(e=t.position)}),e}findSpawnPoint(){let e=null;return this.level.forEachTileBehavior(t=>{t.type==="spawn"&&!e&&(e=t.position)}),e}pathContainsHazard(e,t=0){return e.slice(t).some(s=>this.getTileBehavior(s).type==="hazard-burn")}sameCoord(e,t){return!!e&&!!t&&e.x===t.x&&e.y===t.y}drawRoundedRect(e,t,s,i,n,r){const o=Math.min(r,i/2,n/2);e.beginPath(),e.moveTo(t+o,s),e.lineTo(t+i-o,s),e.quadraticCurveTo(t+i,s,t+i,s+o),e.lineTo(t+i,s+n-o),e.quadraticCurveTo(t+i,s+n,t+i-o,s+n),e.lineTo(t+o,s+n),e.quadraticCurveTo(t,s+n,t,s+n-o),e.lineTo(t,s+o),e.quadraticCurveTo(t,s,t+o,s),e.closePath()}key(e){return`${e.x},${e.y}`}fromKey(e){const[t,s]=e.split(","),i=Number(t??0),n=Number(s??0);return{x:i,y:n}}}const Bs=0,Ps=60;function W(a,e,t){const s=R.createDefault(a,{width:e,height:t});for(let i=0;i<t;i++)for(let n=0;n<e;n++)s.setTile("terrain",{x:n,y:i},{tileId:Bs});return s}function L(a,e,t){a.setTileBehavior(e,t)}function se(a,e){e.forEach(t=>{a.setTileBehavior(t,{type:"blocker"}),a.setTile("terrain",t,{tileId:Ps})})}function B(a,e,t){e.forEach(s=>a.setTileBehavior(s,t))}function zs(){const a=W("Test Map 1: Slow Path",8,6);return L(a,{x:1,y:5},{type:"spawn"}),L(a,{x:6,y:0},{type:"exit"}),se(a,[{x:0,y:3},{x:1,y:3},{x:2,y:3},{x:5,y:3},{x:5,y:1},{x:5,y:0}]),B(a,[{x:1,y:4},{x:2,y:4},{x:3,y:4},{x:4,y:3},{x:4,y:2},{x:5,y:2},{x:6,y:2},{x:6,y:1}],{type:"slow"}),a}function Ms(){const a=W("Test Map 2: Hole Maze",10,8);return L(a,{x:1,y:7},{type:"spawn"}),L(a,{x:8,y:1},{type:"exit"}),se(a,[{x:0,y:4},{x:1,y:4},{x:2,y:4},{x:3,y:4},{x:6,y:4},{x:7,y:4},{x:8,y:4},{x:9,y:4},{x:4,y:0},{x:4,y:1},{x:4,y:2},{x:4,y:3}]),B(a,[{x:2,y:6},{x:3,y:6},{x:4,y:6},{x:6,y:6},{x:6,y:5},{x:6,y:3},{x:7,y:2},{x:5,y:1}],{type:"hole"}),a}function Rs(){const a=W("Test Map 3: Conveyor Loop",8,8);return L(a,{x:1,y:6},{type:"spawn"}),L(a,{x:6,y:1},{type:"exit"}),se(a,[{x:3,y:3},{x:3,y:4},{x:4,y:3},{x:4,y:4},{x:2,y:1},{x:5,y:6}]),B(a,[{x:1,y:5},{x:2,y:5},{x:3,y:5}],{type:"conveyor",direction:"east"}),B(a,[{x:4,y:5},{x:5,y:5}],{type:"conveyor",direction:"north"}),B(a,[{x:5,y:4},{x:5,y:3},{x:5,y:2}],{type:"conveyor",direction:"west"}),B(a,[{x:4,y:2},{x:3,y:2}],{type:"conveyor",direction:"north"}),B(a,[{x:3,y:1},{x:4,y:1}],{type:"conveyor",direction:"east"}),a}function Ds(){const a=W("Test Map 4: Hazard Run",7,10);L(a,{x:3,y:9},{type:"spawn"}),L(a,{x:3,y:0},{type:"exit"}),L(a,{x:3,y:8},{type:"door",doorId:"A",open:!1}),se(a,[{x:1,y:5},{x:2,y:5},{x:4,y:5},{x:5,y:5}]);const e=[];for(let t=1;t<=7;t++)e.push({x:3,y:t});return B(a,e,{type:"hazard-burn",damage:1}),B(a,[{x:2,y:7},{x:4,y:7}],{type:"hole"}),a}const ct=[{id:"slow-path",name:"Test Map 1",description:"Simple path with slow tiles.",phase:1,build:zs},{id:"hole-maze",name:"Test Map 2",description:"Maze featuring holes and blockers.",phase:1,build:Ms},{id:"conveyor-puzzle",name:"Test Map 3",description:"Conveyor loop that pushes the token around.",phase:1,build:Rs},{id:"hazard-run",name:"Test Map 4",description:"Hazard gauntlet with a blocking door.",phase:1,build:Ds}];function Ns(){const a=W("Test Map 5: Straight Shot",10,3);return L(a,{x:1,y:1},{type:"spawn"}),L(a,{x:8,y:1},{type:"exit"}),a}function Os(){const a=W("Test Map 6: Obstacle Maze",10,8);return L(a,{x:1,y:6},{type:"spawn"}),L(a,{x:8,y:1},{type:"exit"}),se(a,[{x:3,y:1},{x:3,y:2},{x:3,y:3},{x:3,y:4},{x:5,y:3},{x:6,y:3},{x:7,y:3},{x:7,y:4},{x:2,y:6},{x:4,y:6},{x:6,y:6},{x:7,y:6}]),B(a,[{x:5,y:5},{x:5,y:4},{x:5,y:2}],{type:"slow"}),a}function As(){const a=W("Test Map 7: Hazard Shortcut",9,7);return L(a,{x:1,y:5},{type:"spawn"}),L(a,{x:7,y:1},{type:"exit"}),se(a,[{x:3,y:2},{x:3,y:3},{x:3,y:4},{x:5,y:1},{x:5,y:2},{x:5,y:3},{x:5,y:4},{x:5,y:5}]),B(a,[{x:2,y:5},{x:3,y:5},{x:4,y:5}],{type:"slow"}),B(a,[{x:4,y:2},{x:4,y:1},{x:6,y:1},{x:6,y:2}],{type:"hazard-burn",damage:1}),a}const ut=[{id:"straight-shot",name:"Test Map 5",description:"Straight line to the exit (basic pathfinding).",phase:2,build:Ns},{id:"obstacle-maze",name:"Test Map 6",description:"Maze that forces rerouting around blockers.",phase:2,build:Os},{id:"hazard-shortcut",name:"Test Map 7",description:"Choose between safe detour or hazardous shortcut.",phase:2,build:As}];[...ct,...ut];class Hs{constructor(e,t,s){l(this,"container");l(this,"tester");l(this,"editor");l(this,"fileInput");l(this,"modeButtons",new Map);l(this,"kindButtons",new Map);l(this,"scenarioButtons",new Map);l(this,"selectionLabel");l(this,"kindLabel");l(this,"pathLabel");l(this,"hpLabel");l(this,"stateLabel");l(this,"nextMoveLabel");l(this,"stepLabel");l(this,"statusLabel");l(this,"stepToggleBtn");l(this,"advanceBtn");l(this,"resetBtn");l(this,"playPauseBtn");l(this,"speedButtons",new Map);l(this,"directionSelect");l(this,"doorIdInput");l(this,"doorToggleBtn");l(this,"hazardDamageInput");l(this,"propertyRows",{direction:document.createElement("div"),doorId:document.createElement("div"),doorState:document.createElement("div"),hazard:document.createElement("div")});l(this,"selectedCoord",null);l(this,"selectionBehavior",{type:"floor"});l(this,"playerState",null);l(this,"hasPath",!1);const i=document.getElementById(e);if(!i)throw new Error(`Container not found: ${e}`);this.container=i,this.tester=t,this.editor=s,this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".json,application/json",this.fileInput.style.display="none",this.selectionLabel=document.createElement("div"),this.kindLabel=document.createElement("div"),this.pathLabel=document.createElement("div"),this.hpLabel=document.createElement("div"),this.stateLabel=document.createElement("div"),this.nextMoveLabel=document.createElement("div"),this.stepLabel=document.createElement("div"),this.statusLabel=document.createElement("div"),this.playPauseBtn=document.createElement("button"),this.stepToggleBtn=document.createElement("button"),this.advanceBtn=document.createElement("button"),this.resetBtn=document.createElement("button"),this.directionSelect=document.createElement("select"),this.doorIdInput=document.createElement("input"),this.doorToggleBtn=document.createElement("button"),this.hazardDamageInput=document.createElement("input"),this.render(),this.setupListeners()}render(){this.container.innerHTML="",this.container.appendChild(this.fileInput),this.container.appendChild(this.renderLoadSection()),this.container.appendChild(this.renderScenarioSection("Phase 1 Test Maps",ct)),this.container.appendChild(this.renderScenarioSection("Phase 2 Test Maps",ut)),this.container.appendChild(this.renderMovementSection()),this.container.appendChild(this.renderModeSection()),this.container.appendChild(this.renderKindSection()),this.container.appendChild(this.renderPropertiesSection()),this.container.appendChild(this.renderLegendSection()),this.container.appendChild(this.renderStatusSection())}renderLoadSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Map Input";const s=document.createElement("button");s.className="tool-btn full-width",s.type="button",s.textContent="Load Map JSON",s.addEventListener("click",()=>this.fileInput.click());const i=document.createElement("button");return i.className="tool-btn full-width",i.type="button",i.textContent="Use Current Editor Map",i.addEventListener("click",()=>{this.tester.useLevelClone(this.editor.level)}),e.appendChild(t),e.appendChild(s),e.appendChild(i),e}renderScenarioSection(e,t){const s=document.createElement("div");s.className="control-group";const i=document.createElement("div");i.className="control-label",i.textContent=e;const n=document.createElement("div");return n.className="button-group",t.forEach(r=>{const o=document.createElement("button");o.type="button",o.className="tool-btn small",o.textContent=r.name,o.title=r.description,o.addEventListener("click",()=>{const d=r.build();this.tester.setLevel(d)}),this.scenarioButtons.set(r.id,o),n.appendChild(o)}),s.appendChild(i),s.appendChild(n),s}renderMovementSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Simulation";const s=document.createElement("div");s.className="button-group",this.playPauseBtn.type="button",this.playPauseBtn.className="tool-btn small",this.playPauseBtn.textContent="Play",this.playPauseBtn.addEventListener("click",()=>{var o;const r=((o=this.playerState)==null?void 0:o.paused)??!0;this.tester.setPaused(!r)});const i=document.createElement("div");i.className="button-group",this.addSpeedButton(i,1),this.addSpeedButton(i,2),this.addSpeedButton(i,4);const n=document.createElement("div");return n.className="button-group",this.stepToggleBtn.type="button",this.stepToggleBtn.className="tool-btn small",this.stepToggleBtn.textContent="Step-by-step: Off",this.stepToggleBtn.addEventListener("click",()=>{var o;const r=!(((o=this.playerState)==null?void 0:o.stepMode)??!1);this.tester.setStepMode(r),this.updateStepToggle(r)}),this.advanceBtn.type="button",this.advanceBtn.className="tool-btn small",this.advanceBtn.textContent="Advance Turn",this.advanceBtn.addEventListener("click",()=>this.tester.advanceTurn()),this.resetBtn.type="button",this.resetBtn.className="tool-btn small",this.resetBtn.textContent="Reset to Spawn",this.resetBtn.addEventListener("click",()=>this.tester.resetPlayer()),s.appendChild(this.playPauseBtn),n.appendChild(this.stepToggleBtn),n.appendChild(this.advanceBtn),n.appendChild(this.resetBtn),e.appendChild(t),e.appendChild(s),e.appendChild(i),e.appendChild(n),e}addSpeedButton(e,t){const s=document.createElement("button");s.type="button",s.className="tool-btn small",s.textContent=`${t}x`,s.addEventListener("click",()=>{this.tester.setSpeed(t),this.updateSpeedButtons(t)}),this.speedButtons.set(t,s),e.appendChild(s)}renderModeSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Canvas Click Action";const s=document.createElement("div");return s.className="button-group",this.addModeButton(s,"move","Move Token"),this.addModeButton(s,"edit","Select Tile"),e.appendChild(t),e.appendChild(s),e}addModeButton(e,t,s){const i=document.createElement("button");i.type="button",i.className="tool-btn small",i.dataset.mode=t,i.textContent=s,i.addEventListener("click",()=>{this.tester.setClickMode(t),this.updateModeButtons(t)}),this.modeButtons.set(t,i),e.appendChild(i)}renderKindSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Tile Kind";const s=document.createElement("div");return s.className="button-group",this.addKindButton(s,"floor","Floor"),this.addKindButton(s,"blocker","Blocker"),this.addKindButton(s,"slow","Slow"),this.addKindButton(s,"hole","Hole"),this.addKindButton(s,"conveyor","Conveyor"),this.addKindButton(s,"hazard-burn","Hazard (Burn)"),this.addKindButton(s,"door","Door"),this.addKindButton(s,"exit","Exit"),this.addKindButton(s,"spawn","Spawn"),e.appendChild(t),e.appendChild(s),e}addKindButton(e,t,s){const i=document.createElement("button");i.type="button",i.className="tool-btn small",i.dataset.kind=t,i.textContent=s,i.addEventListener("click",()=>{this.tester.setSelectedKind(t),this.updateKindButtons(t)}),this.kindButtons.set(t,i),e.appendChild(i)}renderPropertiesSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Tile Properties",this.propertyRows.direction.className="control-row";const s=document.createElement("span");s.className="control-meta",s.textContent="Conveyor Direction",["north","east","south","west"].forEach(o=>{const d=document.createElement("option");d.value=o,d.textContent=o,this.directionSelect.appendChild(d)}),this.directionSelect.addEventListener("change",()=>{const o=this.directionSelect.value;this.tester.setDefaultConveyorDirection(o),this.selectionBehavior.type==="conveyor"&&this.tester.updateSelectedBehavior({direction:o})}),this.propertyRows.direction.appendChild(s),this.propertyRows.direction.appendChild(this.directionSelect),this.propertyRows.doorId.className="control-row";const i=document.createElement("span");i.className="control-meta",i.textContent="Door Link ID",this.doorIdInput.type="text",this.doorIdInput.placeholder="e.g., A1",this.doorIdInput.addEventListener("input",()=>{this.selectionBehavior.type==="door"&&this.tester.updateSelectedBehavior({doorId:this.doorIdInput.value})}),this.propertyRows.doorId.appendChild(i),this.propertyRows.doorId.appendChild(this.doorIdInput),this.propertyRows.doorState.className="control-row";const n=document.createElement("span");n.className="control-meta",n.textContent="Door State",this.doorToggleBtn.type="button",this.doorToggleBtn.className="tool-btn small",this.doorToggleBtn.textContent="Toggle Door",this.doorToggleBtn.addEventListener("click",()=>{this.selectedCoord&&this.tester.toggleDoorState(this.selectedCoord)}),this.propertyRows.doorState.appendChild(n),this.propertyRows.doorState.appendChild(this.doorToggleBtn),this.propertyRows.hazard.className="control-row";const r=document.createElement("span");return r.className="control-meta",r.textContent="Hazard Damage",this.hazardDamageInput.type="number",this.hazardDamageInput.min="1",this.hazardDamageInput.value="1",this.hazardDamageInput.addEventListener("change",()=>{const o=parseInt(this.hazardDamageInput.value,10);this.tester.setDefaultHazardDamage(o),this.selectionBehavior.type==="hazard-burn"&&this.tester.updateSelectedBehavior({damage:o||1})}),this.propertyRows.hazard.appendChild(r),this.propertyRows.hazard.appendChild(this.hazardDamageInput),e.appendChild(t),e.appendChild(this.propertyRows.direction),e.appendChild(this.propertyRows.doorId),e.appendChild(this.propertyRows.doorState),e.appendChild(this.propertyRows.hazard),this.updatePropertyVisibility(this.selectionBehavior),e}renderLegendSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Legend";const s=document.createElement("div");return s.className="legend-grid",s.appendChild(this.createLegendRow("Floor","#4a9eff")),s.appendChild(this.createLegendRow("Blocker","#ff4a4a")),s.appendChild(this.createLegendRow("Slow","#ffc75e")),s.appendChild(this.createLegendRow("Hole","#303040")),s.appendChild(this.createLegendRow("Conveyor","#87c4ff")),s.appendChild(this.createLegendRow("Hazard (Burn)","#ff8451")),s.appendChild(this.createLegendRow("Door","#9c84ff")),s.appendChild(this.createLegendRow("Exit","#4affc6")),s.appendChild(this.createLegendRow("Spawn","#8aff4a")),e.appendChild(t),e.appendChild(s),e}createLegendRow(e,t){const s=document.createElement("div");s.className="kind-row";const i=document.createElement("span");i.className="kind-indicator",i.style.backgroundColor=t;const n=document.createElement("span");return n.textContent=e,s.appendChild(i),s.appendChild(n),s}renderStatusSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");return t.className="control-label",t.textContent="Status",this.selectionLabel.className="control-meta",this.kindLabel.className="control-meta",this.pathLabel.className="control-meta",this.hpLabel.className="control-meta",this.stateLabel.className="control-meta",this.nextMoveLabel.className="control-meta",this.stepLabel.className="control-meta",this.statusLabel.className="control-meta",e.appendChild(t),e.appendChild(this.selectionLabel),e.appendChild(this.kindLabel),e.appendChild(this.pathLabel),e.appendChild(this.hpLabel),e.appendChild(this.stateLabel),e.appendChild(this.nextMoveLabel),e.appendChild(this.stepLabel),e.appendChild(this.statusLabel),this.updateSelectionStatus(null,{type:"floor"}),this.updatePathStatus(!1,[]),this.updatePlayerStatus({hp:3,maxHp:3,alive:!0,reachedExit:!1,state:"normal",paused:!0,speed:1,nextStep:null,pathHasHazard:!1,stepMode:!1,destination:null,spawn:null}),e}setupListeners(){this.fileInput.addEventListener("change",async()=>{var t;const e=(t=this.fileInput.files)==null?void 0:t[0];if(e)try{await this.tester.loadLevelFromFile(e)}finally{this.fileInput.value=""}}),this.tester.on("selection:changed",({coord:e,behavior:t})=>{this.selectedCoord=e,this.selectionBehavior=t,this.updateSelectionStatus(e,t),this.updateKindButtons(t.type),this.syncProperties(t)}),this.tester.on("mode:changed",({mode:e})=>{this.updateModeButtons(e)}),this.tester.on("level:changed",()=>{this.updateSelectionStatus(null,{type:"floor"}),this.updatePathStatus(!1,[])}),this.tester.on("path:updated",({hasPath:e,path:t})=>{this.hasPath=e,this.updatePathStatus(e,t)}),this.tester.on("player:updated",e=>{this.playerState=e,this.updatePlayerStatus(e),this.updateStepToggle(e.stepMode),this.updatePlayPause(e.paused),this.updateSpeedButtons(e.speed),this.refreshButtonStates()}),this.updateModeButtons("move"),this.updateKindButtons("floor"),this.updatePlayPause(!0),this.updateSpeedButtons(1),this.refreshButtonStates()}updateSelectionStatus(e,t){e?this.selectionLabel.textContent=`Tile: ${e.x}, ${e.y}`:this.selectionLabel.textContent="Tile: --",this.kindLabel.textContent=`Kind: ${t.type}`}updateModeButtons(e){this.modeButtons.forEach((t,s)=>{const i=s===e;t.classList.toggle("active",i),t.setAttribute("aria-pressed",String(i))})}updateKindButtons(e){this.kindButtons.forEach((t,s)=>{const i=s===e;t.classList.toggle("active",i),t.setAttribute("aria-pressed",String(i))})}updatePathStatus(e,t){var i;const s=(i=this.playerState)!=null&&i.pathHasHazard?" (hazard ahead)":"";e&&t.length>1?this.pathLabel.textContent=`Path: ${t.length-1} steps${s}`:this.pathLabel.textContent="Path: none",this.refreshButtonStates()}updatePlayerStatus(e){this.hpLabel.textContent=`HP: ${e.hp}/${e.maxHp}`;const t=e.spawn?`Spawn: ${e.spawn.x}, ${e.spawn.y}`:"Spawn: --",s=e.destination?`Destination: ${e.destination.x}, ${e.destination.y}`:"Destination: --";this.stepLabel.textContent=`${t}  ${s}`;const i=e.nextStep?`${e.nextStep.x}, ${e.nextStep.y}`:"--";if(this.stateLabel.textContent=`State: ${e.state}`,this.nextMoveLabel.textContent=`Next Move: ${i}`,!e.alive)this.statusLabel.textContent="Status: Down (reset to respawn)";else if(e.reachedExit)this.statusLabel.textContent="Status: Exit reached";else{const n=e.stepMode?"Step-by-step":"Auto movement";this.statusLabel.textContent=e.paused?"Status: Paused":`Status: ${n}`}}updateStepToggle(e){this.stepToggleBtn.textContent=e?"Step-by-step: On":"Step-by-step: Off",this.stepToggleBtn.classList.toggle("active",e)}updatePlayPause(e){this.playPauseBtn.textContent=e?"Play":"Pause",this.playPauseBtn.classList.toggle("active",!e)}updateSpeedButtons(e){this.speedButtons.forEach((t,s)=>{const i=s===e;t.classList.toggle("active",i),t.setAttribute("aria-pressed",String(i))})}syncProperties(e){e.type==="conveyor"&&e.direction&&(this.directionSelect.value=e.direction),e.type==="door"&&(this.doorIdInput.value=e.doorId??"",this.doorToggleBtn.textContent=e.open?"Close Door":"Open Door"),e.type==="hazard-burn"&&e.damage&&(this.hazardDamageInput.value=String(e.damage)),this.updatePropertyVisibility(e)}updatePropertyVisibility(e){this.propertyRows.direction.style.display=e.type==="conveyor"?"flex":"none",this.propertyRows.doorId.style.display=e.type==="door"?"flex":"none",this.propertyRows.doorState.style.display=e.type==="door"?"flex":"none",this.propertyRows.hazard.style.display=e.type==="hazard-burn"?"flex":"none"}refreshButtonStates(){var t,s,i;const e=((t=this.playerState)==null?void 0:t.alive)??!0;this.advanceBtn.disabled=!e||!this.hasPath||!(((s=this.playerState)==null?void 0:s.paused)??!0)||!(((i=this.playerState)==null?void 0:i.stepMode)??!1),this.resetBtn.disabled=!1}}const Je={floor:"rgba(74, 158, 255, 0.08)",blocker:"rgba(255, 74, 74, 0.45)",slow:"rgba(255, 199, 94, 0.35)",hole:"rgba(20, 20, 20, 0.6)",conveyor:"rgba(74, 158, 255, 0.22)","hazard-burn":"rgba(255, 132, 74, 0.38)",door:"rgba(156, 132, 255, 0.4)",exit:"rgba(74, 255, 198, 0.35)",spawn:"rgba(138, 255, 74, 0.32)"},$s={curious:"#4aff9e",coward:"#ffd75e",hyperactive:"#ff8fba"};class Qe{constructor(e=1234){l(this,"seed");this.seed=e>>>0}next(){return this.seed=(1664525*this.seed+1013904223)%4294967296,this.seed/4294967296}}class Zs{constructor(e){l(this,"canvas");l(this,"camera");l(this,"renderer");l(this,"tileRegistry");l(this,"level");l(this,"listeners",new Map);l(this,"animationFrame",null);l(this,"lastTimestamp",0);l(this,"isRunning",!1);l(this,"isPaused",!0);l(this,"speedMultiplier",1);l(this,"stepMode",!1);l(this,"pendingStep",!1);l(this,"baseStepDuration",.25);l(this,"defaultHazardDamage",1);l(this,"defaultConveyorDirection","east");l(this,"hazardPenalty",2.5);l(this,"exitTile",null);l(this,"clops",[]);l(this,"rng",new Qe(42));this.tileRegistry=e.tileRegistry,this.canvas=new Ee({canvas:e.canvas,container:e.container}),this.camera=new Le({zoom:2}),this.renderer=new Ie(this.canvas,this.camera,this.tileRegistry),this.renderer.setOptions({showHover:!1,showSelection:!1}),this.level=R.createDefault("Clop Personality Test"),this.setupEventListeners(),this.resetClops(),this.start()}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;return(s=this.listeners.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.listeners.get(e))==null||s.forEach(i=>{i(t)})}getLevel(){return this.level}getClopSnapshots(){return this.clops.map(e=>this.toSnapshot(e))}setPaused(e){this.isPaused!==e&&(this.isPaused=e)}setStepMode(e){this.stepMode=e,this.pendingStep=!e}advanceTurn(){this.stepMode&&(this.pendingStep=!0)}setSpeed(e){[1,2,4].includes(e)&&(this.speedMultiplier=e)}setSeed(e){Number.isFinite(e)&&(this.rng=new Qe(Math.max(1,Math.floor(e))))}setLevel(e){this.level=e,this.exitTile=this.findExitTile(),this.resetClops(),this.emit("level:changed",{level:e})}async loadLevelFromFile(e){const t=await Pe(e);this.setLevel(t)}useLevelClone(e){const t=de(e),s=he(t);this.setLevel(s)}resetClops(){const e=this.collectSpawnPoints(),t=["curious","coward","hyperactive"];if(!e.length){const s=this.findFirstWalkable()??{x:0,y:0};e.push(s)}this.pendingStep=!this.stepMode,this.clops=e.map((s,i)=>{const n=t[i%t.length]??"curious";return this.createClop(i+1,n,s)}),this.emitClops()}setClopPersonality(e){const t=this.clops.find(s=>s.id===e.id);t&&(t.personality=e.personality,t.destination=null,t.path=[t.position],t.visited.clear(),t.finished=!1,t.stuck=!1,t.blocked=!1,this.emitClops())}setDefaultConveyorDirection(e){this.defaultConveyorDirection=e}setDefaultHazardDamage(e){Number.isFinite(e)&&(this.defaultHazardDamage=Math.max(1,Math.round(e)))}start(){this.isRunning||(this.isRunning=!0,this.lastTimestamp=performance.now(),this.loop(this.lastTimestamp))}stop(){this.isRunning=!1,this.animationFrame!==null&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)}createClop(e,t,s){return{id:e,personality:t,position:s,spawn:s,destination:null,path:[s],segmentIndex:0,segmentProgress:0,currentStepDuration:this.baseStepDuration,moving:!1,isAnimating:!1,finished:!1,stuck:!1,pathHasHazard:!1,blocked:!1,visited:new Set([this.key(s)])}}setupEventListeners(){const e=this.canvas.element;e.addEventListener("wheel",t=>{t.preventDefault();const s=-t.deltaY*.001,i=e.getBoundingClientRect();this.camera.zoomBy(s,t.clientX-i.left,t.clientY-i.top)},{passive:!1})}loop(e){if(!this.isRunning)return;const t=e-this.lastTimestamp;this.lastTimestamp=e,this.update(t/1e3),this.render(),this.animationFrame=requestAnimationFrame(s=>this.loop(s))}update(e){if(this.isPaused)return;const t=e*this.speedMultiplier;for(const s of this.clops){if(s.finished||s.stuck)continue;if(!this.exitTile){s.stuck=!0;continue}if(s.destination||this.planDestination(s),(s.path.length<=1||s.blocked)&&this.rebuildPath(s),this.shouldStartNextSegment(s)&&this.beginSegment(s),!s.isAnimating||s.path.length<2)continue;const i=s.segmentIndex,n=i+1,r=s.path[i],o=s.path[n];if(!r||!o){s.stuck=!0;continue}if(s.segmentProgress+=t/s.currentStepDuration,s.segmentProgress>=1)s.position={x:o.x,y:o.y},s.segmentIndex=n,s.segmentProgress=0,s.isAnimating=!1,s.visited.add(this.key(o)),n>=s.path.length-1?s.moving=!1:(s.pathHasHazard=this.pathContainsHazard(s.path,n+1),this.stepMode&&(this.pendingStep=!1)),this.handleTileArrival(s,o);else{const d=s.segmentProgress;s.position={x:r.x+(o.x-r.x)*d,y:r.y+(o.y-r.y)*d}}}this.emitClops()}shouldStartNextSegment(e){return!(!e.moving||e.isAnimating||e.segmentIndex>=e.path.length-1||this.stepMode&&!this.pendingStep)}beginSegment(e){const t=e.path[e.segmentIndex+1];t&&(e.currentStepDuration=this.getStepDuration(t,e),e.isAnimating=!0,this.stepMode&&(this.pendingStep=!1))}handleTileArrival(e,t){const s=this.getTileBehavior(t);if(s.type==="spawn"&&(e.spawn=t),s.type==="hole"){e.stuck=!0,e.moving=!1,e.destination=null,e.pathHasHazard=!1;return}if(s.type==="hazard-burn"&&e.personality==="coward"&&(e.blocked=!0),s.type==="exit"&&this.exitTile&&this.sameCoord(t,this.exitTile)){e.finished=!0,e.moving=!1,e.destination=t,e.pathHasHazard=!1;return}if(s.type==="conveyor"){const i=this.getConveyorTarget(t,s.direction??this.defaultConveyorDirection);if(i){this.forceMoveTo(e,i);return}}if(e.personality==="hyperactive"&&this.rng.next()<.2){const i=this.pickRandomNeighbor(t);if(i){e.destination=i,this.rebuildPath(e);return}}if(e.destination&&!this.sameCoord(t,e.destination)){this.rebuildPath(e);return}e.destination&&this.sameCoord(t,e.destination)&&this.planDestination(e)}planDestination(e){if(e.personality==="curious"){const t=this.findNearestUnseen(e);if(t){e.destination=t,this.rebuildPath(e);return}}e.destination=this.exitTile,this.rebuildPath(e)}rebuildPath(e){if(!e.destination)return;const t=this.roundCoord(e.position),s=this.findPath(t,e.destination,e);if(!s||s.length===0){e.moving=!1,e.path=[t],e.stuck=!0,e.blocked=!0;return}e.path=s,e.segmentIndex=0,e.segmentProgress=0,e.currentStepDuration=this.getStepDuration(s[1]??e.destination,e),e.moving=s.length>1,e.isAnimating=!1,e.pathHasHazard=this.pathContainsHazard(s,1),e.blocked=!1}findPath(e,t,s){const i=this.key(e),n=this.key(t),r=[i],o=new Map,d=new Map([[i,0]]),h=new Map([[i,this.heuristic(e,t)]]);for(o.set(i,null);r.length>0;){r.sort((w,T)=>(h.get(w)??1/0)-(h.get(T)??1/0));const p=r.shift();if(p===n)return this.reconstructPath(o,p);const b=this.fromKey(p);for(const w of this.getNeighbors(b)){const T=this.key(w);if(this.isBlocked(w)||this.isHole(w)||this.isOccupied(w,s.id))continue;const N=this.getTraversalCost(w,s);if(!Number.isFinite(N))continue;const ge=(d.get(p)??1/0)+N;ge<(d.get(T)??1/0)&&(o.set(T,p),d.set(T,ge),h.set(T,ge+this.heuristic(w,t)),r.includes(T)||r.push(T))}}return null}heuristic(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}getTraversalCost(e,t){const s=this.getTileBehavior(e).type;return s==="slow"?2.5:s==="hazard-burn"?t.personality==="coward"?100:this.hazardPenalty:1}getStepDuration(e,t){const i=this.getTileBehavior(e).type==="slow"?this.baseStepDuration*2.5:this.baseStepDuration;return t.personality==="hyperactive"?i*.6:i}reconstructPath(e,t){const s=[this.fromKey(t)];let i=e.get(t);for(;i;)s.push(this.fromKey(i)),i=e.get(i);return s.reverse()}getNeighbors(e){return[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].filter(s=>this.level.isInBounds(s))}isBlocked(e){const t=this.getTileBehavior(e);return t.type==="blocker"||t.type==="door"&&!t.open}isHole(e){return this.getTileBehavior(e).type==="hole"}isOccupied(e,t){return this.clops.some(s=>s.id!==t&&!s.stuck&&!s.finished&&this.sameCoord(this.roundCoord(s.position),e))}getConveyorTarget(e,t){const s=t==="north"?{x:e.x,y:e.y-1}:t==="south"?{x:e.x,y:e.y+1}:t==="west"?{x:e.x-1,y:e.y}:{x:e.x+1,y:e.y};return!this.level.isInBounds(s)||this.isBlocked(s)||this.isOccupied(s,-1)?null:s}forceMoveTo(e,t){e.path=[this.roundCoord(e.position),t],e.segmentIndex=0,e.segmentProgress=0,e.currentStepDuration=this.getStepDuration(t,e),e.moving=!0,e.isAnimating=!1,e.pathHasHazard=this.pathContainsHazard(e.path,1),e.blocked=!1}findNearestUnseen(e){const t=[this.roundCoord(e.position)],s=new Set([this.key(this.roundCoord(e.position))]);for(;t.length>0;){const i=t.shift(),n=this.key(i);if(!e.visited.has(n)&&!this.isBlocked(i)&&!this.isHole(i))return i;for(const r of this.getNeighbors(i)){const o=this.key(r);s.has(o)||this.isBlocked(r)||this.isHole(r)||(s.add(o),t.push(r))}}return null}collectSpawnPoints(){const e=[];return this.level.forEachTileBehavior(t=>{t.type==="spawn"&&e.push(t.position)}),e}findFirstWalkable(){for(let e=0;e<this.level.gridHeight;e++)for(let t=0;t<this.level.gridWidth;t++){const s={x:t,y:e},i=this.getTileBehavior(s);if(!this.isBlocked(s)&&i.type!=="hole")return s}return null}findExitTile(){let e=null;return this.level.forEachTileBehavior(t=>{t.type==="exit"&&!e&&(e=t.position)}),e}pathContainsHazard(e,t=0){return e.slice(t).some(s=>this.getTileBehavior(s).type==="hazard-burn")}pickRandomNeighbor(e){const t=this.getNeighbors(e).filter(i=>!this.isBlocked(i)&&!this.isHole(i));if(!t.length)return null;const s=Math.floor(this.rng.next()*t.length);return t[s]??null}getTileBehavior(e){const t=this.level.getTileBehavior(e);return t?t.type==="conveyor"?{type:"conveyor",direction:t.direction??this.defaultConveyorDirection}:t.type==="door"?{type:"door",doorId:t.doorId,open:t.open??!1}:t.type==="hazard-burn"?{type:"hazard-burn",damage:t.damage??this.defaultHazardDamage}:t:{type:"floor"}}render(){this.renderer.render(this.level);const e=this.canvas.ctx;e.save(),this.camera.applyTransform(e);const t=ae(this.canvas.viewport.width/this.camera.zoom,this.canvas.viewport.height/this.camera.zoom,this.level.gridWidth,this.level.gridHeight);this.renderKindOverlays(e,t.x,t.y),this.renderClops(e,t.x,t.y),e.restore()}renderKindOverlays(e,t,s){e.save(),e.font="10px sans-serif",e.textAlign="center",e.textBaseline="middle",e.strokeStyle="rgba(0,0,0,0.6)";for(let i=0;i<this.level.gridHeight;i++)for(let n=0;n<this.level.gridWidth;n++){const r={x:n,y:i},o=this.getTileBehavior(r),d=this.getOverlayColor(o);this.drawDiamond(e,r,t,s,d),this.drawTileIcon(e,r,o,t,s)}e.restore()}renderClops(e,t,s){for(const i of this.clops){const n=E(i.position.x,i.position.y,t,s),r=$s[i.personality];e.fillStyle=i.finished?"rgba(74, 255, 158, 0.9)":r,e.beginPath(),e.arc(n.x,n.y+_/2,k/4,0,Math.PI*2),e.fill(),e.fillStyle="rgba(15,15,20,0.8)",e.strokeStyle="rgba(0,0,0,0.6)",e.lineWidth=2,this.drawRoundedRect(e,n.x-16,n.y-14,32,14,6),e.fill(),e.stroke(),e.fillStyle="#fff",e.font="9px sans-serif",e.textAlign="center",e.textBaseline="middle";const o=`${i.id}: ${i.personality}`;e.fillText(o,n.x,n.y-7)}}drawDiamond(e,t,s,i,n){const r=E(t.x,t.y,s,i);e.fillStyle=n,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(r.x+k/2,r.y+_/2),e.lineTo(r.x,r.y+_),e.lineTo(r.x-k/2,r.y+_/2),e.closePath(),e.fill()}drawTileIcon(e,t,s,i,n){const r=E(t.x,t.y,i,n),o=r.x,d=r.y+_/2;switch(s.type){case"hole":e.fillStyle="rgba(0,0,0,0.6)",e.beginPath(),e.ellipse(o,d+2,k/5,_/3,0,0,Math.PI*2),e.fill();break;case"conveyor":this.drawArrow(e,o,d,s.direction??this.defaultConveyorDirection);break;case"hazard-burn":this.drawFlame(e,o,d);break;case"door":this.drawDoor(e,o,d,s.open??!1);break;case"exit":this.drawStar(e,o,d,"#4affc6");break;case"spawn":this.drawStar(e,o,d,"#8aff4a",4);break}}drawArrow(e,t,s,i){e.save(),e.strokeStyle="#d2e8ff",e.fillStyle="#d2e8ff",e.lineWidth=2,e.beginPath();const n=8,r=i==="east"?1:i==="west"?-1:0,o=i==="south"?1:i==="north"?-1:0;e.moveTo(t-r*n*.4,s-o*n*.4),e.lineTo(t+r*n*.8,s+o*n*.8),e.stroke(),e.beginPath(),e.moveTo(t+r*n,s+o*n),e.lineTo(t+r*n-o*4+r*2,s+o*n+r*4+o*2),e.lineTo(t+r*n+o*4+r*2,s+o*n-r*4+o*2),e.closePath(),e.fill(),e.restore()}drawFlame(e,t,s){e.save(),e.fillStyle="#ffb347",e.beginPath(),e.moveTo(t,s-6),e.quadraticCurveTo(t+6,s-2,t,s+6),e.quadraticCurveTo(t-6,s-2,t,s-6),e.fill(),e.fillStyle="#ff6b3d",e.beginPath(),e.moveTo(t,s-4),e.quadraticCurveTo(t+3,s,t,s+4),e.quadraticCurveTo(t-3,s,t,s-4),e.fill(),e.restore()}drawDoor(e,t,s,i){e.save(),e.fillStyle=i?"rgba(200,255,200,0.9)":"rgba(120,90,180,0.9)",e.strokeStyle="rgba(0,0,0,0.45)",e.lineWidth=2,this.drawRoundedRect(e,t-8,s-6,16,12,3),e.fill(),e.stroke(),i||(e.beginPath(),e.moveTo(t-4,s),e.lineTo(t+4,s),e.stroke()),e.restore()}drawStar(e,t,s,i,n=5){e.save(),e.fillStyle=i;const r=7,o=3,d=Math.PI/n;e.beginPath();for(let h=0;h<2*n;h++){const p=h%2===0?r:o,b=h*d-Math.PI/2;e.lineTo(t+Math.cos(b)*p,s+Math.sin(b)*p)}e.closePath(),e.fill(),e.restore()}getOverlayColor(e){return e.type==="door"&&e.open?"rgba(138, 255, 200, 0.3)":Je[e.type]??Je.floor}drawRoundedRect(e,t,s,i,n,r){const o=Math.min(r,i/2,n/2);e.beginPath(),e.moveTo(t+o,s),e.lineTo(t+i-o,s),e.quadraticCurveTo(t+i,s,t+i,s+o),e.lineTo(t+i,s+n-o),e.quadraticCurveTo(t+i,s+n,t+i-o,s+n),e.lineTo(t+o,s+n),e.quadraticCurveTo(t,s+n,t,s+n-o),e.lineTo(t,s+o),e.quadraticCurveTo(t,s,t+o,s),e.closePath()}emitClops(){this.emit("clops:updated",{clops:this.getClopSnapshots()})}toSnapshot(e){return{id:e.id,personality:e.personality,position:this.roundCoord(e.position),spawn:e.spawn,target:e.destination,status:e.finished?"finished":e.stuck?"stuck":"active",pathLength:Math.max(0,e.path.length-1),pathHasHazard:e.pathHasHazard,blocked:e.blocked}}roundCoord(e){return{x:Math.round(e.x),y:Math.round(e.y)}}sameCoord(e,t){return!!e&&!!t&&e.x===t.x&&e.y===t.y}key(e){return`${e.x},${e.y}`}fromKey(e){const[t,s]=e.split(","),i=Number(t??0),n=Number(s??0);return{x:i,y:n}}}class js{constructor(e,t,s){l(this,"container");l(this,"tester");l(this,"editor");l(this,"fileInput");l(this,"playPauseBtn");l(this,"stepToggleBtn");l(this,"advanceBtn");l(this,"resetBtn");l(this,"speedButtons",new Map);l(this,"seedInput");l(this,"rosterContainer");l(this,"statusLabel");l(this,"hazardInput");l(this,"directionSelect");l(this,"clopSnapshots",[]);l(this,"isPaused",!0);l(this,"stepMode",!1);const i=document.getElementById(e);if(!i)throw new Error(`Container not found: ${e}`);this.container=i,this.tester=t,this.editor=s,this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".json,application/json",this.fileInput.style.display="none",this.playPauseBtn=document.createElement("button"),this.stepToggleBtn=document.createElement("button"),this.advanceBtn=document.createElement("button"),this.resetBtn=document.createElement("button"),this.seedInput=document.createElement("input"),this.rosterContainer=document.createElement("div"),this.statusLabel=document.createElement("div"),this.hazardInput=document.createElement("input"),this.directionSelect=document.createElement("select"),this.render(),this.setupListeners()}render(){this.container.innerHTML="",this.container.appendChild(this.fileInput),this.container.appendChild(this.renderLoadSection()),this.container.appendChild(this.renderSimulationSection()),this.container.appendChild(this.renderPersonalitySection()),this.container.appendChild(this.renderEnvironmentSection()),this.container.appendChild(this.renderStatusSection())}renderLoadSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Map Input";const s=document.createElement("button");s.className="tool-btn full-width",s.type="button",s.textContent="Load Map JSON",s.addEventListener("click",()=>this.fileInput.click());const i=document.createElement("button");return i.className="tool-btn full-width",i.type="button",i.textContent="Use Current Editor Map",i.addEventListener("click",()=>{this.tester.useLevelClone(this.editor.level)}),e.appendChild(t),e.appendChild(s),e.appendChild(i),e}renderSimulationSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Simulation";const s=document.createElement("div");s.className="button-group",this.playPauseBtn.type="button",this.playPauseBtn.className="tool-btn small",this.playPauseBtn.textContent="Play",this.playPauseBtn.addEventListener("click",()=>{this.tester.setPaused(!this.isPaused),this.isPaused=!this.isPaused,this.updatePlayPause()}),this.stepToggleBtn.type="button",this.stepToggleBtn.className="tool-btn small",this.stepToggleBtn.textContent="Step-by-step: Off",this.stepToggleBtn.addEventListener("click",()=>{this.stepMode=!this.stepMode,this.tester.setStepMode(this.stepMode),this.updateStepToggle()}),this.advanceBtn.type="button",this.advanceBtn.className="tool-btn small",this.advanceBtn.textContent="Advance Step",this.advanceBtn.addEventListener("click",()=>this.tester.advanceTurn()),this.resetBtn.type="button",this.resetBtn.className="tool-btn small",this.resetBtn.textContent="Reset Clops",this.resetBtn.addEventListener("click",()=>this.tester.resetClops()),s.appendChild(this.playPauseBtn),s.appendChild(this.stepToggleBtn),s.appendChild(this.advanceBtn),s.appendChild(this.resetBtn);const i=document.createElement("div");i.className="button-group",this.addSpeedButton(i,1),this.addSpeedButton(i,2),this.addSpeedButton(i,4);const n=document.createElement("div");n.className="control-row";const r=document.createElement("span");return r.className="control-meta",r.textContent="Deterministic Seed",this.seedInput.type="number",this.seedInput.min="1",this.seedInput.value="42",this.seedInput.addEventListener("change",()=>{const o=parseInt(this.seedInput.value,10);Number.isFinite(o)&&this.tester.setSeed(o)}),n.appendChild(r),n.appendChild(this.seedInput),e.appendChild(t),e.appendChild(s),e.appendChild(i),e.appendChild(n),e}addSpeedButton(e,t){const s=document.createElement("button");s.type="button",s.className="tool-btn small",s.textContent=`${t}x`,s.addEventListener("click",()=>{this.tester.setSpeed(t),this.updateSpeedButtons(t)}),this.speedButtons.set(t,s),e.appendChild(s)}renderPersonalitySection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");return t.className="control-label",t.textContent="Clop Personalities",this.rosterContainer.className="control-group",this.rosterContainer.style.gap="6px",e.appendChild(t),e.appendChild(this.rosterContainer),this.renderRoster(),e}renderEnvironmentSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");t.className="control-label",t.textContent="Environment Defaults";const s=document.createElement("div");s.className="control-row";const i=document.createElement("span");i.className="control-meta",i.textContent="Hazard Damage",this.hazardInput.type="number",this.hazardInput.min="1",this.hazardInput.value="1",this.hazardInput.addEventListener("change",()=>{const o=parseInt(this.hazardInput.value,10);this.tester.setDefaultHazardDamage(o)}),s.appendChild(i),s.appendChild(this.hazardInput);const n=document.createElement("div");n.className="control-row";const r=document.createElement("span");return r.className="control-meta",r.textContent="Conveyor Direction",["north","east","south","west"].forEach(o=>{const d=document.createElement("option");d.value=o,d.textContent=o,this.directionSelect.appendChild(d)}),this.directionSelect.value="east",this.directionSelect.addEventListener("change",()=>{this.tester.setDefaultConveyorDirection(this.directionSelect.value)}),n.appendChild(r),n.appendChild(this.directionSelect),e.appendChild(t),e.appendChild(s),e.appendChild(n),e}renderStatusSection(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("div");return t.className="control-label",t.textContent="Status",this.statusLabel.className="control-meta",this.statusLabel.textContent="Paused",e.appendChild(t),e.appendChild(this.statusLabel),e}setupListeners(){this.fileInput.addEventListener("change",async()=>{var t;const e=(t=this.fileInput.files)==null?void 0:t[0];if(e)try{await this.tester.loadLevelFromFile(e)}finally{this.fileInput.value=""}}),this.tester.on("clops:updated",({clops:e})=>{this.clopSnapshots=e,this.renderRoster(),this.refreshStatus()}),this.tester.on("level:changed",()=>{this.clopSnapshots=this.tester.getClopSnapshots(),this.renderRoster()}),this.updateSpeedButtons(1),this.updatePlayPause(),this.updateStepToggle()}renderRoster(){if(this.rosterContainer.innerHTML="",!this.clopSnapshots.length){const e=document.createElement("div");e.className="control-meta",e.textContent="No clops spawned (add Spawn tiles)",this.rosterContainer.appendChild(e);return}this.clopSnapshots.forEach(e=>{const t=document.createElement("div");t.className="control-row",t.style.justifyContent="space-between";const s=document.createElement("div");s.className="control-meta",s.textContent=`#${e.id} (${e.personality})`;const i=document.createElement("div");i.className="control-meta",i.textContent=`${e.status}  ${e.position.x},${e.position.y}`,e.blocked&&(i.textContent+="  blocked"),e.pathHasHazard&&(i.textContent+="  hazard ahead");const n=document.createElement("select");["curious","coward","hyperactive"].forEach(r=>{const o=document.createElement("option");o.value=r,o.textContent=r,e.personality===r&&(o.selected=!0),n.appendChild(o)}),n.addEventListener("change",()=>{const r={id:e.id,personality:n.value};this.tester.setClopPersonality(r)}),t.appendChild(s),t.appendChild(i),t.appendChild(n),this.rosterContainer.appendChild(t)})}updatePlayPause(){this.playPauseBtn.textContent=this.isPaused?"Play":"Pause",this.playPauseBtn.classList.toggle("active",!this.isPaused)}updateStepToggle(){this.stepToggleBtn.textContent=this.stepMode?"Step-by-step: On":"Step-by-step: Off",this.stepToggleBtn.classList.toggle("active",this.stepMode)}updateSpeedButtons(e){this.speedButtons.forEach((t,s)=>{const i=s===e;t.classList.toggle("active",i),t.setAttribute("aria-pressed",String(i))})}refreshStatus(){const e=this.clopSnapshots.filter(s=>s.status==="finished").length,t=this.clopSnapshots.filter(s=>s.status==="stuck").length;this.statusLabel.textContent=`Active: ${this.clopSnapshots.length-e-t}  Finished: ${e}  Stuck: ${t}`}}async function et(){console.log("Initializing Isometric Level Editor...");const a=document.createElement("div");a.id="loading",a.style.cssText=`
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    color: #4a9eff;
    z-index: 1000;
  `,a.textContent="Loading assets...",document.body.appendChild(a);try{const e=new xt;await e.initialize(),console.log(`Loaded ${e.getTileCount()} tiles`);const t=new ys({canvas:"#editor-canvas",container:"#canvas-stack"},e),s=t.loadFromStorage();console.log(s?"Loaded level from localStorage":"Created new default level");const i=new Cs("toolbar",t),n=new ws("view-controls",t),r=new Ss("map-controls",t),o=new vs("layer-list",t),d=new gs("tile-palette",t,e),h=new xs(t),p=new Is({canvas:"#movement-canvas",container:"#canvas-stack",tileRegistry:e}),b=new Hs("movement-controls",p,t),w=new Zs({canvas:"#clop-canvas",container:"#canvas-stack",tileRegistry:e}),T=new js("clop-controls",w,t);d.selectTile(0),t.start(),p.start(),w.start(),Fs(),window.editor=t,a.remove(),console.log("Editor initialized successfully!"),console.log("Controls:"),console.log("  - Click to place tiles"),console.log("  - B: Brush tool"),console.log("  - E: Eraser tool"),console.log("  - Ctrl+Z: Undo"),console.log("  - Ctrl+Y/Ctrl+Shift+Z: Redo"),console.log("  - Ctrl+S: Save to localStorage"),console.log("  - Mouse wheel: Zoom")}catch(e){console.error("Failed to initialize editor:",e),a.textContent=`Error: ${e instanceof Error?e.message:"Unknown error"}`,a.style.color="#ff4a4a"}}function Fs(){const a=document.getElementById("canvas-mode-toggle"),e=document.getElementById("sidebar-active-title"),t=document.getElementById("editor-canvas"),s=document.getElementById("movement-canvas"),i=document.getElementById("clop-canvas"),n=document.getElementById("editor-pane"),r=document.getElementById("movement-pane"),o=document.getElementById("clop-pane");if(!a||!t||!s||!i||!n||!r||!o)return;const d=h=>{const p=h==="editor",b=h==="movement",w=h==="clop";t.classList.toggle("inactive",!p),s.classList.toggle("inactive",!b),i.classList.toggle("inactive",!w),n.classList.toggle("active",p),r.classList.toggle("active",b),o.classList.toggle("active",w),a.querySelectorAll("button[data-canvas]").forEach(T=>{const N=T.dataset.canvas;T.classList.toggle("active",N===h)}),e&&(e.textContent=p?"Map Editor":b?"Movement Tester":"Clop Personalities")};a.addEventListener("click",h=>{const b=h.target.closest("button[data-canvas]");if(!b)return;const w=b.dataset.canvas==="movement"?"movement":b.dataset.canvas==="clop"?"clop":"editor";d(w)}),d("editor")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",et):et();
